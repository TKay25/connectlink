<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ConnectLink Admin System</title>
        <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/reqlogo.jpg') }}">
        <meta name="mobile-web-app-capable" content="yes">
        <!-- <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/eds blue.png') }}"> -->
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
        <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
        <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
        <style>

:root {
    --primary: #1E2A56;
    --primary-light: #2d3a75;
    --primary-dark: #141e40;
    --accent: #FF6B35;
    --accent-light: #FF8B5C;
    --white: #ffffff;
    --gray-light: #f8fafc;
    --gray: #94a3b8;
    --gray-dark: #475569;
    --shadow: 0 20px 40px rgba(30, 42, 86, 0.15);
    --shadow-hover: 0 30px 60px rgba(30, 42, 86, 0.25);
    --gradient: linear-gradient(135deg, #1E2A56 0%, #3d4b8c 100%);
    --gradient-accent: linear-gradient(135deg, #FF6B35 0%, #FF8B5C 100%);
    --bg-gradient: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
}
        /* Main Styling */
body {
    font-family: 'Roboto', sans-serif;
    /* Diagonal line background - same as login page */
    background: linear-gradient(
        to top right,
        #f8fafc 0%,
        #e2e8f0 50%,
        #1E2A56 50%,
        #1E2A56 100%
    );
    margin: 0;
    min-height: 100vh;
    display: flex;
    overflow-x: hidden;
    position: relative;
}

/* White diagonal dividing line */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        to top right,
        transparent calc(50% - 2px),
        #ffffff calc(50% - 2px),
        #ffffff calc(50% + 2px),
        transparent calc(50% + 2px)
    );
    box-shadow: 
        0 0 10px rgba(255, 255, 255, 0.8),
        0 0 20px rgba(255, 255, 255, 0.4);
    z-index: -1;
    pointer-events: none;
}
        /* Sidebar Styling */
.sidebar {
    width: 250px;
    background-color: #1E2A56; /* SOLID COLOR - better performance */
    color: #fff;
    padding-top: 40px;
    position: fixed;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    box-shadow: 4px 0 10px rgba(0, 0, 0, 0.2);
    transition: width 0.3s;
    /* REMOVE: background: linear-gradient(135deg, #1E2A56 0%, #3d4b8c 100%); */
}

        #editinfocompModal {
            z-index: 1061 !important;
        }

        .modal-backdrop.show:nth-of-type(2) {
            z-index: 1060 !important;
        }

        .sidebar:hover {
            width: 270px;
        }

        .sidebar h5 {
            font-weight: bold;
            margin-bottom: 30px;
            font-size: 1.2rem;
        }

        .sidebar img {
            max-width: 150px;
            margin-bottom: 20px;
        }

        .sidebar .btn {
            color: #1E2A56;
            background-color: #fff;
            width: 150px;
            margin: 5px 0;
            padding: 8x;
            border: 3px solid #1E2A56;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: background 0.3s;
            text-align: center;
            font-weight: 600;
        }

        .sidebar .btn:hover {
            background-color: #1E2A56;
            color: #fff;
            border: 3px solid white;
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-danger-2{
            color: white;
            background-color: red;
            width: max-content;
            margin: 2px 2px;
            padding: 1px;
            border-radius: 24px;
            border: 3px solid red;
            font-size: 0.7rem;
            transition: background 0.3s;
            text-align: center;
            font-weight: 500;

        }
        .btn-danger-2:hover{
            background-color: white;
            color: red;
            border: 3px solid red;
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
        }

.table-refresh-loader {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(2px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.table-refresh-loader .spinner-border {
    width: 3rem;
    height: 3rem;
}

.btn-primary, .btn-primary2, .btn-primary3, .btn-primary9 {
    color: white;
    background: linear-gradient(135deg, #1E2A56 0%, #3d4b8c 100%); /* Same gradient as login */
    border: none;
    border-radius: 24px; /* Match login button radius */
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 13px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 20px rgba(30, 42, 86, 0.2); /* Same as login */
}

.btn-primary:hover, .btn-primary2:hover, .btn-primary3:hover, .btn-primary9:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 30px rgba(30, 42, 86, 0.3); /* Same as login hover */
    background: linear-gradient(135deg, #141e40 0%, #2d3a75 100%);
    color: white;
}
        .form-control-blue {
            background-color: #1E2A5611; /* Example */
            border: 1px solid #ccc;
            appearance: auto; /* Ensure native dropdown appearance */
            padding: 8px 12px;
        }



        /* Main Content Styling */
.main-content {
    margin-left: 270px;
    padding: 30px;
    width: calc(100% - 270px);
    background-color: rgba(255, 255, 255, 0.95); /* Slightly transparent white */
    min-height: 100vh;
    /* REMOVE backdrop-filter to improve performance */
}


        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px;
            background-color: #e9f1fb;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 10px;
        }

        .current-date {
            color: #1E2A56;
            font-weight: bold;
            font-size: smaller;
            font-size: 14px;
        }

        .employeetag {
            color: #1E2A56;;
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;

        }

        /* Tab Styling */
.nav-tabs .nav-link {
    color: #1E2A56;
    font-weight: 600;
    padding: 10px 20px;
    font-size: 0.9rem;
    border-radius: 8px 8px 0 0;
    background: #f8fafc; /* Simple background */
    transition: background-color 0.2s ease; /* Simpler transition */
}

.nav-tabs .nav-link.active {
    color: white;
    background-color: #1E2A56; /* SOLID COLOR */
    font-weight: 700;
}

        /* Card Styling */
.card {
    border-radius: 12px;
    box-shadow: 0 20px 40px rgba(30, 42, 86, 0.15); /* Same shadow as login */
    padding: 10px;
    margin-top: 20px;
    background-color: #ffffff;
    animation: fadeIn 0.5s ease;
    border: 1px solid rgba(255, 255, 255, 0.2); /* Match login border */
}

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

.modal-content {
    border-radius: 24px; /* Match login container */
    box-shadow: 0 20px 40px rgba(30, 42, 86, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: #ffffff;
}
.modal-header {
    background: linear-gradient(135deg, #1E2A56 0%, #3d4b8c 100%);
    color: white;
    font-weight: 700;
    border-radius: 24px 24px 0 0;
    padding: 20px 30px;
}
        .form-group {
            margin-bottom: 20px; /* Increase vertical spacing between fields */
            }

        .btn-center {
            display: flex;
            justify-content: center;
            justify-content: space-between; 
            gap: 10px;
            }

        .form-control-blue::after {
            content: '\25BC'; /* Unicode for downwards triangle */
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white; /* Arrow color */
            font-size: 18px;
        }

        /* Style for disabled option (making it grey) */
        .form-control-blue option:disabled {
            background-color: #A9A9A9; /* Grey background */
            color: #D3D3D3; /* Grey text color */
        }

.table-theme {
    width: 100%;
    border-collapse: collapse;
    border-spacing: 0;
    border-radius: 24px;
    table-layout: auto;
    box-shadow: 0 4px 12px rgba(30, 42, 86, 0.1);
}

.table-theme th {
    background: linear-gradient(135deg, #1E2A56 0%, #3d4b8c 100%);
    color: white;
    text-align: center;
    vertical-align: middle;
    padding: 15px;
    font-weight: 700;
    border: none;
}

.table-theme td {
    font-weight: 500;
    padding: 0px;
    color: #1E2A56;
    text-align: center;
    background: white;
    border-bottom: 1px solid rgba(30, 42, 86, 0.1);
}

        #employeesTable th,
        #employeespayrollTable th, 
        #employeespersonalTable th,
        #employeesaccumulatorsTable th, 
        #employeesbulk1Table th, 
        #employeesbulkbalancesTable th, 
        #removeemployeesTable th {
            position: sticky;
            top: 0;
            z-index: 1;
        }


        .container2 {
            font-size: 13px;
            margin-top: -2rem;
        }

        .form-group label{
            font-weight: bold;
        }
        /* For WebKit-based browsers (Chrome, Edge, Safari) */
        select.form-control-blue option:hover {
            background-color: #e6f0ff; /* Light blue on hover */
            color: #1E2A56; /* Dark blue text */
        }
        /* Style the close button */
/* Add this to your CSS - targets ALL modal close buttons */
.modal-header .btn-close {
    opacity: 1;
    transition: opacity 0.2s;
    background-size: 60%;
    background-color: white;
    border-radius:24px;
    /* REMOVE: filter: invert(1) brightness(2); */
}

        .modal-footer{
            gap: 10px;
        }

        /* Default background color for editable fields */
        .editable-field {
            border-radius: 8px;
            background-color: #e6f0ff; /* Light blue when not being edited */
            border: rgba(0, 0, 0, 0.2) solid #4655AC; /* Light border */
            transition: background-color 0.3s ease;
        }

        /* Background color when the field is focused (being edited) */
        .editable-field:focus {
            background-color: #1E2A56; /* Change to light yellow when being edited */
            color: white; /* Dark blue border when focused */
            outline: none; /* Remove the default outline */
        }

        /* Style the checkboxes */
        .custom-checkbox {
            width: 25px; /* Make the checkbox bigger */
            height: 25px; /* Make the checkbox bigger */
            background-color: #e6f0ff; /* Dark blue background */
            border-radius: 8px; /* Optional: round the corners */
            border: 3px solid #1E2A56; /* Dark blue border */
            appearance: none; /* Remove default checkbox style */
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .custom-checkbox:checked {
            background-color: #1E2A56; /* Dark blue when checked */
            border-color: #1E2A56; /* Dark blue border when checked */
        }

        .custom-checkbox:checked::after {
            content: '\2713'; /* Checkmark symbol */
            position: absolute;
            top: 0;
            left: 4px; /* Adjust position of the checkmark */
            color: white; /* White color for the checkmark */
            font-size: 15px; /* Make the checkmark larger */
        }

        #removeemployeesTable input[type="checkbox"] {
            margin-right: 10px;
        }

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(30, 42, 86, 0.95); /* Same as login loading */
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    color: white;
    font-size: 18px;
    z-index: 9999;
    backdrop-filter: blur(5px);
}


.loading-spinner {
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-top: 5px solid white;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
}

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        .uppercase-text {
        text-transform: uppercase;
        }

        .form-select {
            padding: 5px 10px;
            font-size: 0.9rem;
            border-radius: 10px;
            border: 3px solid  #1E2A56;
            font-weight: 800;
            outline: none;
            color:#1E2A56;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);

        }
        /* Black overlay */
        .dropdown-overlay {
            position: fixed;  /* Covers the entire screen */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7); /* Black with 70% opacity */
            z-index: 10; /* Ensure it appears above everything */
            display: none; /* Initially hidden */
        }

        .dropdown-overlayxx {
            position: fixed;  /* Covers the entire screen */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7); /* Black with 70% opacity */
        }


.dropdown-menu {
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(30, 42, 86, 0.15);
    border: 1px solid rgba(30, 42, 86, 0.1);
    padding: 8px 0;
}

.dropdown-menu .dropdown-item {
    color: #1E2A56;
    font-weight: 500;
    padding: 10px 20px;
    transition: all 0.2s ease;
}

.dropdown-menu .dropdown-item:hover {
    background: linear-gradient(135deg, #1E2A56 0%, #3d4b8c 100%);
    color: white;
}
        .otherleave{
            display: none;
        }



        .modal-body{
            color: #1E2A56;
        }
        #chartContainer {
            margin-top: 20px;
            width: 230px;  /* Reduce chart size */
        }
        .dropdownfilter {
            position: relative;
            display: inline-block;
        }
        .dropdownfilter-toggle {
            background-color: #1E2A56;
            color: white;
            padding: 2px 12px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-weight: 500;
        }
        .dropdownfilter-content {
            display: none;
            position: absolute;
            background-color: white;
            box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
            z-index: 1;
            padding: 3px;
            border-radius: 5px;
        }
        .dropdownfilter-content label {
            display: block;
            margin-bottom: 5px;
            cursor: pointer;
            color: #1E2A56;
        }
        .dropdownfilter:hover .dropdownfilter-content {
            display: block;
        }

        /* Main loader layout */
        .eds-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);

            display: flex;
            flex-direction: column;
            justify-content: center;   /* vertical center */
            align-items: center;       /* horizontal center */
            gap: 25px;                 /* clean spacing */

            z-index: 9999;
            font-family: 'Century Gothic', sans-serif;
            text-align: center;
            padding: 20px;
        }

        /* Logo section */
        .eds-logo {
            color: white;
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #1E2A56;
        }

        /* Tagline text */
        .eds-tagline {
            color: #fff;
            font-size: 0.8rem;   /* increased for readability */
            opacity: 0.8;
            margin: 0;
        }

        /* Loader bar */
        .loader-bar {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
            margin-top: 5px;
        }

        .loader-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, white, #1E2A56);
            animation: load 3s ease-in-out infinite;
            border-radius: 2px;
        }

        @keyframes load {
            0%   { width: 0%; left: 0; }
            50%  { width: 100%; left: 0; }
            100% { width: 0%; left: 100%; }
        }

        /* Pulsing grid */
        .eds-grid {
            display: grid;
            grid-template-columns: repeat(4, 20px);
            gap: 10px;
            margin-top: 10px;
        }

        .grid-item {
            width: 20px;
            height: 20px;
            background: rgba(0, 255, 252, 0.25);
            animation: pulse 1.5s ease-in-out infinite;
            border-radius: 3px; /* optional visual improvement */
        }

        .grid-item:nth-child(1) { animation-delay: 0s; }
        .grid-item:nth-child(2) { animation-delay: 0.2s; }
        .grid-item:nth-child(3) { animation-delay: 0.4s; }
        .grid-item:nth-child(4) { animation-delay: 0.6s; }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.2;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
                background: #336699;
            }
        }




        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 4 columns */
            gap: 20px;
            margin-top: 20px;
        }

        .summary-card {
            flex: 1 1 calc(33.33% - 10px);
            background-color: #f0f4f8;
            padding: 4px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            font-size: 10px;
        }

        .summary-card .icon {
            font-size: 15px;
            margin-right: 10px;
        }

        .summary-card .details h5 {
            margin: 0;
            font-size: 13px;
            color: #1E2A56;
        }

        .summary-card .details p {
            margin: 0;
            font-size: 14px;
            font-weight: bold;
        }

        .dashboard-graphs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .graph-card {
            background-color: #ffffff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-size: 12px;
        }

        .graph-card h6 {
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: bold;
            color: #1E2A56;
        }

        .sidebar .accordion-button {
            background-color: #f8f9fa;
            border-radius: 0 !important;
            box-shadow: none;
            cursor: pointer;
        }

        .sidebar .accordion-button:hover {
            background-color: #e9ecef;
        }

        .sidebar .accordion-item {
            border-radius: 0 !important;
        }

        .sidebar .list-group-item {
            border-radius: 0 !important;
            border-left: none;
            border-right: none;
            font-size: 0.95rem;
        }

        /* Remove default Bootstrap accordion arrow for this item */
        .accordion-item:has(.bi-people-fill) .accordion-button::after, .accordion-item:has(.bi-wallet-fill) .accordion-button::after {
            display: none;
        }

        /* Add this to your existing CSS section */
/* IMPROVED ADD PROJECT MODAL STYLING - FIXED VERSION */

#addnewProjectModal .modal-dialog {
    max-width: 95%;
    margin: 1rem auto;
    display: flex;
    flex-direction: column;
}

#addnewProjectModal .modal-content {
    display: flex;
    flex-direction: column;
    border-radius: 24px;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(30, 42, 86, 0.25);
    border: 1px solid rgba(30, 42, 86, 0.1);
}

#addnewProjectModal .modal-header {
    background: linear-gradient(135deg, #1E2A56 0%, #3d4b8c 100%);
    color: white;
    padding: 15px 25px;
    border-bottom: 3px solid rgba(255, 255, 255, 0.15);
    position: relative;
}

#addnewProjectModal .modal-title {
    font-weight: 800;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
}


#addnewProjectModal .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px 25px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

#addnewProjectModal form {
    display: flex;
    flex-direction: column;
}

/* Card Layout Improvements - REMOVED equal height */
#addnewProjectModal .row.g-3 {
    row-gap: 12px;
}

#addnewProjectModal .card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(30, 42, 86, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    background: white;
    /* REMOVED: height: 100%; */
    /* REMOVED: display: flex; */
    /* REMOVED: flex-direction: column; */
}

#addnewProjectModal .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(30, 42, 86, 0.15);
}

/* Card Header Styling */
#addnewProjectModal .card h6 {
    background: linear-gradient(135deg, #1E2A56 0%, #3d4b8c 100%);
    color: white;
    font-weight: 700;
    text-align: center;
    padding: 10px 12px;
    margin: 0;
    border-radius: 12px 12px 0 0;
    font-size: 0.95rem;
    letter-spacing: 0.5px;
    position: relative;
}

#addnewProjectModal .card h6::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 3px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 2px;
}

/* Card Body Improvements - SIMPLIFIED */
#addnewProjectModal .card > div:not(h6) {
    padding: 15px;
}

/* Form Group Improvements */
#addnewProjectModal .form-group.row {
    margin-bottom: 10px;
    align-items: center;
}

#addnewProjectModal .form-group.row:last-child {
    margin-bottom: 0;
}

#addnewProjectModal .col-auto.col-form-label {
    min-width: 120px;
    padding-right: 10px;
    font-weight: 600;
    color: #1E2A56;
    font-size: 0.85rem;
    white-space: nowrap;
}

#addnewProjectModal .col {
    flex: 1;
}

/* Input Field Improvements */
#addnewProjectModal .form-control,
#addnewProjectModal .form-control-blue,
#addnewProjectModal textarea.form-control,
#addnewProjectModal input[type="date"],
#addnewProjectModal input[type="number"],
#addnewProjectModal input[type="text"],
#addnewProjectModal input[type="email"] {
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 0.9rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: white;
    color: #1E2A56;
    width: 100%;
}

#addnewProjectModal .form-control:focus,
#addnewProjectModal .form-control-blue:focus,
#addnewProjectModal textarea.form-control:focus,
#addnewProjectModal input[type="date"]:focus,
#addnewProjectModal input[type="number"]:focus,
#addnewProjectModal input[type="text"]:focus,
#addnewProjectModal input[type="email"]:focus {
    border-color: #1E2A56;
    box-shadow: 0 0 0 4px rgba(30, 42, 86, 0.15);
    outline: none;
    background: white;
}

/* Textarea specific */
#addnewProjectModal textarea.form-control {
    min-height: 70px;
    resize: vertical;
    line-height: 1.5;
}

/* Select Dropdown Improvements */
#addnewProjectModal select.form-control-blue {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%231E2A56' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 12px;
    padding-right: 40px;
    cursor: pointer;
}

/* Quill Editor Improvements */
#addnewProjectModal #projectScopeToolbar {
    border: 2px solid #e2e8f0;
    border-radius: 10px 10px 0 0;
    border-bottom: none;
    padding: 8px;
    background: #f8fafc;
}

#addnewProjectModal #projectScopeEditor {
    border: 2px solid #e2e8f0;
    border-radius: 0 0 10px 10px;
    min-height: 110px;
    background: white;
    font-size: 0.9rem;
}

#addnewProjectModal .ql-toolbar.ql-snow {
    border: none !important;
    padding: 0 !important;
}

#addnewProjectModal .ql-container.ql-snow {
    border: none !important;
    border-radius: 0 0 8px 8px;
}

/* Payment Method Section Improvements */
#addnewProjectModal #paymentschedule {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 2px dashed #e2e8f0;
}

#addnewProjectModal #bullet_payment_date {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 2px dashed #e2e8f0;
}

/* Read-only Contractor Fields */
#addnewProjectModal input[readonly] {
    background-color: #f8fafc;
    border-color: #d1d5db;
    color: #6b7280;
    cursor: not-allowed;
}

/* Required Field Indicators */
#addnewProjectModal .form-group.row.required .col-auto.col-form-label::after {
    content: " *";
    color: #dc2626;
    font-weight: bold;
}

/* Responsive Improvements */
@media (max-width: 1200px) {
    #addnewProjectModal .modal-dialog {
        max-width: 98%;
    }
    
    #addnewProjectModal .col-auto.col-form-label {
        min-width: 100px;
        font-size: 0.8rem;
    }
}

@media (max-width: 992px) {
    #addnewProjectModal .modal-dialog {
        max-width: 100%;
        margin: 0.5rem;
    }
    
    #addnewProjectModal .col-auto.col-form-label {
        min-width: auto;
        white-space: normal;
        margin-bottom: 5px;
        padding-right: 0;
    }
    
    #addnewProjectModal .form-group.row {
        flex-direction: column;
        align-items: flex-start;
    }
}

/* Scrollbar Styling */
#addnewProjectModal .modal-body::-webkit-scrollbar {
    width: 8px;
}

#addnewProjectModal .modal-body::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

#addnewProjectModal .modal-body::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #1E2A56 0%, #3d4b8c 100%);
    border-radius: 4px;
}

#addnewProjectModal .modal-body::-webkit-scrollbar-thumb:hover {
    background: #1E2A56;
}

/* Modal Footer Improvements */
#addnewProjectModal .modal-footer {
    padding: 15px 25px;
    background: white;
    border-top: 1px solid rgba(30, 42, 86, 0.1);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

#addnewProjectModal .modal-footer .btn {
    padding: 5px 12px;
    font-weight: 700;
    border-radius: 24px;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    min-width: 140px;
}

#addnewProjectModal .modal-footer .btn-primary {
    background: linear-gradient(135deg, #1E2A56 0%, #3d4b8c 100%);
    border: none;
    color: white;
}

#addnewProjectModal .modal-footer .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(30, 42, 86, 0.2);
}

#addnewProjectModal .modal-footer .btn-danger {
    background: #dc3545;
    border: none;
    color: white;
}

#addnewProjectModal .modal-footer .btn-danger:hover {
    background: #c82333;
    transform: translateY(-2px);
}

/* Manual Installments Section */
#addnewProjectModal #manualInstallments {
    background: #f8fafc;
    border-radius: 10px;
    padding: 12px;
    margin-top: 12px;
    border: 2px solid #e2e8f0;
}

#addnewProjectModal #manualInstallments .form-group.row {
    background: white;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    border: 1px solid #e2e8f0;
}

#addnewProjectModal #manualInstallments .form-group.row:last-child {
    margin-bottom: 0;
}

/* Field Focus Animation */
@keyframes fieldFocus {
    0% {
        box-shadow: 0 0 0 4px rgba(30, 42, 86, 0);
    }
    100% {
        box-shadow: 0 0 0 4px rgba(30, 42, 86, 0.15);
    }
}

#addnewProjectModal .form-control:focus {
    animation: fieldFocus 0.3s ease-out;
}

/* Responsive Typography */
@media (max-width: 768px) {
    #addnewProjectModal .modal-header {
        padding: 12px 18px;
    }
    
    #addnewProjectModal .modal-body {
        padding: 15px 18px;
    }
    
    #addnewProjectModal .modal-footer {
        padding: 12px 18px;
        flex-direction: column;
    }
    
    #addnewProjectModal .modal-footer .btn {
        width: 100%;
        margin-bottom: 8px;
        min-width: auto;
    }
    
    #addnewProjectModal .modal-footer .btn:last-child {
        margin-bottom: 0;
    }
    
    #addnewProjectModal .card h6 {
        font-size: 0.9rem;
        padding: 10px;
    }
}
        .bg-success {
    background: linear-gradient(135deg, #059669 0%, #10b981 100%);
}

.bg-danger {
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
}

.bg-warning {
    background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
}

.bg-primary {
    background: linear-gradient(135deg, #1E2A56 0%, #3d4b8c 100%);
}

/* MINIMAL SCROLLBAR STYLING */

/* Global scrollbar */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: #1E2A56;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #141e40;
}

/* Firefox */
* {
    scrollbar-width: thin;
    scrollbar-color: #1E2A56 #f1f5f9;
}

/* Specific for containers */
.container2::-webkit-scrollbar,
.modal-body::-webkit-scrollbar {
    width: 6px;
}

.container2::-webkit-scrollbar-thumb,
.modal-body::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #1E2A56 0%, #3d4b8c 100%);
}

/* Payment Reminders Modal Specific Styling */
#paymentRemindersModal .modal-dialog {
    max-width: 1200px;
}

#paymentRemindersModal .modal-header {
    background: linear-gradient(135deg, #1E2A56 0%, #3d4b8c 100%);
    color: white;
    border-radius: 24px 24px 0 0;
    padding: 15px 25px;
}

#paymentRemindersModal .modal-title {
    font-weight: 800;
    font-size: 1.2rem;
}

#paymentRemindersModal .modal-body {
    padding: 20px;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
}

#paymentRemindersModal .summary-card {
    background: white;
    border-radius: 12px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    border: 1px solid rgba(30, 42, 86, 0.1);
    box-shadow: 0 4px 12px rgba(30, 42, 86, 0.05);
}

#paymentRemindersModal .summary-card .icon {
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: rgba(30, 42, 86, 0.1);
}

#paymentRemindersModal .summary-card .details h5 {
    margin: 0;
    font-size: 0.8rem;
    color: #475569;
    font-weight: 600;
}

#paymentRemindersModal .summary-card .details p {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 800;
    color: #1E2A56;
}

/* Table Styling */
#paymentRemindersModal .table-theme {
    width: 100%;
    border-collapse: collapse;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(30, 42, 86, 0.05);
}

#paymentRemindersModal .table-theme th {
    background: linear-gradient(135deg, #1E2A56 0%, #3d4b8c 100%);
    color: white;
    font-weight: 700;
    padding: 12px 15px;
    text-align: center;
    white-space: nowrap;
}

#paymentRemindersModal .table-theme td {
    padding: 10px 15px;
    text-align: center;
    vertical-align: middle;
    border-bottom: 1px solid rgba(30, 42, 86, 0.1);
}

#paymentRemindersModal .table-theme tr:hover {
    background-color: rgba(30, 42, 86, 0.02);
}

/* Badge Styling */
#paymentRemindersModal .badge {
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
}

#paymentRemindersModal .bg-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
    color: white;
}

#paymentRemindersModal .bg-danger {
    background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
    color: white;
}

#paymentRemindersModal .bg-info {
    background: linear-gradient(135deg, #06b6d4 0%, #22d3ee 100%);
    color: white;
}

/* WhatsApp Button */
#paymentRemindersModal .send-whatsapp-btn {
    padding: 5px 12px;
    font-size: 0.85rem;
    font-weight: 600;
    border-radius: 20px;
    background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
    border: none;
    color: white;
    transition: all 0.3s ease;
}

#paymentRemindersModal .send-whatsapp-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(37, 211, 102, 0.2);
}

/* Scrollable container */
#paymentRemindersModal div[style*="max-height: 400px"] {
    border: 1px solid rgba(30, 42, 86, 0.1);
    border-radius: 12px;
    background: white;
}

/* Empty state styling */
#paymentRemindersModal .text-center {
    color: #64748b;
}

#paymentRemindersModal .text-center i {
    opacity: 0.5;
}

/* Modal Footer */
#paymentRemindersModal .modal-footer {
    border-top: 1px solid rgba(30, 42, 86, 0.1);
    padding: 15px 25px;
}

#paymentRemindersModal #sendAllRemindersBtn {
    background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
    border: none;
    padding: 8px 20px;
    font-weight: 600;
    border-radius: 24px;
    min-width: 180px;
}

#paymentRemindersModal #sendAllRemindersBtn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(37, 211, 102, 0.3);
}

#paymentRemindersModal #sendAllRemindersBtn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Responsive adjustments */
@media (max-width: 992px) {
    #paymentRemindersModal .modal-dialog {
        margin: 10px;
    }
    
    #paymentRemindersModal .dashboard-summary {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    #paymentRemindersModal .dashboard-summary {
        grid-template-columns: 1fr;
    }
    
    #paymentRemindersModal .table-theme {
        font-size: 0.85rem;
    }
    
    #paymentRemindersModal .table-theme th,
    #paymentRemindersModal .table-theme td {
        padding: 8px 10px;
    }
}


.user-message {
    background: #e1ffc7;
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 10px;
    border-left: 4px solid #34a853;
    text-align: right;
}

.ai-response {
    background: white;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    border-left: 4px solid #4285f4;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.thinking {
    color: #666;
    font-style: italic;
    display: flex;
    align-items: center;
    gap: 10px;
}

.spinner {
    border: 2px solid #f3f3f3;
    border-top: 2px solid #4285f4;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
    </style>
</head>

<body>
    <div class="eds-loader" id="edsLoader" style="display: none;">
        <div class="eds-logo"><img src="{{ url_for('static', filename='images/web-logo-white.png') }}"  alt="Logo" class="logo" style="width: 200px;"></div> 

        <br><br>
        <p style="font-weight: 700;color: white;font-size: 1.2rem;">The Project is being saved {{user_name}}, Please Wait...</p>

        <div class="loader-bar">
            <div class="loader-progress"></div>
        </div>
        
        <div class="eds-grid">
            <div class="grid-item"></div>
            <div class="grid-item"></div>
            <div class="grid-item"></div>
            <div class="grid-item"></div>
        </div>
    </div>

    <div class="eds-loader" id="edsLoader2" style="display: none;">
        <div class="eds-logo"><img src="{{ url_for('static', filename='images/web-logo-white.png') }}"  alt="Logo" class="logo" style="width: 200px;"></div> 

        <br><br>
        <p style="font-weight: 700;color: white;font-size: 1.2rem;">Your changes are being saved {{user_name}}, Please Wait...</p>

        <div class="loader-bar">
            <div class="loader-progress"></div>
        </div>
        
        <div class="eds-grid">
            <div class="grid-item"></div>
            <div class="grid-item"></div>
            <div class="grid-item"></div>
            <div class="grid-item"></div>
        </div>
    </div>
    
    <div class="sidebar p-2">
        <br><br>
        <div class="eds-logo"><img style="width: 350px;" src="{{ url_for('static', filename='images/web-logo-white.png') }}"  alt="Logo" class="logo" style="width: 200px;"></div> 

        <br>
        <h6 class="mb-3 text-center">ADMINISTRATION SYSTEM</h6>

        <button class="btn w-100 d-flex justify-content-between align-items-center border rounded-2 mb-2 p-2"
                id="addnewprojectBtn" data-bs-toggle="modal" data-bs-target="#addnewProjectModal">
            <span><i class="bi bi-briefcase-fill me-2"></i> Add New Project</span>
        </button>

        <button class="btn w-100 d-flex justify-content-between align-items-center border rounded-2 mb-2 p-2"
                id="createuserBtn" data-bs-toggle="modal" data-bs-target="#systemUserModal">
            <span><i class="bi bi-person-fill-add"></i> Manage System Users</span>
        </button>

        <button class="btn w-100 d-flex justify-content-between align-items-center border rounded-2 mb-2 p-2"
                data-bs-toggle="modal"
                data-bs-target="#addcompAdminModal">
            <span><i class="bi bi-people-fill"></i> Manage Administrators</span>
        </button>

    </div>

    <div class="modal fade" id="systemUserModal" tabindex="-1" aria-labelledby="systemUserModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="max-width:60%;">
            <div class="modal-content">
            
            <div class="modal-header">
                <h6 class="modal-title" id="systemUserModalLabel"><i class="bi bi-person-fill-add"></i> SYSTEM USERS</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" style="font-size: 14px;">
                <div class="container mt-5">
                    <div class="container2" style="max-height: 450px; overflow-y: auto;">
                        {{ usersdatamain_html|safe }}
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">Create User</button>
                <button class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
            </div>

            </div>
        </div>
    </div>



    <div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            
            <div class="modal-header">
                <h6 class="modal-title" id="createUserModalLabel"><i class="bi bi-person-fill-add"></i> CREATE SYSTEM USER</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" style="font-size: 14px;">
                <form id="createUserForm">
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: bold;">Full Name</label>
                        <input type="text" class="form-control editable-field" name="userfullname" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" style="font-weight: bold;">WhatsApp Number</label>
                        <input type="number" class="form-control editable-field" name="userwhatsapp" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" style="font-weight: bold;">Email</label>
                        <input type="email" class="form-control editable-field" name="useremail" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" style="font-weight: bold;">Password</label>
                        <input type="password" class="form-control editable-field" name="userpassword" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" style="font-weight: bold;">Admin Permission Passcode</label>
                        <input type="text" class="form-control editable-field" name="permission_passcode" id="permissionPasscode" required>
                    </div>


                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" type="submit" form="createUserForm">Create</button>
                <button class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
            </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="addcompAdminModal" tabindex="-1" aria-labelledby="addcompAdminModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h6 class="modal-title" id="addcompAdminModalLabel"><i class="bi bi-people-fill"></i>ADMINISTRATORS</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">

                    <div class="container mt-5">
                        <div class="container2" style="max-height: 450px; overflow-y: auto;">
                            {{ table_datamain_admins_html|safe }}
                        </div>
                    </div>

            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button class="btn btn-primary" id="addAdminplusBtn" style="width: max-content;"
                        data-bs-toggle="modal" data-bs-target="#addAdminplusModal">
                    <i class="bi bi-person-plus"></i> Add Administrator
                </button>

                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>

            </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="viewprojectModal" tabindex="-1" aria-labelledby="viewprojectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">

            <div class="modal-header">
                <h6 class="modal-title" id="viewprojectModalLabel"> <i class="bi bi-card-list"></i> PROJECT DETAILS</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <table class="table table-striped table-borderless">
                    <tbody id="projectDetailsBody">
                        <!-- Filled dynamically with JS -->
                    </tbody>
                </table>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>

            </div>
        </div>
        </div>


    <div class="modal fade" id="addAdminplusModal" tabindex="-1" aria-labelledby="addAdminplusModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md modal-dialog-centered">
            <div class="modal-content">

            <div class="modal-header">
                <h6 class="modal-title" id="addAdminplusModalLabel"><i class="bi bi-person-plus-fill"></i>ADD ADMINISTRATOR</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">

                <form id="adminForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Full Name</label>
                        <input type="text" class="form-control" id="adminName" name="adminName" placeholder="Enter Admin full name">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Contact Phone</label>
                        <input type="text" class="form-control" id="adminPhone" name="adminPhone" placeholder="e.g. +263 77 123 4567">
                    </div>
                </form>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-success d-flex align-items-center" id="saveAdminBtn" style="gap:6px;">
                    <span id="saveText"><i class="bi bi-check-circle"></i> Save</span>
                    <div id="saveLoader" class="spinner-border spinner-border-sm text-light d-none" role="status"></div>
                </button>

                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>

            </div>
        </div>
    </div>



    <div class="modal fade" id="addnewProjectModal" tabindex="-1" aria-labelledby="addnewProjectModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="max-width: 85%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title" id="addnewProjectModalLabel"><i class="bi bi-briefcase-fill"></i> NEW PROJECT</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <form id="addProjectForm">

                        <!-- Row for side-by-side cards -->
                        <div class="row g-3">

                            <!-- CLIENT DETAILS CARD -->
                            <div class="col-md-4">
                                <div class="card" style="padding:15px;">

                                    <h6 style="background-color:#1E2A56; font-weight:800;color: white;text-align: center;padding: 1%;">CLIENT DETAILS</h6>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="person_name" class="col-auto col-form-label" style="padding-right: 0.5rem;">Full Name:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="client_name" name="client_name" required>
                                        </div>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="national_id" class="col-auto col-form-label" style="padding-right: 0.5rem;">National ID Number:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="client_national_id" name="client_national_id" required>
                                        </div>
                                    </div>



                                    <div class="form-group row align-items-start" style="margin-bottom: 0.5rem;">
                                        <label for="address" class="col-auto col-form-label" style="padding-right: 0.5rem;">Address:</label>
                                        <div class="col">
                                            <textarea class="form-control editable-field" id="client_address" rows="3" name="client_address" required></textarea>
                                        </div>
                                    </div>


                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="whatsapp_number" class="col-auto col-form-label" style="padding-right: 0.5rem;">Whatsapp Number:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="client_whatsapp_number" name="client_whatsapp_number" required>
                                        </div>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="email_address" class="col-auto col-form-label" style="padding-right: 0.5rem;">Email:</label>
                                        <div class="col">
                                            <input type="email" class="form-control editable-field" id="client_email" name="client_email" required>
                                        </div>
                                    </div>


                                </div>
                            </div>

                            <!-- NEXT OF KIN DETAILS CARD -->
                            <div class="col-md-4">
                                <div class="card" style="padding:15px;">

                                    <h6 style="background-color:#1E2A56; font-weight:800;color: white;text-align: center;padding: 1%;">NEXT OF KIN DETAILS</h6>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="person_name" class="col-auto col-form-label" style="padding-right: 0.5rem;">Full Name:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="next_of_kin_name" name="next_of_kin_name" required>
                                        </div>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="person_address" class="col-auto col-form-label" style="padding-right: 0.5rem;">Address:</label>
                                        <div class="col">
                                            <textarea class="form-control editable-field" id="next_of_kin_address" rows="3" name="next_of_kin_address" required></textarea>
                                        </div>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="contact_number" class="col-auto col-form-label" style="padding-right: 0.5rem;">Contact Number:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="next_of_kin_contact_number" name="next_of_kin_contact_number" required>
                                        </div>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="relationship" class="col-auto col-form-label" style="padding-right: 0.5rem;">Relationship:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="relationship" name="relationship" required>
                                        </div>
                                    </div>


                                </div>

                            </div>



                            <div class="col-md-4">
                                <div class="card" style="padding:15px;">
                                    <!-- CONTRACTOR DETAILS -->
                                    <h6 style="background-color:#1E2A56; font-weight:800;color: white;text-align: center;padding: 1%;">CONTRACTOR DETAILS</h6>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="contractor_name" class="col-auto col-form-label" style="padding-right: 0.5rem;">Name:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="contractor_name" value="ConnectLink Properties" readonly>
                                        </div>
                                    </div>


                                    <div class="form-group">
                                        <label>Address:</label>
                                        <input type="text" class="form-control editable-field" value="38A Coronation Avenue Greendale Harare" readonly>
                                    </div>

                                    <div class="form-group">
                                        <label>Contact Number</label>
                                        <input type="text" class="form-control editable-field" value="+263 773 368 558 ; +263 716 788 838" readonly>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="contractor_email" class="col-auto col-form-label" style="padding-right: 0.5rem;">Email:</label>
                                        <div class="col">
                                            <input type="email" class="form-control editable-field" id="contractor_email" value="info@connectlinkproperties.co.zw" readonly>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label>Administrator:</label>
                                        <select class="form-control-blue editable-field" id="projectadministrator" name="projectadministrator" required>
                                            <option value="" disabled selected>Select Administrator</option>
                                            {% for option in admin_options %}
                                                <option value="{{ option }}">{{ option }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card" style="padding:15px;">
                                    <!-- PROJECT DETAILS -->
                                    <h6 style="background-color:#1E2A56; font-weight:800;color: white;text-align: center;padding: 1%;">PROJECT DETAILS</h6>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="project_name" class="col-auto col-form-label" style="padding-right: 0.5rem;">Project Name:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="project_name" name="project_name" required>
                                        </div>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="project_location" class="col-auto col-form-label" style="padding-right: 0.5rem;">Project Location:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="project_location" name="project_location" required>
                                        </div>
                                    </div>

                                    <div class="form-group mb-3">
                                        <label class="form-label fw-bold">Project Scope: </label>

                                        <!-- Quill toolbar -->
                                        <div id="projectScopeToolbar">
                                            <span class="ql-formats">
                                                <button class="ql-bold"></button>
                                                <button class="ql-italic"></button>
                                                <button class="ql-underline"></button>
                                            </span>
                                            <span class="ql-formats">
                                                <button class="ql-list" value="bullet"></button>
                                                <button class="ql-list" value="ordered"></button>
                                            </span>
                                        </div>

                                        <!-- Quill editable area -->
                                        <div id="projectScopeEditor" class="editable-field" style="height: 130px; background: #fff;"></div>

                                        <!-- Hidden input that will store final HTML for submitting -->
                                        <input type="hidden" id="project_description" name="project_description" required>
                                    </div>


                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="project_start_date" class="col-auto col-form-label" style="padding-right: 0.5rem;">Project Start Date:</label>
                                        <div class="col">
                                            <input type="date" class="form-control editable-field" id="project_start_date" name="project_start_date" required>
                                        </div>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="months_to_completion" class="col-auto col-form-label" style="padding-right: 0.5rem;">Project Duration (Days):</label>
                                        <div class="col">
                                            <input type="number" class="form-control editable-field" id="months_to_completion" name="months_to_completion" required>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card" style="padding:15px;">

                        
                                    <!-- PAYMENT TERMS -->
                                    <h6 style="background-color:#1E2A56; font-weight:800;color: white;text-align: center;padding: 1%;">PAYMENT TERMS</h6>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="agreement_date" class="col-auto col-form-label" style="padding-right: 0.5rem;">Contract Agreement Date:</label>
                                        <div class="col">
                                            <input type="date" class="form-control editable-field" id="agreement_date" name="agreement_date" required>
                                        </div>
                                    </div>


                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label class="col-auto col-form-label" style="padding-right: 0.5rem;">Total Contract Price (USD):</label>
                                        <div class="col">
                                            <input type="number" class="form-control editable-field" id="total_contract_price" name="total_contract_price" required>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label>Payment Method:</label>
                                        <select class="form-control-blue editable-field" id="paymentMethod" name="payment_method" required>
                                            <option value="" disabled selected>Select Payment Method</option>
                                            <option value="Installments">Installments</option>
                                            <option value="Once Off Payment">Once Off Payment</option>
                                        </select>
                                    </div>

                                    <div class="form-group row align-items-start" id="bullet_payment_date" style="display: none; margin-bottom: 0.5rem;">
                                        <label for="bullet_payment_date" class="col-auto col-form-label" style="padding-right: 0.5rem;">Date Full Payment Made:</label>
                                        <div class="col">
                                            <input type="date" class="form-control editable-field" id="bullet_payment_date" name="bullet_payment_date" required>
                                        </div>
                                    </div>



                                    <div id="paymentschedule" style="display: none;">


                                        <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                            <label for="monthstopay" class="col-auto col-form-label" style="padding-right: 0.5rem;">Months To Pay:</label>
                                            <div class="col">
                                                <input type="number" class="form-control editable-field" id="monthstopay" name="months_to_pay" style="width: 40%;" required>
                                            </div>
                                        </div>

                                        <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                            <label class="col-auto col-form-label" style="padding-right: 0.5rem;">Late Payment Interest (% p.a):</label>
                                            <div class="col">
                                                <input type="number" class="form-control editable-field" id="late_payment_interest" name="late_payment_interest" required>
                                            </div>
                                        </div>

                                        <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                            <label class="col-auto col-form-label" style="padding-right: 0.5rem;">Deposit Paid (USD):</label>
                                            <div class="col">
                                                <input type="number" class="form-control editable-field" id="deposit_required" name="deposit_required">
                                            </div>
                                        </div>

                                        <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                            <label for="deposit_payment_date" class="col-auto col-form-label" style="padding-right: 0.5rem;">Date Deposit Paid:</label>
                                            <div class="col">
                                                <input type="date" class="form-control editable-field" id="deposit_payment_date" name="deposit_payment_date" required>
                                            </div>
                                        </div>

                                        <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                            <label for="first_installment_due_date" class="col-auto col-form-label" style="padding-right: 0.5rem;">Due Date For First Installment:</label>
                                            <div class="col">
                                                <input type="date" class="form-control editable-field" id="first_installment_due_date" name="first_installment_due_date" required>
                                            </div>
                                        </div>

                                        <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                            <label class="col-auto col-form-label" style="padding-right: 0.5rem;">
                                                Installment Due Date Generator:
                                            </label>
                                            <div class="col-auto">
                                                <select class="form-control-blue editable-field" id="due_date_type" name="due_date_type">
                                                    <option value="auto">Automatic</option>
                                                    <option value="manual">Manual</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div id="manualInstallments"
                                            class="form-group row align-items-center"
                                            style="display:none; margin-top: 1rem; margin-bottom: 0.5rem;">
                                        </div>

                                    </div>

                                </div>

                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProjectBtn" style="width: max-content;">Save Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Project Modal -->
    <div class="modal fade" id="deleteprojectModal" tabindex="-1" aria-labelledby="deleteprojectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h6 class="modal-title" id="deleteprojectModalLabel">
                        <i class="bi bi-exclamation-triangle"></i> PROJECT REMOVAL CONFIRMATION
                    </h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="deleteProjectForm">
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>WARNING:</strong> This action cannot be undone! All project data including payments history will be permanently deleted.
                        </div>
                        
                        <p>Are you sure you want to permanently delete the following project?</p>
                        
                        <div class="mb-3">
                            <strong>Project ID:</strong> 
                            <span id="updateProjectIdDelete" class="text-danger fw-bold"></span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Client Name:</strong> 
                            <span id="deleteClientNameDisplay"></span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Project Name:</strong> 
                            <span id="deleteProjectNameDisplay"></span>
                        </div>
                        
                        <div class="form-group mt-4">
                            <label for="adminPasscode" class="form-label fw-bold">
                                <i class="bi bi-key"></i> Enter Admin Passcode to Confirm
                            </label>
                            
                            <div style="position: relative; margin-bottom: 10px;">
                                <input type="password" 
                                    class="form-control editable-field" 
                                    id="adminPasscode" 
                                    name="admin_passcode" 
                                    required 
                                    placeholder="Enter admin passcode"
                                    style="width: 100%; padding-right: 40px; padding: 10px 15px; border-radius: 8px; border: 2px solid #1E2A56; background-color: #e6f0ff; color: #1E2A56; transition: all 0.3s ease;">
                                
                                <i id="toggleAdminPassword" 
                                class="bi bi-eye" 
                                style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #1E2A56; font-size: 1.1rem;"></i>
                            </div>
                        </div>
                        
                        <input type="hidden" id="deleteProjectId" name="project_id">
                        <input type="hidden" id="deleteClientName" name="client_name">
                        <input type="hidden" id="deleteProjectName" name="project_name">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger" id="confirmDeleteBtn">
                            <span id="deleteBtnText">Delete Project Permanently</span>
                            <span id="deleteSpinner" class="spinner-border spinner-border-sm d-none"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Update Project Modal -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" style="max-width: 80%;">
            <div class="modal-content" style="font-size: 13px;">
                <form id="updateProjectForm" method="POST" action="/update_project">

                    <div class="modal-header" style="background-color: #1E2A56; color: white;">
                        <h6 class="modal-title" id="updateModalLabel"><i class="bi bi-card-checklist"></i> PROJECT PROGRESS UPDATE</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">

                        <input type="hidden" id="updateProjectId" name="project_id">
                        
                        <div class="row mb-3 g-3">
                            <!-- Client Name - Adjusted width -->
                            <div class="col-lg-2 col-md-3 col-sm-6">
                                <label for="updateClientName" class="form-label fw-bold">Client Name</label>
                                <input type="text" class="form-control editable-field" id="updateClientName" name="ClientName" >
                            </div>

                            <!-- Project Name - Adjusted width -->
                            <div class="col-lg-2 col-md-3 col-sm-6">
                                <label for="updateProjectName" class="form-label fw-bold">Project Name</label>
                                <input type="text" class="form-control editable-field" name="ProjectName" id="updateProjectName">
                            </div>

                            <!-- NEW FIELD: Project ID/Code -->
                            <div class="col-lg-2 col-md-2 col-sm-4">
                                <label for="updateProjectStartDate" class="form-label fw-bold">Project Start Date</label>
                                <input type="date" class="form-control editable-field" name="ProjectStartDate" id="updateProjectStartDate">
                            </div>

                            <!-- Total Bill - Adjusted width -->
                            <div class="col-lg-1 col-md-2 col-sm-6">
                                <label for="updateTotalContractAmount" class="form-label fw-bold">Total Bill (USD)</label>
                                <input type="number" class="form-control editable-field" name="TotalContractAmount" id="updateTotalContractAmount">
                            </div>

                            <!-- Months to Pay - Narrower -->
                            <div class="col-lg-1 col-md-2 col-sm-4">
                                <label for="updateMonthsToPay" class="form-label fw-bold">Months To Pay</label>
                                <input type="number" class="form-control editable-field" name="MonthsToPay" id="updateMonthsToPay">
                            </div>

                            <!-- Admin Name - Adjusted width -->
                            <div class="col-lg-2 col-md-3 col-sm-6">
                                <label for="updateAdminName" class="form-label fw-bold">Admin Name</label>
                                <input type="text" class="form-control editable-field" id="updateAdminName" name="AdminName">
                            </div>

                            <!-- Completion Status - Adjusted width -->
                            <div class="col-lg-1 col-md-2 col-sm-6">
                                <label for="updateCompletionStatus" class="form-label fw-bold">Completion Status</label>
                                <select class="form-select" id="updateCompletionStatus" name="completion_status">
                                    <option value="ph" disabled selected hidden>Select Status</option>
                                    <option value="Not Started">Not Started</option>
                                    <option value="Ongoing">Ongoing</option>
                                    <option value="On Hold">On Hold</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">

                            <!-- Deposit & Date Paid + Buttons (with border) -->
                            <div class="col-md-5">
                                <div style="
                                    border: 2px solid #1E2A56;
                                    border-radius: 8px;
                                    padding: 12px;
                                    height: 100%;
                                ">

                                    <!-- Deposit + Date Paid side by side -->
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <label for="updateDepositPaid" class="form-label fw-bold">Deposit Paid (USD)</label>
                                            <input type="text" class="form-control editable-field" name="depositpaid"  id="updateDepositPaid">
                                        </div>

                                        <div class="col-6">
                                            <label for="updateDatePaid" class="form-label fw-bold">Date Paid</label>
                                            <input type="date" class="form-control editable-field" id="updateDatePaid" name="deposit_date_paid">
                                        </div>
                                    </div>

                                    <!-- Buttons side by side -->
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary w-100" id="getdepositReceiptBtn">
                                            <span id="depositText">Get Receipt</span>
                                            <span id="depositSpinner" class="spinner-border spinner-border-sm d-none"></span>
                                        </button>
                                        <button type="button" class="btn btn-primary w-100" id="sendReceiptBtn">
                                            <span id="sendReceiptText"><i class="bi bi-whatsapp"></i>Send Receipt to Client</span>
                                            <span id="sendReceiptSpinner" class="spinner-border spinner-border-sm d-none"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-7">
                                <label for="updateProjectScope" class="form-label fw-bold">Project Scope</label>
                                <textarea class="form-control editable-field" id="updateProjectScope" rows="5" name="projscope"></textarea>
                            </div>

                        </div>


                                                
                        <!-- Scrollable Container -->
                        <div style="max-height: 350px; overflow-y: auto; padding-right: 10px;">

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Installment 1 Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 align-items-center">
                                        <!-- Amount -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment1Amount" class="form-label fw-bold mb-1">Amount (USD)</label>
                                                <input type="text" class="form-control editable-field" name="Installment1Amount" id="updateInstallment1Amount">
                                            </div>
                                        </div>

                                        <!-- Due Date -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment1DueDate" class="form-label fw-bold mb-1">Due Date</label>
                                                <input type="date" class="form-control editable-field" name="Installment1DueDate" id="updateInstallment1DueDate">
                                            </div>
                                        </div>

                                        <!-- Date Paid -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment1PaidDate" class="form-label fw-bold mb-1">Date Paid</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment1Date" name="installment1_paid_date">
                                            </div>
                                        </div>

                                        <!-- Button 1: Get Receipt -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Get Receipt
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Button 2: Send Receipt to Client -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100" id="sendReceiptBtninst1">
                                                    <span id="sendReceiptText1"><i class="bi bi-whatsapp"></i>Send Receipt to Client</span>
                                                    <span id="sendReceiptSpinner1" class="spinner-border spinner-border-sm d-none"></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>



                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Installment 2 Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 align-items-center">
                                        <!-- Amount -->
                                        <div class="col-sm-6 col-md-4 col-lg">
                                            <label for="updateInstallment2Amount" class="form-label fw-bold mb-1 small">Amount (USD)</label>
                                            <input type="text" class="form-control editable-field" id="updateInstallment2Amount" name="Installment2Amount">
                                        </div>

                                        <!-- Due Date -->
                                        <div class="col-sm-6 col-md-4 col-lg">
                                            <label for="updateInstallment2DueDate" class="form-label fw-bold mb-1 small">Due Date</label>
                                            <input type="date" class="form-control editable-field" id="updateInstallment2DueDate" name="Installment2DueDate">
                                        </div>

                                        <!-- Date Paid -->
                                        <div class="col-sm-6 col-md-4 col-lg">
                                            <label for="updateInstallment2Date" class="form-label fw-bold mb-1 small">Date Paid</label>
                                            <input type="date" class="form-control editable-field" id="updateInstallment2Date" name="installment2_paid_date">
                                        </div>

                                        <!-- Button 1 -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Get Receipt
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Button 2: Send Receipt to Client -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100" id="sendReceiptBtninst2">
                                                    <span id="sendReceiptText2"><i class="bi bi-whatsapp"></i>Send Receipt to Client</span>
                                                    <span id="sendReceiptSpinner2" class="spinner-border spinner-border-sm d-none"></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Installment 3 Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 align-items-center">
                                        <!-- Amount -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment3Amount" class="form-label fw-bold mb-1">Amount (USD)</label>
                                                <input type="text" class="form-control editable-field" id="updateInstallment3Amount" name="Installment3Amount">
                                            </div>
                                        </div>

                                        <!-- Due Date -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment3DueDate" class="form-label fw-bold mb-1">Due Date</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment3DueDate" name="Installment3DueDate">
                                            </div>
                                        </div>

                                        <!-- Date Paid -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment3Date" class="form-label fw-bold mb-1">Date Paid</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment3Date" name="installment3_paid_date">
                                            </div>
                                        </div>

                                        <!-- Button 1: Get Receipt -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Get Receipt
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Button 2: Send Receipt to Client -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100" id="sendReceiptBtninst3">
                                                    <span id="sendReceiptText3"><i class="bi bi-whatsapp"></i>Send Receipt to Client</span>
                                                    <span id="sendReceiptSpinner3" class="spinner-border spinner-border-sm d-none"></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Installment 4 Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 align-items-center">
                                        <!-- Amount -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment4Amount" class="form-label fw-bold mb-1">Amount (USD)</label>
                                                <input type="text" class="form-control editable-field" id="updateInstallment4Amount" name="Installment4Amount">
                                            </div>
                                        </div>

                                        <!-- Due Date -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment4DueDate" class="form-label fw-bold mb-1">Due Date</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment4DueDate" name="Installment4DueDate">
                                            </div>
                                        </div>

                                        <!-- Date Paid -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment4Date" class="form-label fw-bold mb-1">Date Paid</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment4Date" name="installment4_paid_date">
                                            </div>
                                        </div>

                                        <!-- Button 1: Get Receipt -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Get Receipt
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Button 2: Send Receipt to Client -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100" id="sendReceiptBtninst4">
                                                    <span id="sendReceiptText4"><i class="bi bi-whatsapp"></i>Send Receipt to Client</span>
                                                    <span id="sendReceiptSpinner4" class="spinner-border spinner-border-sm d-none"></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Installment 5 Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 align-items-center">
                                        <!-- Amount -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment5Amount" class="form-label fw-bold mb-1">Amount (USD)</label>
                                                <input type="text" class="form-control editable-field" id="updateInstallment5Amount" name="Installment5Amount" readonly>
                                            </div>
                                        </div>

                                        <!-- Due Date -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment5DueDate" class="form-label fw-bold mb-1">Due Date</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment5DueDate" name="Installment5DueDate">
                                            </div>
                                        </div>

                                        <!-- Date Paid -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment5Date" class="form-label fw-bold mb-1">Date Paid</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment5Date" name="installment5_paid_date">
                                            </div>
                                        </div>

                                        <!-- Button 1: Get Receipt -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Get Receipt
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Button 2: Send Receipt to Client -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100" id="sendReceiptBtninst5">
                                                    <span id="sendReceiptText5"><i class="bi bi-whatsapp"></i>Send Receipt to Client</span>
                                                    <span id="sendReceiptSpinner5" class="spinner-border spinner-border-sm d-none"></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Installment 6 Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 align-items-center">
                                        <!-- Amount -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment6Amount" class="form-label fw-bold mb-1">Amount (USD)</label>
                                                <input type="text" class="form-control editable-field" id="updateInstallment6Amount" name="Installment6Amount">
                                            </div>
                                        </div>

                                        <!-- Due Date -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment6DueDate" class="form-label fw-bold mb-1">Due Date</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment6DueDate" name="Installment6DueDate">
                                            </div>
                                        </div>

                                        <!-- Date Paid -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment6Date" class="form-label fw-bold mb-1">Date Paid</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment6Date" name="installment6_paid_date">
                                            </div>
                                        </div>

                                        <!-- Button 1: Get Receipt -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Get Receipt
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Button 2: Send Receipt to Client -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100" id="sendReceiptBtninst6">
                                                    <span id="sendReceiptText6"><i class="bi bi-whatsapp"></i>Send Receipt to Client</span>
                                                    <span id="sendReceiptSpinner6" class="spinner-border spinner-border-sm d-none"></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <!-- End Scrollable Container -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="downloadpaymentshistory" style="width: max-content;">
                            <span id="downloadText">Download Payments History</span>
                            <span id="downloadSpinner" class="spinner-border spinner-border-sm d-none"></span>
                        </button>
                        <button type="submit" class="btn btn-primary" style="width: max-content;">Save Changes</button>
                        <!-- In your update modal footer -->
                        <button type="button" 
                                class="btn btn-danger delete-project-btn" 
                                data-bs-toggle="modal" 
                                data-bs-target="#deleteprojectModal"
                                data-project-id=""
                                data-client-name=""
                                data-project-name=""
                                style="width: max-content;">
                            Delete Project
                        </button>
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

        <!-- CHANGE INSTALLMENT DATE MODAL -->
    <div class="modal fade" id="changeInstallmentDateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header" style="background:#1E2A56;color:white;">
                    <h6 class="modal-title">FIRST INSTALLMENT DUE DATE CHANGE</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <input type="hidden" id="modalProjectId">

                    <label class="fw-bold">New Due Date</label>
                    <input type="date" class="form-control editable-field" id="modalNewDueDate">

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

                    <button type="button" class="btn btn-primary" id="saveNewInstallmentDateBtn" style="width: max-content;">
                        <span id="saveDateText">Save Changes</span>
                        <span id="saveDateSpinner" class="spinner-border spinner-border-sm d-none"></span>
                    </button>
                </div>

            </div>
        </div>
    </div>

<!-- Simple Download Modal -->
<div class="modal fade" id="downloadPortfolioModal" tabindex="-1" aria-labelledby="downloadPortfolioModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background:#1E2A56;color:white;">
                <h6 class="modal-title" id="downloadPortfolioModalLabel">
                    <i class="bi bi-download"></i> DOWNLOAD MASTER PROJECTS FILE
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Simple Selection -->
                <div class="mb-4">
                    <label class="form-label fw-bold mb-3 d-flex align-items-center">
                        <i class="bi bi-filter me-2"></i> Select Projects to Include
                    </label>
                    
                    <select class="form-select form-select-lg" id="downloadFilter">
                        <option value="all"> All Projects</option>
                        <!-- Months will be loaded here -->
                    </select>
                    
                    <div class="mt-2 text-muted small">
                        <i class="bi bi-info-circle"></i> 
                        <span id="filterHelpText">Download complete project list in Excel format</span>
                    </div>
                </div>
                
                <!-- Quick Stats Preview -->
                <div class="alert alert-light border">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted d-block">Estimated records:</small>
                            <span class="fw-bold fs-5" id="recordCount">--</span>
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block">File format:</small>
                            <span class="badge bg-success">Excel (.xlsx)</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                    Close
                </button>
                <button type="button" class="btn btn-primary" id="downloadBtn" style="width: max-content;">
                    <i class="bi bi-download"></i> Generate & Download
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Download Modal -->
<div class="modal fade" id="downloadInstallmentsModal" tabindex="-1" aria-labelledby="downloadInstallmentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background:#1E2A56;color:white;">
                <h6 class="modal-title" id="downloadInstallmentsModalLabel">
                    <i class="bi bi-download"></i> DOWNLOAD INSTALLMENTS SCHEDULE
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Project Start Month Selection -->
                <div class="mb-4">
                    <label class="form-label fw-bold mb-3 d-flex align-items-center">
                        <i class="bi bi-calendar-plus me-2"></i> Select Project Start Month
                    </label>
                    
                    <select class="form-select" id="projectStartFilter">
                        <option value="all"> All Time</option>
                        <!-- Project start months will be loaded here -->
                    </select>
                    
                    <div class="mt-1 text-muted small">
                        <i class="bi bi-info-circle"></i> Filter by when projects started
                    </div>
                </div>
                
                <!-- Due Month Selection -->
                <div class="mb-4">
                    <label class="form-label fw-bold mb-3 d-flex align-items-center">
                        <i class="bi bi-calendar-check me-2"></i> Select Due Month (Optional)
                    </label>
                    
                    <select class="form-select" id="dueMonthFilter">
                        <option value="all"> All Due Dates</option>
                        <!-- Due months will be loaded here -->
                    </select>
                    
                    <div class="mt-1 text-muted small">
                        <i class="bi bi-info-circle"></i> Filter by installment due dates
                    </div>
                </div>
                
                <!-- Quick Stats Preview -->
                <div class="alert alert-light border">
                    <div class="row mb-2">
                        <div class="col-12">
                            <small class="text-muted d-block">Filter Summary:</small>
                            <div id="filterSummary" class="fw-bold small">All projects, all due dates</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-4">
                            <small class="text-muted d-block">Total:</small>
                            <span class="fw-bold fs-5" id="totalInstallmentsCount">--</span>
                        </div>
                        <div class="col-4">
                            <span class="badge bg-success me-1"></span>
                            <small class="text-muted">Paid:</small>
                            <div class="fw-bold" id="paidCount">--</div>
                        </div>
                        <div class="col-4">
                            <span class="badge bg-warning me-1"></span>
                            <small class="text-muted">Due:</small>
                            <div class="fw-bold" id="dueCount">--</div>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted d-block">File Format:</small>
                            <span class="badge bg-success">Excel (.xlsx)</span>
                            <span class="badge bg-info ms-1">Separate Paid/Due Sheets</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" id="downloadInstallmentsBtn" style="width: max-content;">
                    <i class="bi bi-download"></i> Generate & Download
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SENT REMINDERS MODAL -->
<div class="modal fade" id="sentRemindersModal" tabindex="-1" aria-labelledby="sentRemindersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sentRemindersModalLabel">
                    <i class="bi bi-clock-history me-2"></i> Sent WhatsApp Reminders
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filter Controls -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" id="sentRemindersSearch" class="form-control" placeholder="Search client or project...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select id="sentRemindersStatusFilter" class="form-select">
                            <option value="">All Status</option>
                            <option value="overdue">Overdue</option>
                            <option value="soon">Due Soon</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select id="sentRemindersDateFilter" class="form-select">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Total Sent</h6>
                                        <p class="mb-0" id="totalSentCount">0</p>
                                    </div>
                                    <i class="bi bi-send fs-4 text-primary"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Overdue</h6>
                                        <p class="mb-0" id="overdueSentCount">0</p>
                                    </div>
                                    <i class="bi bi-exclamation-triangle fs-4 text-danger"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Due Soon</h6>
                                        <p class="mb-0" id="soonSentCount">0</p>
                                    </div>
                                    <i class="bi bi-clock fs-4 text-warning"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">Failed</h6>
                                        <p class="mb-0" id="failedSentCount">0</p>
                                    </div>
                                    <i class="bi bi-x-circle fs-4 text-secondary"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Loading Indicator -->
                <div id="sentRemindersLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading sent reminders...</p>
                </div>
                
                <!-- Sent Reminders Table -->
                <div id="sentRemindersContainer" style="max-height: 500px; overflow-y: auto; display: none;">
                    <table class="table table-hover table-sm">
                        <thead class="sticky-top" style="background-color: var(--bg-color);">
                            <tr>
                                <th>#</th>
                                <th><i class="bi bi-person me-1"></i> Client</th>
                                <th><i class="bi bi-phone me-1"></i> WhatsApp</th>
                                <th><i class="bi bi-briefcase me-1"></i> Project</th>
                                <th><i class="bi bi-hash me-1"></i> Installment</th>
                                <th><i class="bi bi-cash me-1"></i> Amount</th>
                                <th><i class="bi bi-tag me-1"></i> Status</th>
                                <th><i class="bi bi-calendar me-1"></i> Days Info</th>
                                <th><i class="bi bi-clock me-1"></i> Sent At</th>
                                <th><i class="bi bi-info-circle me-1"></i> Action</th>
                            </tr>
                        </thead>
                        <tbody id="sentRemindersTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="loadSentReminders()">
                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PAYMENT REMINDERS MODAL - Add this anywhere in your HTML body -->
<div class="modal fade" id="paymentRemindersModal" tabindex="-1" aria-labelledby="paymentRemindersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentRemindersModalLabel">
                    <i class="bi bi-bell-fill"></i> Payment Reminders
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Summary Cards -->
                <div class="dashboard-summary mb-4">
                    <div class="summary-card">
                        <div class="icon">
                            <i class="bi bi-clock text-warning"></i>
                        </div>
                        <div class="details">
                            <h5>Due Soon</h5>
                            <p id="dueSoonCount" class="text-warning">0</p>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="icon">
                            <i class="bi bi-exclamation-triangle text-danger"></i>
                        </div>
                        <div class="details">
                            <h5>Overdue</h5>
                            <p id="overdueCount" class="text-danger">0</p>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="icon">
                            <i class="bi bi-cash-stack text-info"></i>
                        </div>
                        <div class="details">
                            <h5>Total Amount</h5>
                            <p id="totalAmount" class="text-info">$0</p>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="icon">
                            <i class="bi bi-people text-primary"></i>
                        </div>
                        <div class="details">
                            <h5>Clients</h5>
                            <p id="totalClients" class="text-primary">0</p>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="icon">
                            <i class="bi bi-whatsapp text-success"></i>
                        </div>
                        <div class="details">
                            <h5>Ready to Send</h5>
                            <p id="readyToSend" class="text-success">0</p>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="reminderTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="dueSoon-tab" data-bs-toggle="tab" data-bs-target="#dueSoon" type="button" role="tab">
                            <i class="bi bi-clock me-1"></i> Due within next 3 days 
                            <span class="badge bg-warning ms-2" id="dueSoonBadge">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="overdue-tab" data-bs-toggle="tab" data-bs-target="#overdue" type="button" role="tab">
                            <i class="bi bi-exclamation-triangle me-1"></i> Overdue 
                            <span class="badge bg-danger ms-2" id="overdueBadge">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">
                            <i class="bi bi-list-ul me-1"></i> All Reminders
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Due Soon Tab -->
                    <div class="tab-pane fade show active" id="dueSoon" role="tabpanel">
                        <div style="max-height: 400px; overflow-y: auto; padding: 10px;">
                            <table class="table table-hover table-theme">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Client</th>
                                        <th>WhatsApp</th>
                                        <th>Project</th>
                                        <th>Installment</th>
                                        <th>Amount</th>
                                        <th>Due Date</th>
                                        <th>Days Left</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="dueSoonTableBody">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Overdue Tab -->
                    <div class="tab-pane fade" id="overdue" role="tabpanel">
                        <div style="max-height: 400px; overflow-y: auto; padding: 10px;">
                            <table class="table table-hover table-theme">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Client</th>
                                        <th>WhatsApp</th>
                                        <th>Project</th>
                                        <th>Installment</th>
                                        <th>Amount</th>
                                        <th>Due Date</th>
                                        <th>Days Overdue</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="overdueTableBody">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- All Tab -->
                    <div class="tab-pane fade" id="all" role="tabpanel">
                        <div style="max-height: 400px; overflow-y: auto; padding: 10px;">
                            <table class="table table-hover table-theme">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Client</th>
                                        <th>WhatsApp</th>
                                        <th>Project</th>
                                        <th>Installment</th>
                                        <th>Amount</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="allRemindersTableBody">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-info" id="viewSentRemindersBtn">
                    <i class="bi bi-clock-history me-1"></i> View Sent Reminders
                </button>
                <button type="button" class="btn btn-success" id="sendAllRemindersBtn">
                    <i class="bi bi-whatsapp me-1"></i> Send All Reminders
                </button>
            </div>
        </div>
    </div>
</div>

<!-- HIDDEN DATA CONTAINER - Add this too -->
<div id="paymentRemindersData" data-reminders='{{ payment_reminders|tojson|safe if payment_reminders else "{}" }}' style="display: none;"></div>




<!-- View Interim Enquiries Modal -->
<div class="modal fade" id="viewEnquiriesModal" tabindex="-1" aria-labelledby="viewEnquiriesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-fullscreen" style="max-width: 1400px;">
        <div class="modal-content" style="height: 95vh;">
            <!-- Modal Header -->
            <div class="modal-header" style="background:#1E2A56;color:white;">
                <div class="d-flex align-items-center w-100">
                    <div class="me-3">
                        <i class="bi bi-search fs-3"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="modal-title mb-0 fw-bold">INTERIM ENQUIRIES MANAGEMENT</h5>
                        <small class="opacity-85">View and manage temporary enquiries</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-white text-primary px-3 py-2" id="recordCount">0 records</span>
                        <button type="button" class="btn btn-light btn-sm px-3" onclick="loadEnquiriesData()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body p-0 d-flex flex-column">
                <!-- Statistics Bar -->
                <div class="border-bottom bg-light py-3 px-4">
                    <div class="row g-3">
                        <div class="col-auto">
                            <div class="d-flex align-items-center bg-white rounded px-3 py-2 shadow-sm">
                                <i class="bi bi-inbox text-primary me-2 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark fs-4" id="totalEnquiries">0</div>
                                    <small class="text-muted">Total</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="d-flex align-items-center bg-white rounded px-3 py-2 shadow-sm">
                                <i class="bi bi-cup-straw text-success me-2 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark fs-4" id="kitchenCount">0</div>
                                    <small class="text-muted">Kitchen</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="d-flex align-items-center bg-white rounded px-3 py-2 shadow-sm">
                                <i class="bi bi-building text-warning me-2 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark fs-4" id="buildingCount">0</div>
                                    <small class="text-muted">Building</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="d-flex align-items-center bg-white rounded px-3 py-2 shadow-sm">
                                <i class="bi bi-house-up text-info me-2 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark fs-4" id="renovationCount">0</div>
                                    <small class="text-muted">Renovation</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="d-flex align-items-center bg-white rounded px-3 py-2 shadow-sm">
                                <i class="bi bi-three-dots text-secondary me-2 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark fs-4" id="otherCount">0</div>
                                    <small class="text-muted">Other</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="flex-grow-1 d-flex" style="min-height: 0;">
                    <!-- Left Sidebar - Filters -->
                    <div class="border-end bg-white" style="width: 300px; flex-shrink: 0;">
                        <div class="p-3" style="height: 100%; overflow-y: auto;">
                            <!-- Quick Filters -->
                            <div class="mb-4">
                                <h6 class="text-dark mb-3 fw-bold">
                                    <i class="bi bi-lightning text-primary me-2"></i>
                                    Quick Filters
                                </h6>
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-sm btn-outline-primary active" onclick="filterByType('all')" id="filterAll">
                                        All
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="filterByType('kitchen_cabinets')" id="filterKitchen">
                                        Kitchen
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="filterByType('building')" id="filterBuilding">
                                        Building
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="filterByType('renovation')" id="filterRenovation">
                                        Renovation
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="filterByType('otherenq')" id="filterOther">
                                        Other
                                    </button>
                                </div>
                            </div>

                            <!-- Search Filters -->
                            <div class="mb-4">
                                <h6 class="text-dark mb-3 fw-bold">
                                    <i class="bi bi-search text-primary me-2"></i>
                                    Search Filters
                                </h6>
                                <div class="mb-3">
                                    <label class="form-label small text-muted mb-1">Enquiry Type</label>
                                    <select class="form-select form-select-sm" id="enquiryTypeFilter" onchange="applyFilters()">
                                        <option value="all">All Types</option>
                                        <option value="kitchen_cabinets">Kitchen & Cabinets</option>
                                        <option value="building">Building</option>
                                        <option value="renovation">Renovation</option>
                                        <option value="otherenq">Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small text-muted mb-1">WhatsApp Number</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">
                                            <i class="bi bi-whatsapp text-success"></i>
                                        </span>
                                        <input type="text" class="form-control" id="whatsappFilter" 
                                               placeholder="Search number..." onkeyup="applyFilters()">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small text-muted mb-1">Enquiry ID</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">
                                            <i class="bi bi-hash"></i>
                                        </span>
                                        <input type="text" class="form-control" id="idFilter" 
                                               placeholder="Search ID..." onkeyup="applyFilters()">
                                    </div>
                                </div>
                            </div>

                            <!-- Bulk Actions -->
                            <div class="mb-4">
                                <h6 class="text-dark mb-3 fw-bold">
                                    <i class="bi bi-check2-square text-primary me-2"></i>
                                    Bulk Actions
                                </h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-success" onclick="copySelectedNumbers()">
                                        <i class="bi bi-copy me-1"></i> Copy Numbers
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSelectedEnquiries()">
                                        <i class="bi bi-trash me-1"></i> Delete Selected
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                                        <i class="bi bi-x me-1"></i> Clear Selection
                                    </button>
                                </div>
                                <div class="mt-2 text-center small text-muted" id="selectedInfo">
                                    0 selected
                                </div>
                            </div>

                            <!-- Export Section -->
                            <div class="mb-4">
                                <h6 class="text-dark mb-3 fw-bold">
                                    <i class="bi bi-download text-primary me-2"></i>
                                    Export Data
                                </h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-success" onclick="exportToExcel()">
                                        <i class="bi bi-file-earmark-excel me-1"></i> Export Excel
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="exportToCSV()">
                                        <i class="bi bi-filetype-csv me-1"></i> Export CSV
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="printReport()">
                                        <i class="bi bi-printer me-1"></i> Print Report
                                    </button>
                                </div>
                            </div>

                            <!-- Refresh Section -->
                            <div>
                                <button class="btn btn-sm btn-outline-primary w-100" onclick="loadEnquiriesData()">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh Data
                                </button>
                                <div class="mt-2 text-center small text-muted">
                                    <i class="bi bi-clock me-1"></i>
                                    Updated: <span id="lastUpdated">Just now</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Table Area -->
                    <div class="flex-grow-1" style="min-width: 0;">
                        <!-- Table Header -->
                        <div class="border-bottom bg-white py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="checkbox" id="selectAll" 
                                               onchange="toggleSelectAll()">
                                    </div>
                                    <h6 class="mb-0 text-dark fw-bold">
                                        <i class="bi bi-table text-primary me-2"></i>
                                        Enquiries List
                                    </h6>
                                    <span class="badge bg-light text-dark ms-3" id="filteredCount">0</span>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="input-group input-group-sm" style="width: 250px;">
                                        <input type="text" class="form-control" id="globalSearch" 
                                               placeholder="Search all columns..." onkeyup="applyGlobalSearch()">
                                        <button class="btn btn-outline-secondary" type="button">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="scrollToTop()">
                                        <i class="bi bi-arrow-up"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Table Container -->
                        <div class="position-relative flex-grow-1" style="overflow: auto;">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light sticky-top" style="top: 0;">
                                    <tr>
                                        <th class="px-4 py-3" style="width: 80px;">
                                            <span class="small text-muted">#</span>
                                        </th>
                                        <th class="px-4 py-3" style="width: 150px;">
                                            <span class="small text-muted">ENQUIRY ID</span>
                                        </th>
                                        <th class="px-4 py-3" style="min-width: 350px;">
                                            <i class="bi bi-whatsapp text-success me-1"></i>
                                            <span class="small text-muted">WHATSAPP NUMBER</span>
                                        </th>
                                        <th class="px-4 py-3" style="width: 200px;">
                                            <i class="bi bi-tag me-1"></i>
                                            <span class="small text-muted">ENQUIRY TYPE</span>
                                        </th>
                                        <th class="px-4 py-3 text-center" style="width: 150px;">
                                            <i class="bi bi-gear me-1"></i>
                                            <span class="small text-muted">ACTIONS</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="enquiriesTableBody">
                                    <!-- Loading State -->
                                    <tr id="loadingRow">
                                        <td colspan="5" class="text-center py-5">
                                            <div class="d-flex flex-column align-items-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-3 text-muted">Loading enquiries data...</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- No Data Message -->
                            <div class="text-center py-5 d-none" id="noDataMessage">
                                <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 300px;">
                                    <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
                                    <h5 class="text-muted mb-2">No Enquiries Found</h5>
                                    <p class="text-muted small mb-4">No records match your search criteria</p>
                                    <button class="btn btn-sm btn-outline-primary" onclick="resetFilters()">
                                        <i class="bi bi-arrow-clockwise me-1"></i> Reset Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer border-top py-2 px-3">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div class="text-muted small">
                        <i class="bi bi-info-circle me-1"></i>
                        Total: <span class="fw-bold" id="totalRecords">0</span> records | 
                        Showing: <span class="fw-bold" id="showingRecords">0</span> records
                    </div>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg me-1"></i> Close
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" onclick="loadEnquiriesData()">
                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <main class="main-content" id="main-content">
        <header>
            <div class="employeetag">{{user_name}}, CONNECTLINK PROPERTIES <span style="color: white;background-color: #1E2A56;border-radius: 10px;padding: 6px;font-size: 13px;">ID: {{userid}}</span></div>
            <div><span class="current-date" id="currdate">DATE: {{ today_date }}</span></div>
            <span id="name-down" value="{{firstname}}" style="display: none;"></span>
            <span id="name-down2" value="{{surname}}" style="display: none;"></span>

            <button onclick="window.location.href='/logout'" class="btn btn-primary" style="width: max-content;font-size: 14px;">  Logout<i class="bi bi-door-closed-fill" style="margin-left: 7px;"></i>  </button>

        </header>

        <div class="card" id="admin-content" style="display: block;">
            <ul class="nav nav-tabs">

                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#projects-tab"><i class="bi bi-list-columns-reverse"></i>    PROJECTS PORTFOLIO PORTAL</button>
                </li>

                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#payments-tab"><i class="bi bi-cash-coin"></i>    PAYMENTS PORTAL</button>
                </li>

                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#enquiries-tab"><i class="bi bi-person-badge-fill"></i>    ENQUIRIES PORTAL</button>
                </li>

                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#dashboard-tab"><i class="bi bi-person-badge-fill"></i>    SUMMARY</button>
                </li>

                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#contractor-details-tab"><i class="bi bi-list-columns-reverse"></i>    CONTRACTOR DETAILS</button>
                </li>

            </ul>
            <div class="tab-content mt-4">


                <div class="tab-pane fade" id="payments-tab">

                    <button class="btn btn-primary mt-1"
                            id="exportcashflowBtn"
                            style="width: max-content;">
                        <i class="bi bi-download"></i> Download Cashflow File
                    </button>

                    <button class="btn btn-primary mt-1"
                            id="exportInstallmentsBtn"
                            style="width: max-content;"
                            data-bs-toggle="modal"
                            data-bs-target="#downloadInstallmentsModal">
                        <i class="bi bi-download"></i> Download Installments Schedule
                    </button>

                    <!-- Your existing button should look like this -->
                    <button class="btn btn-primary mt-1"
                            id="installmentscheduleBtn"
                            style="width: max-content;"
                            onclick="Pushpaymentreminders()">
                        <i class="bi bi-credit-card-2-front-fill"></i> Push Payment Reminders
                    </button>

                    <input type="hidden" id="completed-projects" value="{{ count_completed|default(0)|int }}">
                    <input type="hidden" id="ongoing-projects" value="{{ count_ongoing|default(0)|int }}">

                    <div class="dashboard-summary">
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-calendar-day fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Today</h5>
                                <div class="payment-amounts">
                                    <div class="paid-amount">
                                        <span class="badge bg-success">PAID</span>
                                        <span class="amount text-success">${{ "{:,.2f}".format(payment_stats['today_paid']) }}</span>
                                    </div>
                                    <div class="overdue-amount">
                                        <span class="badge bg-danger">OVERDUE</span>
                                        <span class="amount text-danger">${{ "{:,.2f}".format(payment_stats['today_overdue']) }}</span>
                                    </div>
                                </div>
                                <small class="text-muted">Payments today</small>
                            </div>
                        </div>
                        
                        <!-- Week to Date -->
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-calendar-week fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Week To Date</h5>
                                <div class="payment-amounts">
                                    <div class="paid-amount">
                                        <span class="badge bg-success">PAID</span>
                                        <span class="amount text-success">${{ "{:,.2f}".format(payment_stats['week_paid']) }}</span>
                                    </div>
                                    <div class="overdue-amount">
                                        <span class="badge bg-danger">OVERDUE</span>
                                        <span class="amount text-danger">${{ "{:,.2f}".format(payment_stats['week_overdue']) }}</span>
                                    </div>
                                </div>
                                <small class="text-muted">Since {{ start_of_week.strftime('%b %d') }}</small>
                            </div>
                        </div>
                        
                        <!-- Month to Date -->
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-calendar-month fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Month to Date</h5>
                                <div class="payment-amounts">
                                    <div class="paid-amount">
                                        <span class="badge bg-success">PAID</span>
                                        <span class="amount text-success">${{ "{:,.2f}".format(payment_stats['month_paid']) }}</span>
                                    </div>
                                    <div class="overdue-amount">
                                        <span class="badge bg-danger">OVERDUE</span>
                                        <span class="amount text-danger">${{ "{:,.2f}".format(payment_stats['month_overdue']) }}</span>
                                    </div>
                                </div>
                                <small class="text-muted">Since {{ start_of_month.strftime('%b %d') }}</small>
                            </div>
                        </div>
                        
                        <!-- Year to Date -->
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-calendar-year fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Year to Date</h5>
                                <div class="payment-amounts">
                                    <div class="paid-amount">
                                        <span class="badge bg-success">PAID</span>
                                        <span class="amount text-success">${{ "{:,.2f}".format(payment_stats['year_paid']) }}</span>
                                    </div>
                                    <div class="overdue-amount">
                                        <span class="badge bg-danger">OVERDUE</span>
                                        <span class="amount text-danger">${{ "{:,.2f}".format(payment_stats['year_overdue']) }}</span>
                                    </div>
                                </div>
                                <small class="text-muted">Since {{ start_of_year.strftime('%Y') }}</small>
                            </div>
                        </div>
                        
                        <!-- Total Overdue (Cumulative) -->
                        <div class="summary-card overdue-card">
                            <div class="icon"><i class="bi bi-exclamation-triangle-fill fs-3" style="color: #dc3545;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder; color: #dc3545;">Total Overdue</h5>
                                <p class="count text-danger">${{ "{:,.2f}".format(payment_stats['total_overdue']) }}</p>
                                <small class="text-danger">
                                    <i class="bi bi-clock-history"></i> All unpaid past due amounts
                                </small>
                            </div>
                        </div>
            
                    </div>

                    <div class="container2" style="max-height: 360px; overflow-y: auto; margin-top: 20px;">
                        {{ status_df_html |safe }}
                    </div>


                </div>



                <div class="tab-pane fade" id="dashboard-tab">

                    <input type="hidden" id="completed-projects" value="{{ count_completed|default(0)|int }}">
                    <input type="hidden" id="ongoing-projects" value="{{ count_ongoing|default(0)|int }}">

                    <div class="dashboard-summary">
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-people-fill fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Projects</h5>
                                <p>{{ num_projects }}</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-hourglass-split fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Ongoing Projects</h5>
                                <p>{{ count_ongoing }}</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-calendar2-check-fill fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Completed Projects</h5>
                                <p>{{ count_completed }}</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-stopwatch-fill fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Average Completion Time</h5>
                                <p>{{ average_duration }} days</p>
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-1-circle-fill fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Top Location</h5>
                                <p>{{ most_frequent_location }}</p>
                            </div>
                        </div>

                    </div>

                    <div class="dashboard-graphs">

                        <div class="graph-card">
                            <h6>Completed vs Ongoing</h6>
                            <canvas id="leaveByTypeChart" width="800" height="300"></canvas>
                        </div>

                        <div class="graph-card">
                            <h6>Projects By Location</h6>
                            <canvas id="projectsByLocationChart" width="800" height="300"></canvas>
                        </div>

                        <div class="graph-card">
                            <h6>Overdue Payments</h6>
                            <canvas id="employeesRemainingChart" width="800" height="300"></canvas>
                        </div>

                    </div>

                </div>


                <div class="tab-pane fade" id="enquiries-tab">
                    <button class="btn btn-primary mt-3"
                            id="exportenquiriesBtn"
                            style="width: max-content;"
                            onclick="downloadenquiries()">
                        <i class="bi bi-download"></i> Download Enquiries File
                    </button>

                    <button class="btn btn-primary mt-3"
                            id="exportenquiriesBtn"
                            style="width: max-content;"
                            data-bs-toggle="modal"
                            data-bs-target="#viewEnquiriesModal">
                        <i class="bi bi-search"></i> View Interim Enquiries
                    </button>

                    <div class="container mt-5">
                        <div class="container2" style="max-height: 500px; overflow-y: auto;">

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <input type="text" id="enquirySearch" class="form-control form-control-sm" 
                                        placeholder="Search enquiries..." style="font-size: 12px;">
                                </div>
                                <div class="col-md-3">
                                    <select id="categoryFilter" class="form-select form-select-sm" style="font-size: 12px;">
                                        <option value="">All Categories</option>
                                        <option value="Kitchen & Cabinets">Kitchen & Cabinets</option>
                                        <option value="Building">Building</option>
                                        <option value="Renovation">Renovation</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select id="statusFilter" class="form-select form-select-sm" style="font-size: 12px;">
                                        <option value="">All Status</option>
                                        <option value="pending">Pending</option>
                                        <option value="in_progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button id="clearFilters" class="btn btn-sm btn-outline-secondary w-100" style="font-size: 12px;">
                                        Clear
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Results Count -->
                            <div class="mb-2">
                                <small id="resultsCount" class="text-muted"></small>
                            </div>

                            <table class="table-theme">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Date</th>
                                        <th>Client</th>
                                        <th>Username</th>
                                        <th>Category</th>
                                        <th>Message</th>
                                        <th>Status</th>
                                        <th>Document</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for enquiry in enquiries_data %}
                                    <tr class="enquiry-row"  id="enquiry-row-{{ enquiry.id }}"
                                        data-id="{{ enquiry.id }}"
                                        data-category="{{ enquiry.category }}"
                                        data-status="{{ enquiry.status }}"
                                        data-client="{{ enquiry.clientwhatsapp }}"
                                        data-username="{{ enquiry.username }}"
                                        data-message="{{ enquiry.message }}">
                                        <td>#{{ enquiry.id }}</td>
                                        <td>{{ enquiry.timestamp }}</td>
                                        <td>
                                            <a href="https://wa.me/263{{ enquiry.clientwhatsapp }}" target="_blank">
                                                +263{{ enquiry.clientwhatsapp }}
                                            </a>
                                        </td>
                                        <td>{{ enquiry.username }}</td>
                                        <td><span class="badge bg-secondary" style="font-size: 11px;">{{ enquiry.category }}</span></td>
                                        <td>
                                            <div class="message-container">
                                                <span class="message-preview">
                                                    {{ enquiry['message'][:10] if enquiry['message'] and enquiry['message']|length > 10 else enquiry['message'] or 'No message' }}
                                                    {% if enquiry['message'] and enquiry['message']|length > 10 %}
                                                    ... <a href="javascript:void(0)" class="expand-message" data-id="{{ enquiry['id'] }}">[Show More]</a>
                                                    {% endif %}
                                                </span>
                                                <div class="message-full" id="message-full-{{ enquiry['id'] }}" style="display: none;">
                                                    {{ enquiry['message'] or 'No message' }}
                                                    <br>
                                                    <a href="javascript:void(0)" class="collapse-message" data-id="{{ enquiry['id'] }}">[Show Less]</a>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <select class="form-select status-select" style="font-size: 11px;" data-id="{{ enquiry.id }}">
                                                <option value="pending" {% if enquiry.status == 'pending' %}selected{% endif %}>Pending</option>
                                                <option value="in_progress" {% if enquiry.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                                <option value="completed" {% if enquiry.status == 'completed' %}selected{% endif %}>Completed</option>
                                            </select>
                                        </td>
                                        <td>
                                            {% if enquiry.has_plan %}
                                            <a href="/api/enquiries/{{ enquiry.id }}/plan" target="_blank" class="btn btn-sm btn-success" style="font-size: 11px;">
                                                PDF
                                            </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <div class="tab-pane fade show active" id="projects-tab">
                    <button class="btn btn-primary mt-1"
                            id="exportprojectportBtn"
                            style="width: max-content;"
                            data-bs-toggle="modal"
                            data-bs-target="#downloadPortfolioModal">
                        <i class="bi bi-download"></i> Download Master File
                    </button>

                    <!-- Add this button anywhere in your page -->
                    <button id="aiAssistantBtn" class="btn btn-primary mt-1" style="background: linear-gradient(135deg, #0b429b,#0036 ); color: white; font-weight: bold; cursor: pointer;">
                    <i class="bi bi-robot"></i>
                        Ask AI About ConnectLink Properties Projects
                    </button>

                    <div class="container mt-6 card">
                        <div class="row mb-5 align-items-center">
                            <div class="col-md-3">

                                <div class="input-group">

                                    <span class="input-group-text" style="background-color: #1E2A56; color: white; border: 2px solid #1E2A56;">
                                        <i class="bi bi-calendar-month"></i>
                                    </span>
                                    <select class="form-select" id="monthFilter" style="border: 2px solid #1E2A56; color: #1E2A56; font-weight: 500;">
                                        {% for month in month_options %}
                                            <option value="{{ month.value }}" 
                                                    {% if loop.first %}selected{% endif %}>
                                                {{ month.display }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-2">
                                <button class="btn btn-primary" id="applyFilterBtn" style="width: max-content;">
                                    <i class="bi bi-funnel"></i> Apply Filter
                                </button>
                            </div>
                            
                        </div>

                        <div class="container2 mainalldata" style="max-height: 400px; overflow-y: auto;">
                            {{ table_datamain_html |safe }}
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="contractor-details-tab">
                    <div class="container mt-3" style="color: #1E2A56; font-size: 0.82rem;">

                        <div class="card shadow-sm border-0 rounded-4">
                            <div class="card-body p-3">

                                <h6 class="mb-2 fw-bold" style="font-size: 0.9rem;"> <i class="bi bi-building-fill-gear"></i> CONTRACTOR DETAILS</h6>

                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <p class="text-muted mb-0" style="font-size: 0.75rem;">COMPANY</p>
                                        <p class="fw-semibold mb-1">{{ companyname }}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p class="text-muted mb-0" style="font-size: 0.75rem;">PHONES</p>
                                        <p class="fw-semibold mb-0">{{ contact1 }}</p>
                                        <p class="fw-semibold mb-1">{{ contact2 }}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p class="text-muted mb-0" style="font-size: 0.75rem;">EMAIL</p>
                                        <p class="fw-semibold mb-1">{{ compemail }}</p>
                                    </div>
                                </div>

                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <p class="text-muted mb-0" style="font-size: 0.75rem;">ADDRESS</p>
                                        <p class="fw-semibold mb-1">{{ address }}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p class="text-muted mb-0" style="font-size: 0.75rem;">TIN NUMBER</p>
                                        <p class="fw-semibold mb-1">{{ tinnumber }}</p>
                                    </div>
                                </div>

                                <button class="btn btn-primary px-3 py-1" style="font-size: 0.75rem;"
                                        data-bs-toggle="modal" data-bs-target="#editContractorModal">
                                    Edit Details
                                </button>

                            </div>
                        </div>

                    </div>
                </div>

                <div class="tab-pane fade" id="settings">
                    <h4>Payments</h4>
                    <p>Manage Payments</p>
                </div>
            </div>
        </div>
    </main>

            <!-- Remove User Modal -->
    <div class="modal fade" id="removeUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">USER REMOVAL CONFIRMATION</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <form id="removeUserForm">
                    <div class="modal-body">
                        <p>Are you sure you want to remove the following user?</p>
                        
                        <div class="alert alert-info">
                            <strong>Name:</strong> <span id="modalUserName">Loading...</span><br>
                            <strong>Email:</strong> <span id="modalUserEmail">Loading...</span>
                        </div>

                        <div class="form-group mt-3">
                            <label for="passcodeInput" class="form-label">Enter Admin Passcode to Confirm</label>
                            <input type="password" class="form-control" id="passcodeInput" name="passcode" required>
                        </div>

                        <input type="hidden" name="user_id" id="modalUserId">
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Remove User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="aiModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <span class="close" style="float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #666;">&times;</span>
            
            <h3 style="color: #4285f4; margin-bottom: 20px;">
                <i class="fas fa-robot"></i> Google AI Data Analyst
            </h3>
            
            <div id="aiChat" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
                <div class="ai-message" style="background: #e8f0fe; padding: 10px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #4285f4;">
                    <strong><i class="fas fa-robot"></i> AI Assistant:</strong><br>
                    Hello! I can analyze your project database. Ask me anything about:
                    <ul style="margin: 5px 0 5px 20px;">
                        <li>Total contract values and deposits</li>
                        <li>Payment method breakdown</li>
                        <li>Monthly cash flow</li>
                        <li>Recent projects</li>
                        <li>Upcoming payments</li>
                        <li>Client statistics</li>
                    </ul>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="aiQuestion" placeholder="Ask about your data..." style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px;">
                <button id="sendQuestion" class="btn btn-primary" style="background: #4285f4; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer;">
                    <i class="fas fa-paper-plane"></i> Ask
                </button>
            </div>
            
            <div style="background: #f1f8e9; padding: 12px; border-radius: 6px; border-left: 4px solid #34a853;">
                <strong>Try asking:</strong>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                    <span class="suggestion" style="background: #e8f0fe; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer; border: 1px solid #dbeafe;" onclick="setQuestion('What is my total contract value?')">Total contract value</span>
                    <span class="suggestion" style="background: #e8f0fe; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer; border: 1px solid #dbeafe;" onclick="setQuestion('How much deposit have I collected?')">Total deposits</span>
                    <span class="suggestion" style="background: #e8f0fe; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer; border: 1px solid #dbeafe;" onclick="setQuestion('Show me payment method breakdown')">Payment methods</span>
                    <span class="suggestion" style="background: #e8f0fe; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer; border: 1px solid #dbeafe;" onclick="setQuestion('What are my recent projects?')">Recent projects</span>
                    <span class="suggestion" style="background: #e8f0fe; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer; border: 1px solid #dbeafe;" onclick="setQuestion('Show monthly cash flow')">Monthly cash flow</span>
                    <span class="suggestion" style="background: #e8f0fe; padding: 6px 12px; border-radius: 20px; font-size: 14px; cursor: pointer; border: 1px solid #dbeafe;" onclick="setQuestion('What are upcoming payments?')">Upcoming payments</span>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editContractorModal" tabindex="-1" aria-labelledby="editContractorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow" style="font-size: 0.82rem;">

                <div class="modal-header py-2">
                    <h6 class="modal-title fw-bold" id="editContractorModalLabel" style="font-size: 0.9rem;">
                        <i class="bi bi-building-fill-gear me-1" style="font-size: 0.85rem;"></i>
                        CONTRACTOR DETAILS EDITOR
                    </h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="transform: scale(.8);"></button>
                </div>

                <div class="modal-body p-3">

                    <form id="contractorEditForm">

                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold mb-1" style="font-size: 0.75rem;">Company Name</label>
                                <input type="text" class="form-control form-control-sm editable-field" value="{{ companyname }}">
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold mb-1" style="font-size: 0.75rem;">Phone 1</label>
                                <input type="text" class="form-control form-control-sm editable-field" value="{{ contact1 }}">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-semibold mb-1" style="font-size: 0.75rem;">Phone 2</label>
                                <input type="text" class="form-control form-control-sm editable-field" value="{{ contact2 }}">
                            </div>

                            <div class="col-md-6 mt-2">
                                <label class="form-label fw-semibold mb-1" style="font-size: 0.75rem;">Email</label>
                                <input type="email" class="form-control form-control-sm editable-field" value="{{ compemail }}">
                            </div>

                            <div class="col-md-6 mt-2">
                                <label class="form-label fw-semibold mb-1" style="font-size: 0.75rem;">TIN Number</label>
                                <input type="text" class="form-control form-control-sm editable-field" value="{{ tinnumber }}">
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold mb-1" style="font-size: 0.75rem;">Address</label>
                                <input type="text" class="form-control form-control-sm editable-field" value="{{ address }}">
                            </div>
                        </div>

                    </form>

                </div>

                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-danger btn-sm px-3" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary btn-sm px-3">Save Changes</button>
                </div>

            </div>
        </div>
    </div>

        <!-- Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #1E2A56; color: white;">
                    <h6 class="modal-title" id="notesModalLabel">
                        <i class="bi bi-list-ol"></i><span id="modalClientName"></span> - <span id="modalProjectName"></span> NOTES
                    </h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="transform: scale(.8);"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="notesProjectId">

                    <!-- Display Container for Existing Notes -->
                    <div class="notes-display-container mb-4">
                        <h6 class="mb-3">Existing Notes:</h6>
                        <div id="notesList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                            <!-- Notes will be loaded here -->
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-journal-text display-6"></i>
                                <p class="mt-2">No notes yet. Add your first note below.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add New Note Section -->
                    <div class="add-note-section">
                        <h6 class="mb-3">Add New Note:</h6>
                        <div class="mb-3">
                            <textarea class="form-control" id="newNoteText" rows="3" placeholder="Enter your note here..." style="resize: vertical;"></textarea>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-primary" id="addNoteBtn">
                                <i class="bi bi-plus-circle me-2"></i>Add Note
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" id="locations-data" value='{{ locations|tojson }}'>
    <input type="hidden" id="frequencies-data" value='{{ frequencies|tojson }}'>

  <!-- Bootstrap and jQuery Scripts -->


<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
// Function to set question from suggestions
function setQuestion(text) {
    document.getElementById('aiQuestion').value = text;
    document.getElementById('aiQuestion').focus();
}

document.addEventListener('DOMContentLoaded', function() {
    const aiBtn = document.getElementById('aiAssistantBtn');
    const modal = document.getElementById('aiModal');
    const closeBtn = modal.querySelector('.close');
    const aiQuestion = document.getElementById('aiQuestion');
    const sendBtn = document.getElementById('sendQuestion');
    const aiChat = document.getElementById('aiChat');
    
    // Open modal
    aiBtn.addEventListener('click', function() {
        modal.style.display = 'block';
        aiQuestion.focus();
    });
    
    // Close modal
    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
    });
    
    // Close when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // Send question
    sendBtn.addEventListener('click', sendQuestion);
    
    // Send on Enter key
    aiQuestion.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendQuestion();
        }
    });
    
    function sendQuestion() {
        const question = aiQuestion.value.trim();
        if (!question) return;
        
        // Add user message
        addMessage(question, 'user');
        aiQuestion.value = '';
        
        // Show thinking indicator
        const thinkingDiv = document.createElement('div');
        thinkingDiv.className = 'thinking';
        thinkingDiv.innerHTML = '<div class="spinner"></div> Analyzing database with Google AI...';
        aiChat.appendChild(thinkingDiv);
        aiChat.scrollTop = aiChat.scrollHeight;
        
        // Send to backend
        fetch('/ask_ai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ question: question })
        })
        .then(response => response.json())
        .then(data => {
            // Remove thinking indicator
            thinkingDiv.remove();
            
            if (data.success) {
                addMessage(data.answer, 'ai');
            } else {
                addMessage(`Error: ${data.answer}`, 'ai');
            }
        })
        .catch(error => {
            thinkingDiv.remove();
            addMessage(`Network error. Please try again.`, 'ai');
        });
    }
    
    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = sender === 'user' ? 'user-message' : 'ai-response';
        
        if (sender === 'user') {
            messageDiv.innerHTML = `<strong><i class="fas fa-user"></i> You:</strong><br>${text}`;
        } else {
            // Format AI response with better readability
            let formattedText = text.replace(/\n/g, '<br>');
            formattedText = formattedText.replace(/\$(?:\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/g, 
                match => `<span style="color: #0d6efd; font-weight: bold;">${match}</span>`);
            
            messageDiv.innerHTML = `<strong><i class="fas fa-robot"></i> AI Analyst:</strong><br>${formattedText}`;
        }
        
        aiChat.appendChild(messageDiv);
        aiChat.scrollTop = aiChat.scrollHeight;
    }
});
</script>
<script>
// ==================== MAIN FUNCTION ====================
function Pushpaymentreminders() {
    console.log('Opening Payment Reminders...');
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('paymentRemindersModal'));
    modal.show();
    
    // Load data
    loadPaymentReminders();
}


// ==================== VIEW SENT REMINDERS FUNCTIONS ====================

// Global variable to store sent reminders
let sentRemindersData = [];

// Function to open sent reminders modal
function openSentReminders() {
    // Close payment reminders modal first
    const paymentModal = bootstrap.Modal.getInstance(document.getElementById('paymentRemindersModal'));
    if (paymentModal) {
        paymentModal.hide();
    }
    
    // Open sent reminders modal
    const modal = new bootstrap.Modal(document.getElementById('sentRemindersModal'));
    modal.show();
    
    // Load sent reminders
    loadSentReminders();
}

// Function to load sent reminders from API
async function loadSentReminders() {
    try {
        // Show loading, hide table
        document.getElementById('sentRemindersLoading').style.display = 'block';
        document.getElementById('sentRemindersContainer').style.display = 'none';
        
        // Call the API
        const response = await fetch('/api/sent-reminders');
        
        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Store data globally
        sentRemindersData = data.reminders || [];
        
        // Update summary stats
        updateSentRemindersStats(sentRemindersData);
        
        // Display the data
        displaySentReminders(sentRemindersData);
        
        // Hide loading, show table
        document.getElementById('sentRemindersLoading').style.display = 'none';
        document.getElementById('sentRemindersContainer').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading sent reminders:', error);
        
        // Hide loading
        document.getElementById('sentRemindersLoading').style.display = 'none';
        
        // Show error in table
        document.getElementById('sentRemindersTableBody').innerHTML = `
            <tr>
                <td colspan="10" class="text-center py-4">
                    <i class="bi bi-exclamation-triangle text-danger fs-1"></i>
                    <p class="mt-2">Error loading sent reminders</p>
                    <p class="text-muted small">${error.message}</p>
                    <button class="btn btn-sm btn-primary" onclick="loadSentReminders()">
                        <i class="bi bi-arrow-clockwise me-1"></i> Try Again
                    </button>
                </td>
            </tr>
        `;
        document.getElementById('sentRemindersContainer').style.display = 'block';
    }
}

// Function to update summary statistics
function updateSentRemindersStats(reminders) {
    const total = reminders.length;
    const overdue = reminders.filter(r => r.status === 'overdue').length;
    const soon = reminders.filter(r => r.status === 'soon').length;
    const failed = reminders.filter(r => r.status === 'failed').length;
    
    document.getElementById('totalSentCount').textContent = total;
    document.getElementById('overdueSentCount').textContent = overdue;
    document.getElementById('soonSentCount').textContent = soon;
    document.getElementById('failedSentCount').textContent = failed;
}

// Function to display sent reminders in table
function displaySentReminders(reminders) {
    const tableBody = document.getElementById('sentRemindersTableBody');
    
    if (!reminders || reminders.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center py-4">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <p class="mt-2">No sent reminders found</p>
                    <p class="text-muted small">Send reminders to see them here</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    
    reminders.forEach((reminder, index) => {
        // Format status badge
        let statusBadge = '';
        if (reminder.status === 'overdue') {
            statusBadge = '<span class="badge bg-danger">Overdue</span>';
        } else if (reminder.status === 'soon') {
            statusBadge = '<span class="badge bg-warning">Due Soon</span>';
        } else if (reminder.status === 'failed') {
            statusBadge = '<span class="badge bg-secondary">Failed</span>';
        } else {
            statusBadge = '<span class="badge bg-info">' + (reminder.status || 'Sent') + '</span>';
        }
        
        // Format phone number
        const formattedPhone = formatPhone(reminder.whatsapp_number || '');
        
        // Format amount
        const formattedAmount = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(reminder.amount_due || 0);
        
        // Format date
        let formattedDate = 'N/A';
        if (reminder.sent_at) {
            try {
                const sentDate = new Date(reminder.sent_at);
                formattedDate = sentDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                formattedDate = reminder.sent_at;
            }
        }
        
        // Days info label
        const daysLabel = reminder.status === 'overdue' ? 'Overdue by' : 
                         reminder.status === 'soon' ? 'Due in' : 'Days';
        
        html += `
            <tr>
                <td>${index + 1}</td>
                <td><strong>${reminder.client_name || 'Unknown'}</strong></td>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-whatsapp text-success me-2"></i>
                        <span>${formattedPhone}</span>
                    </div>
                </td>
                <td>${reminder.project_name || 'N/A'}</td>
                <td><span class="badge bg-info">#${reminder.installment_number || 'N/A'}</span></td>
                <td><strong>${formattedAmount}</strong></td>
                <td>${statusBadge}</td>
                <td>
                    <span class="small">${daysLabel}</span><br>
                    <strong>${reminder.days_info || 0} days</strong>
                </td>
                <td>
                    <div class="small text-muted">${formattedDate}</div>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-info" onclick="resendReminder(${index})" title="Resend">
                        <i class="bi bi-whatsapp"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = html;
}

// Function to resend a reminder
async function resendReminder(index) {
    const reminder = sentRemindersData[index];
    
    if (!reminder) return;
    
    if (confirm(`Resend reminder to ${reminder.client_name}?`)) {
        // Prepare data for resending
        const reminderData = {
            client_name: reminder.client_name,
            whatsapp_number: reminder.whatsapp_number,
            project_name: reminder.project_name,
            installment_number: reminder.installment_number,
            amount_due: reminder.amount_due,
            days_info: reminder.days_info,
            status: reminder.status
        };
        
        try {
            // Show loading on the button
            const buttons = document.querySelectorAll('#sentRemindersTableBody .btn');
            if (buttons[index]) {
                buttons[index].innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                buttons[index].disabled = true;
            }
            
            // Call the send API
            const response = await fetch('/api/send-meta-template', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(reminderData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(' Reminder resent successfully!');
                loadSentReminders(); // Refresh the list
            } else {
                throw new Error(result.error || 'Failed to resend');
            }
        } catch (error) {
            alert(` Failed to resend: ${error.message}`);
            
            // Reset button
            const buttons = document.querySelectorAll('#sentRemindersTableBody .btn');
            if (buttons[index]) {
                buttons[index].innerHTML = '<i class="bi bi-whatsapp"></i>';
                buttons[index].disabled = false;
            }
        }
    }
}

// Function to filter sent reminders
function filterSentReminders() {
    const searchText = document.getElementById('sentRemindersSearch').value.toLowerCase();
    const statusFilter = document.getElementById('sentRemindersStatusFilter').value;
    const dateFilter = document.getElementById('sentRemindersDateFilter').value;
    
    let filtered = [...sentRemindersData];
    
    // Apply search filter
    if (searchText) {
        filtered = filtered.filter(reminder => 
            (reminder.client_name || '').toLowerCase().includes(searchText) ||
            (reminder.project_name || '').toLowerCase().includes(searchText) ||
            (reminder.whatsapp_number || '').includes(searchText)
        );
    }
    
    // Apply status filter
    if (statusFilter) {
        filtered = filtered.filter(reminder => reminder.status === statusFilter);
    }
    
    // Apply date filter
    if (dateFilter) {
        const now = new Date();
        filtered = filtered.filter(reminder => {
            if (!reminder.sent_at) return false;
            
            const sentDate = new Date(reminder.sent_at);
            
            switch (dateFilter) {
                case 'today':
                    return sentDate.toDateString() === now.toDateString();
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return sentDate >= weekAgo;
                case 'month':
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    return sentDate >= monthAgo;
                default:
                    return true;
            }
        });
    }
    
    // Display filtered results
    displaySentReminders(filtered);
    updateSentRemindersStats(filtered);
}

// Add event listeners for sent reminders
function initSentRemindersListeners() {
    // Button to open sent reminders modal
    const viewSentBtn = document.getElementById('viewSentRemindersBtn');
    if (viewSentBtn) {
        viewSentBtn.addEventListener('click', openSentReminders);
    }
    
    // Filter event listeners
    const searchInput = document.getElementById('sentRemindersSearch');
    const statusFilter = document.getElementById('sentRemindersStatusFilter');
    const dateFilter = document.getElementById('sentRemindersDateFilter');
    
    if (searchInput) searchInput.addEventListener('input', filterSentReminders);
    if (statusFilter) statusFilter.addEventListener('change', filterSentReminders);
    if (dateFilter) dateFilter.addEventListener('change', filterSentReminders);
}

// Initialize when DOM is loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSentRemindersListeners);
} else {
    initSentRemindersListeners();
}

// Add to your existing window object
window.openSentReminders = openSentReminders;
window.loadSentReminders = loadSentReminders;
// ==================== DATA LOADING ====================
async function loadPaymentReminders() {
    try {
        // Try embedded data first
        const dataDiv = document.getElementById('paymentRemindersData');
        if (dataDiv && dataDiv.dataset.reminders) {
            const data = JSON.parse(dataDiv.dataset.reminders);
            if (data && (data.due_soon || data.overdue)) {
                console.log('Using embedded data');
                displayPaymentReminders(data);
                return;
            }
        }
        
        // Fetch from API
        console.log('Fetching from API...');
        const response = await fetch('/api/payment-reminders');
        
        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        console.log('API Data received:', data);
        displayPaymentReminders(data);
        
    } catch (error) {
        console.error('Error loading payment reminders:', error);
        
        // Fallback to extracting from allprojectsTable
        if (document.getElementById('allprojectsTable')) {
            extractDataFromTable();
        } else {
            useSampleData();
        }
    }
}

function extractDataFromTable() {
    try {
        const table = document.getElementById('allprojectsTable');
        const rows = table.querySelectorAll('tbody tr');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const dueSoon = [];
        const overdue = [];
        
        rows.forEach((row, index) => {
            const cells = row.querySelectorAll('td');
            
            // Get basic info - adjust indices based on your table
            const clientName = cells[1]?.textContent?.trim() || '';
            const whatsapp = cells[4]?.textContent?.trim() || '';
            const projectName = cells[10]?.textContent?.trim() || '';
            const status = cells[38]?.textContent?.trim() || '';
            
            if (status !== 'Ongoing') return;
            
            // Extract installment data - these are example indices
            for (let i = 1; i <= 6; i++) {
                const amountIdx = 26 + ((i - 1) * 3);
                const dueDateIdx = amountIdx + 1;
                const paidDateIdx = amountIdx + 2;
                
                const amountText = cells[amountIdx]?.textContent?.trim();
                const dueDateText = cells[dueDateIdx]?.textContent?.trim();
                const paidDateText = cells[paidDateIdx]?.textContent?.trim();
                
                if (dueDateText && !paidDateText && amountText) {
                    const amount = parseFloat(amountText.replace(/[^0-9.-]+/g, '')) || 0;
                    if (amount > 0) {
                        const dueDate = parseDate(dueDateText);
                        if (dueDate) {
                            const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                            
                            const payment = {
                                project_id: index + 1,
                                client_name: clientName,
                                whatsapp_number: whatsapp,
                                project_name: projectName,
                                installment_number: i,
                                amount_due: amount,
                                due_date: dueDate.toISOString().split('T')[0],
                                days_diff: daysDiff
                            };
                            
                            if (daysDiff < 0) {
                                payment.days_overdue = Math.abs(daysDiff);
                                overdue.push(payment);
                            } else if (daysDiff <= 3) {
                                dueSoon.push(payment);
                            }
                        }
                    }
                }
            }
        });
        
        const data = {
            due_soon: dueSoon,
            overdue: overdue,
            all_payments: [...dueSoon, ...overdue]
        };
        
        displayPaymentReminders(data);
        
    } catch (error) {
        console.error('Table extraction failed:', error);
        useSampleData();
    }
}

function parseDate(dateStr) {
    try {
        // Try different formats
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
        }
        return new Date(dateStr);
    } catch (e) {
        return null;
    }
}

function useSampleData() {
    const today = new Date();
    const sampleData = {
        due_soon: [
            {
                project_id: 1,
                client_name: "Test Client 1",
                whatsapp_number: "263771234567",
                project_name: "Test Project",
                installment_number: 2,
                amount_due: 15000,
                due_date: new Date(today.getTime() + 2 * 86400000).toISOString().split('T')[0],
                days_diff: 2
            }
        ],
        overdue: [
            {
                project_id: 2,
                client_name: "Test Client 2",
                whatsapp_number: "263772345678",
                project_name: "Overdue Project",
                installment_number: 3,
                amount_due: 25000,
                due_date: new Date(today.getTime() - 5 * 86400000).toISOString().split('T')[0],
                days_diff: -5,
                days_overdue: 5
            }
        ]
    };
    
    sampleData.all_payments = [...sampleData.due_soon, ...sampleData.overdue];
    displayPaymentReminders(sampleData);
}

// ==================== DISPLAY DATA ====================
function displayPaymentReminders(data) {
    console.log('Displaying data:', data);
    
    if (!data) {
        showError('No data available');
        return;
    }
    
    const dueSoon = data.due_soon || [];
    const overdue = data.overdue || [];
    const allPayments = data.all_payments || [...dueSoon, ...overdue];
    const summary = data.summary || {};
    
    // Update summary with null checks
    const updateElement = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    };
    
    updateElement('dueSoonCount', summary.due_soon_count || dueSoon.length);
    updateElement('overdueCount', summary.overdue_count || overdue.length);
    updateElement('dueSoonBadge', summary.due_soon_count || dueSoon.length);
    updateElement('overdueBadge', summary.overdue_count || overdue.length);
    updateElement('totalClients', summary.total_clients || new Set(allPayments.map(p => p.client_name)).size);
    updateElement('readyToSend', summary.ready_to_send || dueSoon.length + overdue.length);
    
    // Update total amount
    const totalAmountEl = document.getElementById('totalAmount');
    if (totalAmountEl) {
        const totalAmount = summary.total_amount || 
                           allPayments.reduce((sum, p) => sum + (p.amount_due || 0), 0);
        totalAmountEl.textContent = '$' + totalAmount.toFixed(2);
    }
    
    // Fill tables
    fillTable('dueSoonTableBody', dueSoon, 'soon');
    fillTable('overdueTableBody', overdue, 'overdue');
    fillTable('allRemindersTableBody', allPayments, 'all');
    
    // Update send button
    const sendBtn = document.getElementById('sendAllRemindersBtn');
    const totalReminders = dueSoon.length + overdue.length;
    if (sendBtn) {
        sendBtn.disabled = totalReminders === 0;
        sendBtn.classList.toggle('disabled', totalReminders === 0);
    }
    
    // Add event listeners
    setTimeout(addEventListeners, 100);
}

function fillTable(tableId, payments, type) {
    const tableBody = document.getElementById(tableId);
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    if (!payments || payments.length === 0) {
        const message = type === 'soon' ? 'No payments due in the next 3 days' :
                        type === 'overdue' ? 'No overdue payments' :
                        'No payment reminders';
        
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4">
                    <i class="bi bi-check-circle text-success fs-4"></i>
                    <p class="mt-2 text-muted">${message}</p>
                </td>
            </tr>
        `;
        return;
    }
    
    payments.forEach((payment, index) => {
        const row = createTableRow(payment, index + 1, type);
        tableBody.innerHTML += row;
    });
}

function createTableRow(payment, index, type) {
    const client = payment.client_name || 'Unknown';
    const phone = payment.whatsapp_number || '';
    const project = payment.project_name || 'Unknown';
    const installment = payment.installment_number || '';
    const amount = payment.amount_due || 0;
    const dueDate = payment.due_date || '';
    
    const formattedDate = formatDate(dueDate);
    const formattedPhone = formatPhone(phone);
    const formattedAmount = amount.toLocaleString('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2
    });
    
    let statusHtml = '';
    let daysInfo = '';
    let statusType = type === 'all' ? (payment.days_diff < 0 ? 'overdue' : 'soon') : type;
    
    if (type === 'soon' || statusType === 'soon') {
        const daysLeft = payment.days_diff || 0;
        daysInfo = daysLeft;
        statusHtml = `<span class="badge bg-warning">${daysLeft} day${daysLeft === 1 ? '' : 's'} left</span>`;
    } else if (type === 'overdue' || statusType === 'overdue') {
        const overdueDays = payment.days_overdue || Math.abs(payment.days_diff) || 0;
        daysInfo = overdueDays;
        statusHtml = `<span class="badge bg-danger">${overdueDays} day${overdueDays === 1 ? '' : 's'} overdue</span>`;
    }
    
    return `
        <tr>
            <td>${index}</td>
            <td><strong>${client}</strong></td>
            <td>
                <div class="d-flex align-items-center">
                    <i class="bi bi-whatsapp text-success me-2"></i>
                    <span>${formattedPhone}</span>
                </div>
            </td>
            <td>${project}</td>
            <td><span class="badge bg-info">#${installment}</span></td>
            <td><strong class="text-primary">${formattedAmount}</strong></td>
            <td>${formattedDate}</td>
            <td>${type === 'all' ? statusHtml : daysInfo}</td>
            <td>
                <button class="btn btn-primary3 btn-sm send-btn"
                        data-client="${client}"
                        data-phone="${phone}"
                        data-amount="${formattedAmount}"
                        data-raw-amount="${amount}"
                        data-installment="${installment}"
                        data-project="${project}"
                        data-status="${statusType}"
                        data-days="${daysInfo}"
                        data-due-date="${dueDate}">
                    <i class="bi bi-whatsapp me-1"></i> Send
                </button>
            </td>
        </tr>
    `;
}

function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
        });
    } catch (e) {
        return dateStr;
    }
}

function formatPhone(phone) {
    if (!phone) return 'N/A';
    const cleaned = phone.toString().replace(/\D/g, '');
    
    if (cleaned.startsWith('263')) {
        if (cleaned.length === 12) {
            return `263 ${cleaned.substr(3, 3)} ${cleaned.substr(6, 3)} ${cleaned.substr(9, 3)}`;
        }
        return `263 ${cleaned.substr(3)}`;
    } else if (cleaned.startsWith('0')) {
        const withoutZero = cleaned.substr(1);
        if (withoutZero.length === 9) {
            return `263 ${withoutZero.substr(0, 3)} ${withoutZero.substr(3, 3)} ${withoutZero.substr(6, 3)}`;
        }
        return `263 ${withoutZero}`;
    }
    return `263 ${cleaned}`;
}

// ==================== META TEMPLATE FUNCTIONS ====================
async function sendMetaTemplate(paymentData) {
    // Declare sendBtn outside try block so it's available in catch

    console.log('sendMetaTemplate called with paymentData:', paymentData);
    console.log('Raw paymentData values:');
    console.log('- client:', paymentData.client);
    console.log('- phone:', paymentData.phone, 'type:', typeof paymentData.phone);
    console.log('- rawAmount:', paymentData.rawAmount, 'type:', typeof paymentData.rawAmount);
    console.log('- installment:', paymentData.installment, 'type:', typeof paymentData.installment);
    console.log('- daysInfo:', paymentData.daysInfo, 'type:', typeof paymentData.daysInfo);
    console.log('- status:', paymentData.status);

    let sendBtn = paymentData.buttonElement;
    
    try {
        // Show loading
        sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>';
        sendBtn.disabled = true;
        
        // Clean the phone number before sending
        let phoneNumber = paymentData.phone;
        
        // Remove any decimal .0 from the phone number
        phoneNumber = phoneNumber.toString().replace(/\.0$/, '');
        
        // Prepare data with cleaned phone number
        const reminderData = {
            client_name: paymentData.client,
            whatsapp_number: phoneNumber,  // Use cleaned number
            project_name: paymentData.project,
            installment_number: parseInt(paymentData.installment) || 1,
            amount_due: parseFloat(paymentData.rawAmount) || 0,
            days_info: parseInt(paymentData.daysInfo) || 0,
            status: paymentData.status || 'overdue'
        };
        
        console.log('Sending reminder data:', reminderData);
        
        // Call API
        const response = await fetch('/api/send-meta-template', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(reminderData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Success - update button
            sendBtn.innerHTML = '<i class="bi bi-check me-1"></i> Sent';
            sendBtn.classList.remove('btn-primary3');
            sendBtn.classList.add('btn-success');
            sendBtn.disabled = true;
            
            // Show success message
            alert(` WhatsApp reminder sent to ${paymentData.client}!`);
            
            // Optional: Mark row as sent
            markRowAsSent(sendBtn);
            
        } else {
            throw new Error(result.error || 'Failed to send');
        }
        
    } catch (error) {
        console.error('Error sending Meta template:', error);
        
        // Reset button - now sendBtn is defined here
        if (sendBtn) {
            sendBtn.innerHTML = '<i class="bi bi-whatsapp me-1"></i> Send';
            sendBtn.disabled = false;
            sendBtn.classList.remove('btn-success');
            sendBtn.classList.add('btn-primary3');
        }
        
        alert(` Failed to send: ${error.message}`);
    }
}
// Helper function to mark row as sent
function markRowAsSent(button) {
    const row = button.closest('tr');
    if (row) {
        // Change row background
        row.style.backgroundColor = '#f8fff8';
        
        // Disable all buttons in this row
        row.querySelectorAll('button').forEach(btn => {
            btn.disabled = true;
        });
        
        // Add checkmark icon to status column
        const statusCell = row.querySelector('td:nth-child(8)'); // Adjust index if needed
        if (statusCell) {
            statusCell.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Sent</span>';
        }
    }
}

// ==================== EVENT LISTENERS ====================
function addEventListeners() {
    // Individual send buttons
    document.querySelectorAll('.send-btn').forEach(btn => {
        // Remove existing listeners to avoid duplicates
        btn.replaceWith(btn.cloneNode(true));
    });
    
    // Re-attach listeners to fresh buttons
    document.querySelectorAll('.send-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const paymentData = {
                client: this.getAttribute('data-client'),
                phone: this.getAttribute('data-phone'),
                project: this.getAttribute('data-project'),
                installment: this.getAttribute('data-installment'),
                rawAmount: this.getAttribute('data-raw-amount'),
                status: this.getAttribute('data-status') || 'overdue',
                daysInfo: this.getAttribute('data-days') || 0,
                dueDate: this.getAttribute('data-due-date') || '',
                buttonElement: this
            };
            
            await sendMetaTemplate(paymentData);
        });
    });
    
    // Send all button
    const sendAllBtn = document.getElementById('sendAllRemindersBtn');
    if (sendAllBtn) {
        // Remove existing listener
        sendAllBtn.replaceWith(sendAllBtn.cloneNode(true));
        const newSendAllBtn = document.getElementById('sendAllRemindersBtn');
        
        newSendAllBtn.addEventListener('click', async function() {
            const dueBtns = document.querySelectorAll('#dueSoonTableBody .send-btn:not(:disabled)');
            const overdueBtns = document.querySelectorAll('#overdueTableBody .send-btn:not(:disabled)');
            const total = dueBtns.length + overdueBtns.length;
            
            if (total === 0) {
                alert('No reminders to send');
                return;
            }
            
            if (confirm(`Send ${total} payment reminders? This will send WhatsApp messages to ${total} clients.`)) {
                // Send all overdue first
                for (const btn of overdueBtns) {
                    if (!btn.disabled) {
                        const paymentData = {
                            client: btn.getAttribute('data-client'),
                            phone: btn.getAttribute('data-phone'),
                            project: btn.getAttribute('data-project'),
                            installment: btn.getAttribute('data-installment'),
                            rawAmount: btn.getAttribute('data-raw-amount'),
                            status: btn.getAttribute('data-status'),
                            daysInfo: btn.getAttribute('data-days'),
                            buttonElement: btn
                        };
                        await sendMetaTemplate(paymentData);
                        await new Promise(resolve => setTimeout(resolve, 500)); // Small delay
                    }
                }
                
                // Then send due soon
                for (const btn of dueBtns) {
                    if (!btn.disabled) {
                        const paymentData = {
                            client: btn.getAttribute('data-client'),
                            phone: btn.getAttribute('data-phone'),
                            project: btn.getAttribute('data-project'),
                            installment: btn.getAttribute('data-installment'),
                            rawAmount: btn.getAttribute('data-raw-amount'),
                            status: btn.getAttribute('data-status'),
                            daysInfo: btn.getAttribute('data-days'),
                            buttonElement: btn
                        };
                        await sendMetaTemplate(paymentData);
                        await new Promise(resolve => setTimeout(resolve, 500)); // Small delay
                    }
                }
                
                alert(` Started sending ${total} reminders!`);
            }
        });
    }
}

function showError(message) {
    const modalBody = document.querySelector('#paymentRemindersModal .modal-body');
    if (modalBody) {
        // Don't replace entire modal body, just show error at top
        let errorDiv = document.getElementById('paymentRemindersError');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'paymentRemindersError';
            errorDiv.className = 'alert alert-danger mb-3';
            modalBody.insertBefore(errorDiv, modalBody.firstChild);
        }
        errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${message}`;
        errorDiv.style.display = 'block';
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }
}

// ==================== INITIALIZATION ====================
window.Pushpaymentreminders = Pushpaymentreminders;

// Add DOMContentLoaded wrapper to prevent errors
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize any necessary elements here
        console.log('Payment reminders script loaded');
    });
} else {
    // DOM already loaded
    console.log('Payment reminders script loaded (DOM already ready)');
}

</script>
<script>
// Submit update form via AJAX - FIXED VERSION
document.getElementById('updateProjectForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = this;
    const submitBtn = form.querySelector('button[type="submit"]');
    const loaderxyz = document.getElementById("edsLoader2");
    
    // Show loader
    if (loaderxyz) loaderxyz.style.display = "flex";
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
    
    try {
        // 1. Update project in database
        const response = await fetch('/update_project', {
            method: 'POST',
            body: new FormData(form)
        });
        
        const data = await response.json();
        
        // Hide loader
        if (loaderxyz) loaderxyz.style.display = "none";
        
        if (data && data.success) {
            // Show success message
            alert(' Project updated successfully!');
            
            // 2. Refresh the ENTIRE DataTable
            await refreshEntireTable();
            
            // 3. Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('updateModal'));
            if (modal) {
                modal.hide();
            }

            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Save Changes';

        } else {
            const errorMsg = data ? (data.error_message || data.message || 'Error updating project') : 'Unknown error';
            alert(' ' + errorMsg);
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Save Changes';
        }
    } catch (error) {
        console.error('Error:', error);
        if (loaderxyz) loaderxyz.style.display = "none";
        alert(' Network error occurred');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Save Changes';
    }
});

// Function to refresh ENTIRE DataTable - FIXED VERSION
async function refreshEntireTable() {
    const table = $('#allprojectsTable');
    
    if (!$.fn.DataTable.isDataTable('#allprojectsTable')) {
        console.log('Table not ready, reloading page');
        location.reload();
        return;
    }
    
    // Get the DataTable instance
    const dataTable = window.dataTable || table.DataTable();
    
    // Show loading on table
    const tableWrapper = table.closest('.dataTables_wrapper');
    tableWrapper.css('position', 'relative');
    
    const loadingDiv = $(`
        <div class="table-loading" style="
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        ">
            <div class="spinner-border text-primary"></div>
        </div>
    `);
    
    tableWrapper.append(loadingDiv);
    
    try {
        // Get ALL fresh data from server
        const response = await fetch('/get_updated_table_data');
        const result = await response.json();
        
        if (result && result.data) {
            // Clear old data and add new data
            dataTable.clear();
            dataTable.rows.add(result.data);
            dataTable.draw();
            
            console.log('Table refreshed with', result.data.length, 'rows');
        } else {
            throw new Error('No data received');
        }
    } catch (error) {
        console.error('Refresh error:', error);
        // Fallback: reload page
        location.reload();
    } finally {
        // Remove loading
        loadingDiv.remove();
    }
}
</script>

<script>
function downloadCashflowFile() {
    const btn = document.getElementById("exportcashflowBtn");
    
    // Show spinner
    btn.disabled = true;
    btn.innerHTML = `
        <span class="spinner-border spinner-border-sm me-2"></span>
        Generating Cashflow File...
    `;
    
    // Create hidden form
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/export_cashflow';
    form.style.display = 'none';
    
    // Add to page and submit
    document.body.appendChild(form);
    form.submit();
    
    // Remove form
    document.body.removeChild(form);
    
    // Reset button after delay
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = `<i class="bi bi-download"></i> Download Cashflow File`;
    }, 2000);
}

// Add event listener
$(document).ready(function() {
    document.getElementById("exportcashflowBtn").addEventListener("click", downloadCashflowFile);
});


</script>
<script>

    
$(document).ready(function() {


    
    $('#sendReceiptBtninst6').on('click', function() {
        const projectId = $('#updateProjectId').val();
        const installment6PaidDate = $('#updateInstallment6Date').val();
        
        // Check if project is selected
        if (!projectId) {
            alert(' No project selected!');
            return;
        }
        
        // Check if installment 6 paid date is empty/null/undefined
        if (!installment6PaidDate || installment6PaidDate === '' || 
            installment6PaidDate === 'null' || installment6PaidDate === 'undefined' ||
            installment6PaidDate.trim() === '') {
            alert(' Sorry, you have to input the date installment 6 was paid first before you can send receipt to client');
            return;
        }
        
        // Validate date format (optional but recommended)
        if (!isValidDate(installment6PaidDate)) {
            alert(' Please enter a valid date for installment 6 payment');
            return;
        }
        
        const $btn = $(this);
        const $textSpan = $('#sendReceiptText6');
        const $spinner = $('#sendReceiptSpinner6');
        const originalText = $textSpan.html();
        
        // Show spinner
        $btn.prop('disabled', true);
        $textSpan.addClass('d-none');
        $spinner.removeClass('d-none');
        
        // Send AJAX request with both project_id and installment6_paid_date
        $.ajax({
            url: '/send_receipt_to_client_inst6',
            type: 'POST',
            data: {
                project_id: projectId,
                installment6_paid_date: installment6PaidDate,
                installment_number: 6  // Optional: to identify which installment
            },
            success: function(data) {
                // Show alert with response data
                if (data.success) {
                    alert(
                        ' SUCCESS!\n\n' +
                        (data.success_message || 'Receipt sent successfully!') + '\n\n' +
                        'Details:\n' +
                        ' Client: ' + (data.details?.client_name || 'Unknown') + '\n' +
                        ' WhatsApp: ' + (data.details?.whatsapp_number || 'Unknown') + '\n' +
                        ' Project: ' + (data.details?.project_name || 'Unknown') + '\n' +
                        ' Installment Date: ' + installment6PaidDate
                    );
                } else {
                    alert(
                        ' FAILED!\n\n' +
                        (data.error_message || data.message || 'Unknown error') + '\n\n' +
                        'Details:\n' +
                        ' Client: ' + (data.details?.client_name || 'Unknown') + '\n' +
                        ' WhatsApp: ' + (data.details?.whatsapp_number || 'Unknown') + '\n' +
                        ' Project: ' + (data.details?.project_name || 'Unknown')
                    );
                }
                
                // Reset button
                resetButton();
            },
            error: function(xhr, status, error) {
                alert(' ERROR!\n\nFailed to send receipt: ' + error);
                resetButton();
            }
        });
        
        // Function to reset button
        function resetButton() {
            $btn.prop('disabled', false);
            $textSpan.removeClass('d-none');
            $spinner.addClass('d-none');
            $textSpan.html(originalText);
        }
        
        // Function to validate date
        function isValidDate(dateString) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateString.match(regex)) return false;
            
            const date = new Date(dateString);
            const timestamp = date.getTime();
            
            // Check if date is valid
            if (typeof timestamp !== 'number' || Number.isNaN(timestamp)) {
                return false;
            }
            
            return date.toISOString().startsWith(dateString);
        }
    });




    
    $('#sendReceiptBtninst5').on('click', function() {
        const projectId = $('#updateProjectId').val();
        const installment5PaidDate = $('#updateInstallment5Date').val();
        
        // Check if project is selected
        if (!projectId) {
            alert(' No project selected!');
            return;
        }
        
        // Check if installment 5 paid date is empty/null/undefined
        if (!installment5PaidDate || installment5PaidDate === '' || 
            installment5PaidDate === 'null' || installment5PaidDate === 'undefined' ||
            installment5PaidDate.trim() === '') {
            alert(' Sorry, you have to input the date installment 5 was paid first before you can send receipt to client');
            return;
        }
        
        // Validate date format (optional but recommended)
        if (!isValidDate(installment5PaidDate)) {
            alert(' Please enter a valid date for installment 5 payment');
            return;
        }
        
        const $btn = $(this);
        const $textSpan = $('#sendReceiptText5');
        const $spinner = $('#sendReceiptSpinner5');
        const originalText = $textSpan.html();
        
        // Show spinner
        $btn.prop('disabled', true);
        $textSpan.addClass('d-none');
        $spinner.removeClass('d-none');
        
        // Send AJAX request with both project_id and installment5_paid_date
        $.ajax({
            url: '/send_receipt_to_client_inst5',
            type: 'POST',
            data: {
                project_id: projectId,
                installment5_paid_date: installment5PaidDate,
                installment_number: 5  // Optional: to identify which installment
            },
            success: function(data) {
                // Show alert with response data
                if (data.success) {
                    alert(
                        ' SUCCESS!\n\n' +
                        (data.success_message || 'Receipt sent successfully!') + '\n\n' +
                        'Details:\n' +
                        ' Client: ' + (data.details?.client_name || 'Unknown') + '\n' +
                        ' WhatsApp: ' + (data.details?.whatsapp_number || 'Unknown') + '\n' +
                        ' Project: ' + (data.details?.project_name || 'Unknown') + '\n' +
                        ' Installment Date: ' + installment5PaidDate
                    );
                } else {
                    alert(
                        ' FAILED!\n\n' +
                        (data.error_message || data.message || 'Unknown error') + '\n\n' +
                        'Details:\n' +
                        ' Client: ' + (data.details?.client_name || 'Unknown') + '\n' +
                        ' WhatsApp: ' + (data.details?.whatsapp_number || 'Unknown') + '\n' +
                        ' Project: ' + (data.details?.project_name || 'Unknown')
                    );
                }
                
                // Reset button
                resetButton();
            },
            error: function(xhr, status, error) {
                alert(' ERROR!\n\nFailed to send receipt: ' + error);
                resetButton();
            }
        });
        
        // Function to reset button
        function resetButton() {
            $btn.prop('disabled', false);
            $textSpan.removeClass('d-none');
            $spinner.addClass('d-none');
            $textSpan.html(originalText);
        }
        
        // Function to validate date
        function isValidDate(dateString) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateString.match(regex)) return false;
            
            const date = new Date(dateString);
            const timestamp = date.getTime();
            
            // Check if date is valid
            if (typeof timestamp !== 'number' || Number.isNaN(timestamp)) {
                return false;
            }
            
            return date.toISOString().startsWith(dateString);
        }
    });





    $('#sendReceiptBtninst4').on('click', function() {
        const projectId = $('#updateProjectId').val();
        const installment4PaidDate = $('#updateInstallment4Date').val();
        
        // Check if project is selected
        if (!projectId) {
            alert(' No project selected!');
            return;
        }
        
        // Check if installment 4 paid date is empty/null/undefined
        if (!installment4PaidDate || installment4PaidDate === '' || 
            installment4PaidDate === 'null' || installment4PaidDate === 'undefined' ||
            installment4PaidDate.trim() === '') {
            alert(' Sorry, you have to input the date installment 4 was paid first before you can send receipt to client');
            return;
        }
        
        // Validate date format (optional but recommended)
        if (!isValidDate(installment4PaidDate)) {
            alert(' Please enter a valid date for installment 4 payment');
            return;
        }
        
        const $btn = $(this);
        const $textSpan = $('#sendReceiptText4');
        const $spinner = $('#sendReceiptSpinner4');
        const originalText = $textSpan.html();
        
        // Show spinner
        $btn.prop('disabled', true);
        $textSpan.addClass('d-none');
        $spinner.removeClass('d-none');
        
        // Send AJAX request with both project_id and installment4_paid_date
        $.ajax({
            url: '/send_receipt_to_client_inst4',
            type: 'POST',
            data: {
                project_id: projectId,
                installment4_paid_date: installment4PaidDate,
                installment_number: 4  // Optional: to identify which installment
            },
            success: function(data) {
                // Show alert with response data
                if (data.success) {
                    alert(
                        ' SUCCESS!\n\n' +
                        (data.success_message || 'Receipt sent successfully!') + '\n\n' +
                        'Details:\n' +
                        ' Client: ' + (data.details?.client_name || 'Unknown') + '\n' +
                        ' WhatsApp: ' + (data.details?.whatsapp_number || 'Unknown') + '\n' +
                        ' Project: ' + (data.details?.project_name || 'Unknown') + '\n' +
                        ' Installment Date: ' + installment4PaidDate
                    );
                } else {
                    alert(
                        ' FAILED!\n\n' +
                        (data.error_message || data.message || 'Unknown error') + '\n\n' +
                        'Details:\n' +
                        ' Client: ' + (data.details?.client_name || 'Unknown') + '\n' +
                        ' WhatsApp: ' + (data.details?.whatsapp_number || 'Unknown') + '\n' +
                        ' Project: ' + (data.details?.project_name || 'Unknown')
                    );
                }
                
                // Reset button
                resetButton();
            },
            error: function(xhr, status, error) {
                alert(' ERROR!\n\nFailed to send receipt: ' + error);
                resetButton();
            }
        });
        
        // Function to reset button
        function resetButton() {
            $btn.prop('disabled', false);
            $textSpan.removeClass('d-none');
            $spinner.addClass('d-none');
            $textSpan.html(originalText);
        }
        
        // Function to validate date
        function isValidDate(dateString) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateString.match(regex)) return false;
            
            const date = new Date(dateString);
            const timestamp = date.getTime();
            
            // Check if date is valid
            if (typeof timestamp !== 'number' || Number.isNaN(timestamp)) {
                return false;
            }
            
            return date.toISOString().startsWith(dateString);
        }
    });






    $('#sendReceiptBtninst3').on('click', function() {
        const projectId = $('#updateProjectId').val();
        const installment3PaidDate = $('#updateInstallment3Date').val();
        
        // Check if project is selected
        if (!projectId) {
            alert(' No project selected!');
            return;
        }
        
        // Check if installment 3 paid date is empty/null/undefined
        if (!installment3PaidDate || installment3PaidDate === '' || 
            installment3PaidDate === 'null' || installment3PaidDate === 'undefined' ||
            installment3PaidDate.trim() === '') {
            alert(' Sorry, you have to input the date installment 3 was paid first before you can send receipt to client');
            return;
        }
        
        // Validate date format (optional but recommended)
        if (!isValidDate(installment3PaidDate)) {
            alert(' Please enter a valid date for installment 3 payment');
            return;
        }
        
        const $btn = $(this);
        const $textSpan = $('#sendReceiptText3');
        const $spinner = $('#sendReceiptSpinner3');
        const originalText = $textSpan.html();
        
        // Show spinner
        $btn.prop('disabled', true);
        $textSpan.addClass('d-none');
        $spinner.removeClass('d-none');
        
        // Send AJAX request with both project_id and installment3_paid_date
        $.ajax({
            url: '/send_receipt_to_client_inst3',
            type: 'POST',
            data: {
                project_id: projectId,
                installment3_paid_date: installment3PaidDate,
                installment_number: 3  // Optional: to identify which installment
            },
            success: function(data) {
                // Show alert with response data
                if (data.success) {
                    alert(
                        ' SUCCESS!\n\n' +
                        (data.success_message || 'Receipt sent successfully!') + '\n\n' +
                        'Details:\n' +
                        ' Client: ' + (data.details?.client_name || 'Unknown') + '\n' +
                        ' WhatsApp: ' + (data.details?.whatsapp_number || 'Unknown') + '\n' +
                        ' Project: ' + (data.details?.project_name || 'Unknown') + '\n' +
                        ' Installment Date: ' + installment3PaidDate
                    );
                } else {
                    alert(
                        ' FAILED!\n\n' +
                        (data.error_message || data.message || 'Unknown error') + '\n\n' +
                        'Details:\n' +
                        ' Client: ' + (data.details?.client_name || 'Unknown') + '\n' +
                        ' WhatsApp: ' + (data.details?.whatsapp_number || 'Unknown') + '\n' +
                        ' Project: ' + (data.details?.project_name || 'Unknown')
                    );
                }
                
                // Reset button
                resetButton();
            },
            error: function(xhr, status, error) {
                alert(' ERROR!\n\nFailed to send receipt: ' + error);
                resetButton();
            }
        });
        
        // Function to reset button
        function resetButton() {
            $btn.prop('disabled', false);
            $textSpan.removeClass('d-none');
            $spinner.addClass('d-none');
            $textSpan.html(originalText);
        }
        
        // Function to validate date
        function isValidDate(dateString) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateString.match(regex)) return false;
            
            const date = new Date(dateString);
            const timestamp = date.getTime();
            
            // Check if date is valid
            if (typeof timestamp !== 'number' || Number.isNaN(timestamp)) {
                return false;
            }
            
            return date.toISOString().startsWith(dateString);
        }
    });



    $('#sendReceiptBtninst2').on('click', function() {
        const projectId = $('#updateProjectId').val();
        const installment2PaidDate = $('#updateInstallment2Date').val();
        
        // Check if project is selected
        if (!projectId) {
            alert(' No project selected!');
            return;
        }
        
        // Check if installment 2 paid date is empty/null/undefined
        if (!installment2PaidDate || installment2PaidDate === '' || 
            installment2PaidDate === 'null' || installment2PaidDate === 'undefined' ||
            installment2PaidDate.trim() === '') {
            alert(' Sorry, you have to input the date installment 2 was paid first before you can send receipt to client');
            return;
        }
        
        // Validate date format (optional but recommended)
        if (!isValidDate(installment2PaidDate)) {
            alert(' Please enter a valid date for installment 2 payment');
            return;
        }
        
        const $btn = $(this);
        const $textSpan = $('#sendReceiptText2');
        const $spinner = $('#sendReceiptSpinner2');
        const originalText = $textSpan.html();
        
        // Show spinner
        $btn.prop('disabled', true);
        $textSpan.addClass('d-none');
        $spinner.removeClass('d-none');
        
        // Send AJAX request with both project_id and installment2_paid_date
        $.ajax({
            url: '/send_receipt_to_client_inst2',
            type: 'POST',
            data: {
                project_id: projectId,
                installment2_paid_date: installment2PaidDate,
                installment_number: 2  // Optional: to identify which installment
            },
            success: function(data) {
                // Show alert with response data
                if (data.success) {
                    alert(
                        ' SUCCESS!\n\n' +
                        (data.success_message || 'Receipt sent successfully!') + '\n\n' +
                        'Details:\n' +
                        ' Client: ' + (data.details?.client_name || 'Unknown') + '\n' +
                        ' WhatsApp: ' + (data.details?.whatsapp_number || 'Unknown') + '\n' +
                        ' Project: ' + (data.details?.project_name || 'Unknown') + '\n' +
                        ' Installment Date: ' + installment2PaidDate
                    );
                } else {
                    alert(
                        ' FAILED!\n\n' +
                        (data.error_message || data.message || 'Unknown error') + '\n\n' +
                        'Details:\n' +
                        ' Client: ' + (data.details?.client_name || 'Unknown') + '\n' +
                        ' WhatsApp: ' + (data.details?.whatsapp_number || 'Unknown') + '\n' +
                        ' Project: ' + (data.details?.project_name || 'Unknown')
                    );
                }
                
                // Reset button
                resetButton();
            },
            error: function(xhr, status, error) {
                alert(' ERROR!\n\nFailed to send receipt: ' + error);
                resetButton();
            }
        });
        
        // Function to reset button
        function resetButton() {
            $btn.prop('disabled', false);
            $textSpan.removeClass('d-none');
            $spinner.addClass('d-none');
            $textSpan.html(originalText);
        }
        
        // Function to validate date
        function isValidDate(dateString) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateString.match(regex)) return false;
            
            const date = new Date(dateString);
            const timestamp = date.getTime();
            
            // Check if date is valid
            if (typeof timestamp !== 'number' || Number.isNaN(timestamp)) {
                return false;
            }
            
            return date.toISOString().startsWith(dateString);
        }
    });






    // Handle Send Receipt button click for installment 1
    $('#sendReceiptBtninst1').on('click', function() {
        const projectId = $('#updateProjectId').val();
        const installment1PaidDate = $('#updateInstallment1Date').val();
        
        // Check if project is selected
        if (!projectId) {
            alert(' No project selected!');
            return;
        }
        
        // Check if installment 1 paid date is empty/null/undefined
        if (!installment1PaidDate || installment1PaidDate === '' || 
            installment1PaidDate === 'null' || installment1PaidDate === 'undefined' ||
            installment1PaidDate.trim() === '') {
            alert(' Sorry, you have to input the date installment 1 was paid first before you can send receipt to client');
            return;
        }
        
        // Validate date format (optional but recommended)
        if (!isValidDate(installment1PaidDate)) {
            alert(' Please enter a valid date for installment 1 payment');
            return;
        }
        
        const $btn = $(this);
        const $textSpan = $('#sendReceiptText1');
        const $spinner = $('#sendReceiptSpinner1');
        const originalText = $textSpan.html();
        
        // Show spinner
        $btn.prop('disabled', true);
        $textSpan.addClass('d-none');
        $spinner.removeClass('d-none');
        
        // Send AJAX request with both project_id and installment1_paid_date
        $.ajax({
            url: '/send_receipt_to_client_inst1',
            type: 'POST',
            data: {
                project_id: projectId,
                installment1_paid_date: installment1PaidDate,
                installment_number: 1  // Optional: to identify which installment
            },
            success: function(data) {
                // Show alert with response data
                if (data.success) {
                    alert(
                        ' SUCCESS!\n\n' +
                        (data.success_message || 'Receipt sent successfully!') + '\n\n' +
                        'Details:\n' +
                        ' Client: ' + (data.details?.client_name || 'Unknown') + '\n' +
                        ' WhatsApp: ' + (data.details?.whatsapp_number || 'Unknown') + '\n' +
                        ' Project: ' + (data.details?.project_name || 'Unknown') + '\n' +
                        ' Installment Date: ' + installment1PaidDate
                    );
                } else {
                    alert(
                        ' FAILED!\n\n' +
                        (data.error_message || data.message || 'Unknown error') + '\n\n' +
                        'Details:\n' +
                        ' Client: ' + (data.details?.client_name || 'Unknown') + '\n' +
                        ' WhatsApp: ' + (data.details?.whatsapp_number || 'Unknown') + '\n' +
                        ' Project: ' + (data.details?.project_name || 'Unknown')
                    );
                }
                
                // Reset button
                resetButton();
            },
            error: function(xhr, status, error) {
                alert(' ERROR!\n\nFailed to send receipt: ' + error);
                resetButton();
            }
        });
        
        // Function to reset button
        function resetButton() {
            $btn.prop('disabled', false);
            $textSpan.removeClass('d-none');
            $spinner.addClass('d-none');
            $textSpan.html(originalText);
        }
        
        // Function to validate date
        function isValidDate(dateString) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateString.match(regex)) return false;
            
            const date = new Date(dateString);
            const timestamp = date.getTime();
            
            // Check if date is valid
            if (typeof timestamp !== 'number' || Number.isNaN(timestamp)) {
                return false;
            }
            
            return date.toISOString().startsWith(dateString);
        }
    });




    // Handle Send Receipt button click
    $('#sendReceiptBtn').on('click', function() {
        const projectId = $('#updateProjectId').val();
        
        if (!projectId) {
            alert(' No project selected!');
            return;
        }
        
        const btn = document.getElementById("sendReceiptBtn");
        
        // Show spinner - disable button
        btn.disabled = true;
        btn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2"></span>
            Sending to Client...
        `;
        
        // Create form data
        const formData = new FormData();
        formData.append('project_id', projectId);
        
        // Send AJAX request
        fetch('/send_receipt_to_client', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Show alert with response data
            if (data.success) {
                alert(
                    ' SUCCESS!\n\n' +
                    (data.success_message || 'Receipt sent successfully!') + '\n\n' +
                    'Details:\n' +
                    ' Client: ' + (data.details?.client_name || 'Unknown') + '\n' +
                    ' WhatsApp: ' + (data.details?.whatsapp_number || 'Unknown') + '\n' +
                    ' Project: ' + (data.details?.project_name || 'Unknown')
                );
            } else {
                alert(
                    ' FAILED!\n\n' +
                    (data.error_message || data.message || 'Unknown error') + '\n\n' +
                    'Details:\n' +
                    ' Client: ' + (data.details?.client_name || 'Unknown') + '\n' +
                    ' WhatsApp: ' + (data.details?.whatsapp_number || 'Unknown') + '\n' +
                    ' Project: ' + (data.details?.project_name || 'Unknown')
                );
            }
            
            // Reset button after showing alert
            resetButton();
        })
        .catch(error => {
            alert(' ERROR!\n\nFailed to send receipt: ' + error);
            resetButton();
        });
        
        // Function to reset button
        function resetButton() {
            btn.disabled = false;
            btn.innerHTML = `<i class="bi bi-whatsapp"></i> Send Receipt to Client`;
        }
    });
});
</script>
<script>
    // Load months when modal opens
document.getElementById('downloadInstallmentsModal').addEventListener('show.bs.modal', function() {
    loadProjectStartMonths();
    loadDueMonths();
    updateCounts();
});

// Load project start months
async function loadProjectStartMonths() {
    try {
        const response = await fetch('/get_project_start_months');
        const months = await response.json();
        
        const filterSelect = document.getElementById('projectStartFilter');
        
        // Clear all options except "All Time"
        while (filterSelect.options.length > 1) {
            filterSelect.remove(1);
        }
        
        // Add month options
        months.forEach(month => {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            const option = document.createElement('option');
            option.value = `${month.year}-${String(month.month).padStart(2, '0')}`;
            option.textContent = `${monthNames[month.month - 1]} ${month.year}`;
            filterSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading project start months:', error);
    }
}

// Load due months
async function loadDueMonths() {
    try {
        const response = await fetch('/get_due_months');
        const months = await response.json();
        
        const filterSelect = document.getElementById('dueMonthFilter');
        
        // Clear all options except "All Due Dates"
        while (filterSelect.options.length > 1) {
            filterSelect.remove(1);
        }
        
        // Add month options
        months.forEach(month => {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            const option = document.createElement('option');
            option.value = `${month.year}-${String(month.month).padStart(2, '0')}`;
            option.textContent = `${monthNames[month.month - 1]} ${month.year}`;
            filterSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading due months:', error);
    }
}

// Update counts when filters change
document.getElementById('projectStartFilter').addEventListener('change', updateCounts);
document.getElementById('dueMonthFilter').addEventListener('change', updateCounts);

// Update counts based on filters
async function updateCounts() {
    const projectStartMonth = document.getElementById('projectStartFilter').value;
    const dueMonth = document.getElementById('dueMonthFilter').value;
    
    try {
        let url = '/get_installments_count';
        const params = new URLSearchParams();
        
        if (projectStartMonth !== 'all') {
            params.append('datedepositorbullet', projectStartMonth);
        }
        
        if (dueMonth !== 'all') {
            params.append('due_month', dueMonth);
        }
        
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        const response = await fetch(url);
        const counts = await response.json();
        
        // Update display
        document.getElementById('totalInstallmentsCount').textContent = counts.total || '0';
        document.getElementById('paidCount').textContent = counts.paid || '0';
        document.getElementById('dueCount').textContent = counts.due || '0';
        
        // Update filter summary
        updateFilterSummary(projectStartMonth, dueMonth);
        
    } catch (error) {
        console.error('Error updating counts:', error);
    }
}

// Update filter summary text
function updateFilterSummary(projectStartMonth, dueMonth) {
    const summary = document.getElementById('filterSummary');
    const projectStartText = getMonthDisplayText(projectStartMonth, 'All projects');
    const dueMonthText = getMonthDisplayText(dueMonth, 'all due dates');
    
    summary.textContent = `${projectStartText}, ${dueMonthText}`;
}

// Helper function to get month display text
function getMonthDisplayText(monthValue, defaultText) {
    if (monthValue === 'all') return defaultText;
    
    const [year, month] = monthValue.split('-');
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
    
    return `${monthNames[parseInt(month)-1]} ${year}`;
}

// Download button click
document.getElementById('downloadInstallmentsBtn').addEventListener('click', function() {
    const projectStartMonth = document.getElementById('projectStartFilter').value;
    const dueMonth = document.getElementById('dueMonthFilter').value;
    
    // Show loading
    const originalText = this.innerHTML;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Generating...';
    this.disabled = true;
    
    // Build download URL
    let downloadUrl = '/download_installments';
    const params = new URLSearchParams();
    
    if (projectStartMonth !== 'all') {
        params.append('datedepositorbullet', projectStartMonth);
    }
    
    if (dueMonth !== 'all') {
        params.append('due_month', dueMonth);
    }
    
    if (params.toString()) {
        downloadUrl += '?' + params.toString();
    }
    
    // Trigger download
    const a = document.createElement('a');
    a.href = downloadUrl;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    // Reset button after delay
    setTimeout(() => {
        this.innerHTML = originalText;
        this.disabled = false;
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('downloadInstallmentsModal'));
        if (modal) {
            modal.hide();
        }
        
        // Show success message
        const projectStartText = getMonthDisplayText(projectStartMonth, 'All projects');
        const dueMonthText = getMonthDisplayText(dueMonth, 'all due dates');
        showInstallmentsDownloadSuccess(`${projectStartText}, ${dueMonthText}`);
    }, 1500);
});

// Show success message
function showInstallmentsDownloadSuccess(selection) {
    const toastHTML = `
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1060">
            <div class="toast show" role="alert">
                <div class="toast-header bg-success text-white">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong class="me-auto">Download Complete</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    <i class="bi bi-file-earmark-excel text-success me-2"></i>
                    <strong>${selection}</strong> installments downloaded successfully!
                </div>
            </div>
        </div>
    `;
    
    const container = document.createElement('div');
    container.innerHTML = toastHTML;
    document.body.appendChild(container.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (container.firstChild) {
            container.firstChild.remove();
        }
    }, 5000);
}
</script>

<script>
    // Initialize modal
document.getElementById('downloadPortfolioModal').addEventListener('show.bs.modal', function() {
    loadDownloadOptions();
});

// Load options into dropdown
function loadDownloadOptions() {
    const dropdown = document.getElementById('downloadFilter');
    const helpText = document.getElementById('filterHelpText');
    const recordCount = document.getElementById('recordCount');
    
    // Show loading
    dropdown.innerHTML = '<option value="all"> Loading options...</option>';
    recordCount.textContent = '--';
    
    // Fetch data
    fetch('/get_project_months')
        .then(response => response.json())
        .then(data => {
            // Build options
            let options = '<option value="all"> All Projects</option>';
            
            if (data && data.length > 0) {
                // Add month options
                data.forEach(monthData => {
                    const date = new Date(monthData.year, monthData.month - 1);
                    const monthName = date.toLocaleString('default', { month: 'short' });
                    const monthId = `${monthData.year}-${monthData.month.toString().padStart(2, '0')}`;
                    const displayText = ` ${monthName} ${monthData.year}`;
                    
                    options += `<option value="${monthId}">${displayText}</option>`;
                });
            } else {
                options += '<option value="" disabled>No monthly data available</option>';
            }
            
            dropdown.innerHTML = options;
            
            // Get total record count for "All Projects"
            fetch('/get_project_count')
                .then(res => res.json())
                .then(countData => {
                    recordCount.textContent = countData.total || '--';
                });
        })
        .catch(error => {
            console.error('Error:', error);
            dropdown.innerHTML = '<option value="all"> All Projects</option>' +
                                '<option value="" disabled> Failed to load months</option>';
        });
}

// Update help text based on selection
document.getElementById('downloadFilter').addEventListener('change', function() {
    const helpText = document.getElementById('filterHelpText');
    const recordCount = document.getElementById('recordCount');
    
    if (this.value === 'all') {
        helpText.textContent = 'Download complete project list in Excel format';
        // Fetch total count
        fetch('/get_project_count')
            .then(res => res.json())
            .then(data => {
                recordCount.textContent = data.total || '--';
            });
    } else {
        const [year, month] = this.value.split('-');
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthName = monthNames[parseInt(month) - 1];
        
        helpText.textContent = `Download projects from ${monthName} ${year} only`;
        
        // Fetch count for selected month
        fetch(`/get_project_count?month=${this.value}`)
            .then(res => res.json())
            .then(data => {
                recordCount.textContent = data.count || '--';
            });
    }
});

// Download button click
document.getElementById('downloadBtn').addEventListener('click', function() {
    const dropdown = document.getElementById('downloadFilter');
    const selectedValue = dropdown.value;
    
    if (!selectedValue) {
        alert('Please select an option');
        return;
    }
    
    // Show loading
    const originalText = this.innerHTML;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Generating...';
    this.disabled = true;
    
    // Determine if it's "all" or specific month
    const isAll = selectedValue === 'all';
    
    // Build download URL
    let downloadUrl = '/download_portfolio';
    
    if (!isAll) {
        downloadUrl += `?month=${selectedValue}`;
    }
    
    // Trigger download
    const a = document.createElement('a');
    a.href = downloadUrl;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    // Reset button after delay
    setTimeout(() => {
        this.innerHTML = originalText;
        this.disabled = false;
        
        // Close modal after successful download
        bootstrap.Modal.getInstance(document.getElementById('downloadPortfolioModal')).hide();
        
        // Show success message
        showDownloadSuccess(isAll ? 'All Projects' : dropdown.options[dropdown.selectedIndex].text);
    }, 1500);
});

// Show success message
function showDownloadSuccess(selection) {
    // Simple alert for success
    const toastHTML = `
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1060">
            <div class="toast show" role="alert">
                <div class="toast-header bg-success text-white">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong class="me-auto">Download Complete</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    <i class="bi bi-file-earmark-excel text-success me-2"></i>
                    ${selection} report downloaded successfully
                </div>
            </div>
        </div>
    `;
    
    const container = document.createElement('div');
    container.innerHTML = toastHTML;
    document.body.appendChild(container.firstChild);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        container.remove();
    }, 3000);
}
</script>
<script>
    // Global variables
let allEnquiriesData = [];
let filteredEnquiriesData = [];
let selectedEnquiries = new Set();

// Enquiry type configuration
const enquiryTypeConfig = {
    'kitchen_cabinets': {
        label: 'Kitchen & Cabinets',
        color: '#28a745',
        icon: 'bi-cup-straw'
    },
    'building': {
        label: 'Building',
        color: '#ffc107',
        icon: 'bi-building'
    },
    'renovation': {
        label: 'Renovation',
        color: '#17a2b8',
        icon: 'bi-house-up'
    },
    'otherenq': {
        label: 'Other',
        color: '#6c757d',
        icon: 'bi-three-dots'
    }
};

// Load enquiries data
function loadEnquiriesData() {
    console.log('Loading enquiries data...');
    showLoading(true);
    selectedEnquiries.clear();
    updateSelectionInfo();
    
    fetch('/get_temp_enquiries')
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Data received:', data);
            
            if (!Array.isArray(data)) {
                throw new Error('Data is not an array');
            }
            
            // Process data - ensure WhatsApp numbers are strings
            allEnquiriesData = data.map(enquiry => ({
                id: enquiry.id,
                wanumber: enquiry.wanumber ? enquiry.wanumber.toString() : '',
                enqtype: enquiry.enqtype || 'otherenq'
            }));
            
            console.log('Processed data:', allEnquiriesData);
            
            updateStatistics(allEnquiriesData);
            applyFilters();
            updateLastUpdated();
            showLoading(false);
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showError('Failed to load data. Check console for details.');
            showLoading(false);
        });
}

// Show/hide loading
function showLoading(show) {
    const loadingRow = document.getElementById('loadingRow');
    const noDataMessage = document.getElementById('noDataMessage');
    
    if (show) {
        loadingRow.classList.remove('d-none');
        noDataMessage.classList.add('d-none');
    } else {
        loadingRow.classList.add('d-none');
    }
}

// Show error
function showError(message) {
    const tableBody = document.getElementById('enquiriesTableBody');
    tableBody.innerHTML = `
        <tr>
            <td colspan="5" class="text-center py-5">
                <div class="d-flex flex-column align-items-center">
                    <i class="bi bi-exclamation-triangle text-danger fs-1 mb-3"></i>
                    <h5 class="text-danger mb-2">Error</h5>
                    <p class="text-muted mb-3">${message}</p>
                    <button class="btn btn-sm btn-primary" onclick="loadEnquiriesData()">
                        <i class="bi bi-arrow-clockwise me-1"></i> Try Again
                    </button>
                </div>
            </td>
        </tr>
    `;
}

// Update statistics
function updateStatistics(data) {
    const counts = {
        total: data.length,
        kitchen_cabinets: 0,
        building: 0,
        renovation: 0,
        otherenq: 0
    };
    
    data.forEach(enquiry => {
        const type = enquiry.enqtype || 'otherenq';
        if (counts.hasOwnProperty(type)) {
            counts[type]++;
        }
    });
    
    document.getElementById('totalEnquiries').textContent = counts.total;
    document.getElementById('kitchenCount').textContent = counts.kitchen_cabinets;
    document.getElementById('buildingCount').textContent = counts.building;
    document.getElementById('renovationCount').textContent = counts.renovation;
    document.getElementById('otherCount').textContent = counts.otherenq;
    document.getElementById('recordCount').textContent = `${counts.total} records`;
    document.getElementById('totalRecords').textContent = counts.total;
}

// Apply filters
function applyFilters() {
    const typeFilter = document.getElementById('enquiryTypeFilter').value;
    const whatsappFilter = document.getElementById('whatsappFilter').value.toLowerCase();
    const idFilter = document.getElementById('idFilter').value.toLowerCase();
    
    filteredEnquiriesData = allEnquiriesData.filter(enquiry => {
        // Type filter
        if (typeFilter !== 'all' && enquiry.enqtype !== typeFilter) {
            return false;
        }
        
        // WhatsApp filter
        if (whatsappFilter && enquiry.wanumber && 
            !enquiry.wanumber.toLowerCase().includes(whatsappFilter)) {
            return false;
        }
        
        // ID filter
        if (idFilter && enquiry.id && 
            !enquiry.id.toString().toLowerCase().includes(idFilter)) {
            return false;
        }
        
        return true;
    });
    
    renderTable();
    updateFilteredCount();
}

// Filter by type
function filterByType(type) {
    // Update active button
    document.querySelectorAll('#filterAll, #filterKitchen, #filterBuilding, #filterRenovation, #filterOther').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById(`filter${type === 'all' ? 'All' : type.charAt(0).toUpperCase() + type.slice(1)}`)?.classList.add('active');
    
    document.getElementById('enquiryTypeFilter').value = type;
    applyFilters();
}

// Reset filters
function resetFilters() {
    document.getElementById('enquiryTypeFilter').value = 'all';
    document.getElementById('whatsappFilter').value = '';
    document.getElementById('idFilter').value = '';
    document.getElementById('globalSearch').value = '';
    
    // Reset quick filter buttons
    document.querySelectorAll('#filterAll, #filterKitchen, #filterBuilding, #filterRenovation, #filterOther').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById('filterAll').classList.add('active');
    
    applyFilters();
}

// Apply global search
function applyGlobalSearch() {
    const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
    
    if (!searchTerm) {
        applyFilters();
        return;
    }
    
    filteredEnquiriesData = allEnquiriesData.filter(enquiry => {
        return (
            (enquiry.id && enquiry.id.toString().toLowerCase().includes(searchTerm)) ||
            (enquiry.wanumber && enquiry.wanumber.toLowerCase().includes(searchTerm)) ||
            (enquiry.enqtype && enquiry.enqtype.toLowerCase().includes(searchTerm))
        );
    });
    
    renderTable();
    updateFilteredCount();
}

// Render table
function renderTable() {
    const tableBody = document.getElementById('enquiriesTableBody');
    const noDataMessage = document.getElementById('noDataMessage');
    
    if (filteredEnquiriesData.length === 0) {
        tableBody.innerHTML = '';
        noDataMessage.classList.remove('d-none');
        updateShowingRecords();
        return;
    }
    
    noDataMessage.classList.add('d-none');
    
    let html = '';
    filteredEnquiriesData.forEach((enquiry, index) => {
        const typeConfig = enquiryTypeConfig[enquiry.enqtype] || enquiryTypeConfig['otherenq'];
        const isSelected = selectedEnquiries.has(enquiry.id.toString());
        
        html += `
            <tr class="${isSelected ? 'table-primary' : ''}">
                <td class="px-4 py-3">
                    <div class="d-flex align-items-center">
                        <div class="form-check me-2">
                            <input class="form-check-input enquiry-checkbox" 
                                   type="checkbox" 
                                   value="${enquiry.id}"
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleEnquirySelection(this)">
                        </div>
                        <span class="text-muted small">${index + 1}</span>
                    </div>
                </td>
                <td class="px-4 py-3">
                    <span class="badge bg-dark rounded-pill px-3 py-1">
                        ${enquiry.id}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-whatsapp text-success me-3"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${formatWhatsAppNumber(enquiry.wanumber)}</div>
                            <small class="text-muted d-block">Click to copy or message</small>
                        </div>
                        ${enquiry.wanumber ? `
                            <div class="d-flex gap-1">
                                <button class="btn btn-sm btn-outline-success" 
                                        onclick="copyWhatsAppNumber('${enquiry.wanumber}')"
                                        title="Copy Number">
                                    <i class="bi bi-copy"></i>
                                </button>
                                <a href="https://wa.me/${enquiry.wanumber}" 
                                   target="_blank" 
                                   class="btn btn-sm btn-success"
                                   title="Message on WhatsApp">
                                    <i class="bi bi-whatsapp"></i>
                                </a>
                            </div>
                        ` : ''}
                    </div>
                </td>
                <td class="px-4 py-3">
                    <div class="d-flex align-items-center">
                        <i class="bi ${typeConfig.icon} me-3" style="color: ${typeConfig.color}"></i>
                        <span class="badge rounded-pill px-3 py-1" 
                              style="background-color: ${typeConfig.color}; color: white;">
                            ${typeConfig.label}
                        </span>
                    </div>
                </td>
                <td class="px-4 py-3 text-center">
                    <div class="d-flex justify-content-center gap-1">
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="viewEnquiryDetails(${enquiry.id})"
                                title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="deleteEnquiry(${enquiry.id})"
                                title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = html;
    updateShowingRecords();
}

// Format WhatsApp number
function formatWhatsAppNumber(number) {
    if (!number || number === '') return 'Not Provided';
    
    const numStr = number.toString();
    const cleaned = numStr.replace(/\D/g, '');
    
    if (cleaned.length === 10) {
        return `+91 ${cleaned.substring(0,5)} ${cleaned.substring(5)}`;
    }
    
    if (cleaned.length === 12 && cleaned.startsWith('91')) {
        return `+${cleaned.substring(0,2)} ${cleaned.substring(2,7)} ${cleaned.substring(7)}`;
    }
    
    return numStr;
}

// Toggle select all
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.enquiry-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
            selectedEnquiries.add(checkbox.value);
        } else {
            selectedEnquiries.delete(checkbox.value);
        }
    });
    
    updateSelectionInfo();
    renderTable();
}

// Toggle individual selection
function toggleEnquirySelection(checkbox) {
    if (checkbox.checked) {
        selectedEnquiries.add(checkbox.value);
    } else {
        selectedEnquiries.delete(checkbox.value);
        document.getElementById('selectAll').checked = false;
    }
    
    updateSelectionInfo();
}

// Update selection info
function updateSelectionInfo() {
    const selectedInfo = document.getElementById('selectedInfo');
    if (selectedInfo) {
        selectedInfo.textContent = `${selectedEnquiries.size} selected`;
    }
}

// Update filtered count
function updateFilteredCount() {
    const filteredCount = document.getElementById('filteredCount');
    if (filteredCount) {
        filteredCount.textContent = filteredEnquiriesData.length;
    }
}

// Update showing records
function updateShowingRecords() {
    const showingRecords = document.getElementById('showingRecords');
    if (showingRecords) {
        showingRecords.textContent = filteredEnquiriesData.length;
    }
}

// Update last updated time
function updateLastUpdated() {
    const lastUpdated = document.getElementById('lastUpdated');
    if (lastUpdated) {
        const now = new Date();
        lastUpdated.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
}

// Copy WhatsApp number
function copyWhatsAppNumber(number) {
    if (!number) {
        alert('No WhatsApp number available');
        return;
    }
    
    const numberStr = number.toString();
    
    navigator.clipboard.writeText(numberStr)
        .then(() => {
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check"></i>';
            button.classList.remove('btn-outline-success');
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-success');
            }, 1000);
        })
        .catch(err => {
            console.error('Failed to copy:', err);
            alert('Failed to copy number');
        });
}

// Copy selected numbers
function copySelectedNumbers() {
    if (selectedEnquiries.size === 0) {
        alert('Please select enquiries first');
        return;
    }
    
    const numbers = [];
    selectedEnquiries.forEach(id => {
        const enquiry = allEnquiriesData.find(e => e.id.toString() === id);
        if (enquiry && enquiry.wanumber) {
            numbers.push(enquiry.wanumber);
        }
    });
    
    if (numbers.length === 0) {
        alert('No WhatsApp numbers in selected enquiries');
        return;
    }
    
    const numbersText = numbers.join('\n');
    navigator.clipboard.writeText(numbersText)
        .then(() => {
            alert(`${numbers.length} numbers copied to clipboard`);
        })
        .catch(err => {
            console.error('Copy failed:', err);
            alert('Failed to copy numbers');
        });
}

// Delete selected enquiries
function deleteSelectedEnquiries() {
    if (selectedEnquiries.size === 0) {
        alert('Please select enquiries to delete');
        return;
    }
    
    if (!confirm(`Delete ${selectedEnquiries.size} selected enquiry(s)?`)) {
        return;
    }
    
    fetch('/batch_delete_enquiries', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enquiry_ids: Array.from(selectedEnquiries)})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${selectedEnquiries.size} enquiry(s) deleted`);
            selectedEnquiries.clear();
            loadEnquiriesData();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete enquiries');
    });
}

// Delete single enquiry
function deleteEnquiry(id) {
    if (!confirm('Delete this enquiry?')) return;
    
    fetch('/delete_temp_enquiry', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enquiry_id: id})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Enquiry deleted');
            loadEnquiriesData();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete enquiry');
    });
}

// Clear selection
function clearSelection() {
    selectedEnquiries.clear();
    document.getElementById('selectAll').checked = false;
    document.querySelectorAll('.enquiry-checkbox').forEach(cb => cb.checked = false);
    updateSelectionInfo();
    renderTable();
}

// Scroll to top
function scrollToTop() {
    const tableContainer = document.querySelector('.position-relative');
    if (tableContainer) {
        tableContainer.scrollTop = 0;
    }
}

// View enquiry details
function viewEnquiryDetails(id) {
    const enquiry = allEnquiriesData.find(e => e.id === id);
    if (!enquiry) return;
    
    const typeConfig = enquiryTypeConfig[enquiry.enqtype] || enquiryTypeConfig['otherenq'];
    
    const detailHTML = `
        <div class="modal fade" id="detailModal">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: ${typeConfig.color}; color: white;">
                        <h6 class="modal-title">
                            <i class="bi ${typeConfig.icon} me-2"></i>
                            Enquiry Details
                        </h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label small text-muted">Enquiry ID</label>
                            <div class="fw-bold">${enquiry.id}</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Enquiry Type</label>
                            <div>
                                <span class="badge" style="background-color: ${typeConfig.color}; color: white;">
                                    ${typeConfig.label}
                                </span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">WhatsApp Number</label>
                            <div class="fw-bold">${formatWhatsAppNumber(enquiry.wanumber)}</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary btn-sm" onclick="copyEnquiryDetails(${enquiry.id})">
                            <i class="bi bi-copy me-1"></i> Copy Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const container = document.createElement('div');
    container.innerHTML = detailHTML;
    document.body.appendChild(container.firstChild);
    
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    modal.show();
    
    modal._element.addEventListener('hidden.bs.modal', function () {
        document.body.removeChild(this.parentElement);
    });
}

// Copy enquiry details
function copyEnquiryDetails(id) {
    const enquiry = allEnquiriesData.find(e => e.id === id);
    if (!enquiry) return;
    
    const details = `ID: ${enquiry.id}\nType: ${enquiryTypeConfig[enquiry.enqtype]?.label || 'Other'}\nWhatsApp: ${enquiry.wanumber || 'N/A'}`;
    
    navigator.clipboard.writeText(details)
        .then(() => alert('Details copied to clipboard!'))
        .catch(err => console.error('Copy failed:', err));
}

// Export to Excel (requires SheetJS)
function exportToExcel() {
    if (filteredEnquiriesData.length === 0) {
        alert('No data to export');
        return;
    }
    
    if (typeof XLSX === 'undefined') {
        alert('Excel export requires SheetJS library. Exporting as CSV instead.');
        exportToCSV();
        return;
    }
    
    const wsData = [
        ['ID', 'WhatsApp Number', 'Enquiry Type'],
        ...filteredEnquiriesData.map(enquiry => [
            enquiry.id,
            enquiry.wanumber || '',
            enquiryTypeConfig[enquiry.enqtype]?.label || 'Other'
        ])
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Enquiries');
    XLSX.writeFile(wb, `enquiries_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// Export to CSV
function exportToCSV() {
    if (filteredEnquiriesData.length === 0) {
        alert('No data to export');
        return;
    }
    
    const headers = ['ID', 'WhatsApp Number', 'Enquiry Type'];
    const csvRows = [
        headers.join(','),
        ...filteredEnquiriesData.map(enquiry => [
            `"${enquiry.id}"`,
            `"${enquiry.wanumber || ''}"`,
            `"${enquiryTypeConfig[enquiry.enqtype]?.label || 'Other'}"`
        ].join(','))
    ];
    
    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `enquiries_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Print report
function printReport() {
    if (filteredEnquiriesData.length === 0) {
        alert('No data to print');
        return;
    }
    
    const printWindow = window.open('', '_blank');
    const date = new Date().toLocaleDateString();
    
    let html = `
        <html>
        <head>
            <title>Enquiries Report - ${date}</title>
            <style>
                body { font-family: Arial; margin: 20px; }
                h1 { border-bottom: 2px solid #007bff; padding-bottom: 10px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th { background: #f8f9fa; padding: 10px; text-align: left; }
                td { padding: 8px; border-bottom: 1px solid #ddd; }
            </style>
        </head>
        <body>
            <h1>Enquiries Report</h1>
            <p>Date: ${date}</p>
            <p>Total: ${filteredEnquiriesData.length} records</p>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>WhatsApp Number</th>
                        <th>Enquiry Type</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    filteredEnquiriesData.forEach(enquiry => {
        const typeConfig = enquiryTypeConfig[enquiry.enqtype] || enquiryTypeConfig['otherenq'];
        html += `
            <tr>
                <td>${enquiry.id}</td>
                <td>${enquiry.wanumber || 'N/A'}</td>
                <td>${typeConfig.label}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </body>
        </html>
    `;
    
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();
}

// Initialize modal
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('viewEnquiriesModal');
    if (modal) {
        modal.addEventListener('shown.bs.modal', function() {
            loadEnquiriesData();
        });
    }
});
</script>

<script>


document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('enquirySearch');
    const categoryFilter = document.getElementById('categoryFilter');
    const statusFilter = document.getElementById('statusFilter');
    const clearBtn = document.getElementById('clearFilters');
    const resultsCount = document.getElementById('resultsCount');
    const enquiryRows = document.querySelectorAll('.enquiry-row');
    
    console.log('Enquiry rows found:', enquiryRows.length);
    
    function filterEnquiries() {
        console.log('Filtering...');
        const searchTerm = searchInput.value.toLowerCase();
        const categoryValue = categoryFilter.value;
        const statusValue = statusFilter.value;
        
        let visibleCount = 0;
        
        enquiryRows.forEach(row => {
            const category = row.getAttribute('data-category');
            const status = row.getAttribute('data-status');
            const client = row.getAttribute('data-client') || '';
            const username = row.getAttribute('data-username') || '';
            const message = row.getAttribute('data-message') || '';
            
            console.log('Row data:', {category, status, client, username});
            
            // Check filters
            const categoryMatch = !categoryValue || category === categoryValue;
            const statusMatch = !statusValue || status === statusValue;
            
            // Check search
            const searchMatch = !searchTerm || 
                client.toString().includes(searchTerm) ||
                username.toLowerCase().includes(searchTerm) ||
                message.toLowerCase().includes(searchTerm);
            
            if (categoryMatch && statusMatch && searchMatch) {
                row.style.display = '';
                visibleCount++;
                console.log('Showing row');
            } else {
                row.style.display = 'none';
                console.log('Hiding row');
            }
        });
        
        resultsCount.textContent = `Showing ${visibleCount} of ${enquiryRows.length} enquiries`;
        console.log('Visible count:', visibleCount);
    }
    
    // Event listeners
    if (searchInput) {
        searchInput.addEventListener('input', filterEnquiries);
        console.log('Search input listener added');
    }
    
    if (categoryFilter) {
        categoryFilter.addEventListener('change', filterEnquiries);
        console.log('Category filter listener added');
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', filterEnquiries);
        console.log('Status filter listener added');
    }
    
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            searchInput.value = '';
            categoryFilter.value = '';
            statusFilter.value = '';
            filterEnquiries();
            console.log('Filters cleared');
        });
    }
    
    // Initial filter
    filterEnquiries();

// Message expand/collapse
document.addEventListener('click', function(e) {

    // Expand message
    if (e.target.classList.contains('expand-message')) {
        const enquiryId = e.target.getAttribute('data-id');
        document.querySelector(`#message-full-${enquiryId}`).style.display = 'block';
        e.target.parentElement.style.display = 'none';
    }
    
    // Collapse message
    if (e.target.classList.contains('collapse-message')) {
        const enquiryId = e.target.getAttribute('data-id');
        document.querySelector(`#message-full-${enquiryId}`).style.display = 'none';
        document.querySelector(`#enquiry-row-${enquiryId} .message-preview`).style.display = 'block';
    }
    
    // Status update
    if (e.target.classList.contains('status-select')) {
        // Store the select element
        const select = e.target;
        
        // Add a change event listener that triggers on click away
        select.addEventListener('change', function handleChange() {
            const enquiryId = select.getAttribute('data-id');
            const newStatus = select.value;
            
            fetch(`/api/enquiries/${enquiryId}/status`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({status: newStatus})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(' ' + data.message);
                } else {
                    alert(' ' + data.message);
                }
            })
            .catch(error => {
                alert('Network error: ' + error);
            });
            
            // Remove the listener to prevent multiple calls
            select.removeEventListener('change', handleChange);
        });
    }
});

function viewEnquiry(id) {
    window.open(`/api/enquiries/${id}`, '_blank');
}

// Optional: Add some CSS for better message display
const style = document.createElement('style');
style.textContent = `
    .message-container {
        max-width: 300px;
    }
    .message-preview, .message-full {
        word-wrap: break-word;
        white-space: pre-wrap;
    }
    .expand-message, .collapse-message {
        color: #3498db;
        cursor: pointer;
        font-size: 11px;
        text-decoration: none;
    }
    .expand-message:hover, .collapse-message:hover {
        text-decoration: underline;
    }
    .message-full {
        background: #f8f9fa;
        padding: 4px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        margin-top: 5px;
    }
`;
document.head.appendChild(style);

        });
</script>

<script>
    // Apply filter button (AJAX version)
document.addEventListener('DOMContentLoaded', function() {
    // FIRST, check the actual table structure
    const table = document.getElementById('allprojectsTable');
    if (table) {
        const headerRow = table.querySelector('thead tr');
        const columns = headerRow ? headerRow.querySelectorAll('th').length : 0;
        console.log('Actual number of columns in table:', columns);
        
        // List all column headers
        if (headerRow) {
            headerRow.querySelectorAll('th').forEach((th, index) => {
                console.log(`Column ${index}:`, th.textContent.trim());
            });
        }
    }
    
    // HARD-CODED VERSION - Use the exact column indices from your table
    // Based on your columnMapping, you want to show:
    // id(0), momid(46), clientname(1), projectname(10), projectadministratorname(13), projectstartdate(14), action(47)
    // Hide everything else: indices 2-9, 11-12, 15-45
    
    window.dataTable = $('#allprojectsTable').DataTable({
        order: [[0, 'desc']],
        paging: false,
        searching: true,
        ordering: true,
        info: true,
        pageLength: 7,
        lengthChange: false,
        columnDefs: [
            // Hide columns 2-45 (everything except the 7 we want)
            { targets: [2,3,4,5,6,7,8,9,11,12,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46, 47,48,49,50,51,52,53,54,55,56,57,58], visible: false },
            // Show columns 0,1,10,13,14,47
            { targets: [0,1,10,13,14,59], visible: true }
        ]
    });
    
    console.log('DataTable initialized with column visibility settings');
    
    // Keep your filter code but FIX the reinitialization
    document.getElementById('applyFilterBtn').addEventListener('click', function() {
        const selectedMonth = document.getElementById('monthFilter').value;
        
        console.log('Applying filter for month:', selectedMonth);
        
        // Show loading
        const tableContainer = document.querySelector('.mainalldata');
        tableContainer.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading filtered projects...</p>
            </div>
        `;
        
        // Fetch filtered data
        fetch(`/get_filtered_projects/${selectedMonth}`)
            .then(response => response.json())
            .then(data => {
                console.log('Filter response received');
                
                if (data.status === 'success') {
                    tableContainer.innerHTML = data.html;
                    
                    // Check the new table structure
                    const newTable = document.getElementById('allprojectsTable');
                    if (newTable) {
                        const newHeaderRow = newTable.querySelector('thead tr');
                        const newColumns = newHeaderRow ? newHeaderRow.querySelectorAll('th').length : 0;
                        console.log('New table columns after filter:', newColumns);
                    }
                    
                    // Destroy old DataTable
                    if ($.fn.DataTable.isDataTable('#allprojectsTable')) {
                        window.dataTable.destroy();
                    }
                    
                    // Reinitialize with SAME column settings
                    window.dataTable = $('#allprojectsTable').DataTable({
                        order: [[0, 'desc']],
                        paging: false,
                        searching: true,
                        ordering: true,
                        info: true,
                        pageLength: 7,
                        lengthChange: false,
                        columnDefs: [
                            // SAME COLUMN SETTINGS
                            { targets: [2,3,4,5,6,7,8,9,11,12,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46, 47,48,49,50,51,52,53,54,55,56,57,58], visible: false },
                            { targets: [0,1,10,13,14,59], visible: true }
                        ]
                    });
                    
                    console.log('DataTable reinitialized after filter');
                } else {
                    alert('Error loading data: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to load filtered projects');
            });
    });
});


</script>
<script>
    // Password toggle for admin passcode in delete modal
    document.addEventListener('DOMContentLoaded', function() {
        const toggleAdminPassword = document.getElementById('toggleAdminPassword');
        const adminPasscodeInput = document.getElementById('adminPasscode');
        
        if (toggleAdminPassword && adminPasscodeInput) {
            toggleAdminPassword.addEventListener('click', function() {
                // Toggle password visibility
                const type = adminPasscodeInput.getAttribute('type') === 'password' ? 'text' : 'password';
                adminPasscodeInput.setAttribute('type', type);
                
                // Toggle eye icon
                if (type === 'text') {
                    this.classList.remove('bi-eye');
                    this.classList.add('bi-eye-slash');
                } else {
                    this.classList.remove('bi-eye-slash');
                    this.classList.add('bi-eye');
                }
            });
        }
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {

    const dueDateType = document.getElementById('due_date_type');
    const monthsToPay = document.getElementById('monthstopay');
    const manualInstallments = document.getElementById('manualInstallments');

    function generateManualInstallments() {
        const months = parseInt(monthsToPay.value);
        manualInstallments.innerHTML = '';


        if (!months || months <= 0) {
            alert('You need to enter a valid number of Months To Pay before you can manually set installment due dates. Kindly fix.');
            manualInstallments.style.display = 'none';
            dueDateType.value = 'auto';
            return;
        }

        for (let i = 2; i <= months; i++) {
            const wrapper = document.createElement('div');
            wrapper.className = 'col-12';

            wrapper.innerHTML = `
                <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                    <label class="col-auto col-form-label" style="padding-right: 0.5rem;">
                        Installment ${i} Due Date:
                    </label>
                    <div class="col">
                        <input type="date"
                               class="form-control editable-field"
                               name="installment_due_dates[]"
                               required>
                    </div>
                </div>
            `;

            manualInstallments.appendChild(wrapper);
        }
    }

    dueDateType.addEventListener('change', function () {
        if (this.value === 'manual') {
            manualInstallments.style.display = 'block';
            generateManualInstallments();
        } else {
            manualInstallments.style.display = 'none';
            manualInstallments.innerHTML = '';
        }
    });

    monthsToPay.addEventListener('input', function () {
        if (dueDateType.value === 'manual') {
            generateManualInstallments();
        }
    });

});
</script>

<script>
// Function to decode HTML entities (needed because we use html.escape())
function decodeHtmlEntities(text) {
    const textarea = document.createElement('textarea');
    textarea.innerHTML = text;
    return textarea.value;
}

// Handle modal show event
document.getElementById('removeUserModal').addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    
    // Extract data from button attributes
    const userId = button.getAttribute('data-user-id');
    const userNameEncoded = button.getAttribute('data-user-name') || '';
    const userEmailEncoded = button.getAttribute('data-user-email') || '';
    
    // Decode the HTML entities
    const userName = decodeHtmlEntities(userNameEncoded);
    const userEmail = decodeHtmlEntities(userEmailEncoded);
    
    // Populate modal fields
    document.getElementById('modalUserId').value = userId;
    document.getElementById('modalUserName').textContent = userName;
    document.getElementById('modalUserEmail').textContent = userEmail;
});

// Handle form submission (using your pattern)
document.getElementById("removeUserForm").addEventListener("submit", async function(e) {
    e.preventDefault(); // Stop normal form submit

    const passcode = document.getElementById("passcodeInput").value.trim();
    const userId = document.getElementById("modalUserId").value;

    // Validate passcode (use the same as your create user)
    if (passcode !== "conlink01admin01") {
        alert("Invalid Admin Permission Passcode.");
        return;
    }

    // Collect form data
    const data = {
        user_id: userId,
        passcode: passcode
    };

    // Send to Flask route
    try {
        const response = await fetch("/remove-system-user", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === "success") {
            alert("User removed successfully!");
            
            // Reset form
            this.reset();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById("removeUserModal"));
            modal.hide();
            
            // Optional: Remove the row from table or refresh page
            // location.reload(); // Refresh page
            
        } else {
            alert("Error: " + result.message);
        }

    } catch (error) {
        console.error("Request failed", error);
        alert("Failed to remove user.");
    }
});

// Optional: Clear form when modal is hidden
document.getElementById('removeUserModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('removeUserForm').reset();
    document.getElementById('modalUserId').value = '';
    document.getElementById('modalUserName').textContent = 'Loading...';
    document.getElementById('modalUserEmail').textContent = 'Loading...';
});
</script>
<script>

document.getElementById("getdepositReceiptBtn").addEventListener("click", async function(e) {
    e.preventDefault();

    const projectId = document.getElementById("updateProjectId").value; // get project ID
    const btn = this;
    const spinner = document.getElementById("depositSpinner");
    const textSpan = document.getElementById("depositText");

    // Show spinner
    btn.disabled = true;
    spinner.classList.remove("d-none");
    textSpan.textContent = "Generating...";

    try {
        const response = await fetch(`/download_deposit_receipt/${projectId}`, {
            method: 'GET'
        });

        if (!response.ok) throw new Error("Failed to generate receipt");

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Deposit_Receipt_Project_${projectId}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

    } catch (err) {
        console.error(err);
        alert(" Failed to download deposit receipt");
    } finally {
        // Hide spinner
        btn.disabled = false;
        spinner.classList.add("d-none");
        textSpan.textContent = "Get Receipt";
    }
});



</script>
<script>
document.addEventListener("DOMContentLoaded", function() {

// When "Change First Installment Due Date" button is clicked, open modal and set project ID
document.getElementById("changeInstallmentDateBtn").addEventListener("click", function() {
    const projectId = document.getElementById("updateProjectId").value; // From main modal
    document.getElementById("modalProjectId").value = projectId;

    // Optionally prefill the current first installment date
    const currentDate = document.getElementById("updateInstallment1DueDate").value;
    document.getElementById("modalNewDueDate").value = currentDate;

    // Show the modal
    var modal = new bootstrap.Modal(document.getElementById("changeInstallmentDateModal"));
    modal.show();
});

// Handle Save Changes
document.getElementById("saveNewInstallmentDateBtn").addEventListener("click", function() {
    const projectId = document.getElementById("modalProjectId").value;
    const newDate = document.getElementById("modalNewDueDate").value;
    const saveText = document.getElementById("saveDateText");
    const spinner = document.getElementById("saveDateSpinner");

    if (!newDate) {
        alert("Please select a new due date.");
        return;
    }

    // Show spinner
    spinner.classList.remove("d-none");
    saveText.textContent = "Saving...";

    fetch("/update_first_installment_date", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            project_id: projectId,
            new_date: newDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(" First installment date and all other installment dates updated successfully!");

            // Update main modal field
            document.getElementById("updateInstallment1DueDate").value = newDate;

            // Close modal
            var modalInstance = bootstrap.Modal.getInstance(document.getElementById("changeInstallmentDateModal"));
            modalInstance.hide();
        } else {
            alert(" Failed to update: " + data.message);
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert(" Error updating first installment date.");
    })
    .finally(() => {
        // Reset button text and hide spinner
        spinner.classList.add("d-none");
        saveText.textContent = "Save Changes";
    });
});
})
</script>
<script>
    var quillProjectScope = new Quill('#projectScopeEditor', {
        theme: 'snow',
        modules: {
            toolbar: '#projectScopeToolbar'
        }
    });

    // When submitting form, store Quill HTML into hidden input
    document.getElementById("addProjectForm").addEventListener("submit", function() {
        document.getElementById("project_description").value = quillProjectScope.root.innerHTML;
    });
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {

    const loaderxyz = document.getElementById("edsLoader2");
    const formxyzg = document.getElementById("updateProjectForm");

    const locations = JSON.parse(document.getElementById('locations-data').value);
    const frequencies = JSON.parse(document.getElementById('frequencies-data').value);

    const ctx = document.getElementById('projectsByLocationChart').getContext('2d');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: locations,
            datasets: [{
                label: 'Number of Projects',
                data: frequencies,
                backgroundColor: '#1E2A56', // dark blue bars
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const completed = parseInt(document.getElementById('completed-projects').value, 10) || 0;
    const ongoing = parseInt(document.getElementById('ongoing-projects').value, 10) || 0;

    const ctx = document.getElementById('leaveByTypeChart').getContext('2d');

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Completed Projects', 'Ongoing Projects'],
            datasets: [{
                data: [completed, ongoing],
                backgroundColor: ['#28a745', '#dc3545'], // green for completed, red for ongoing
                borderColor: ['#fff', '#fff'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
});
</script>

<script>

document.getElementById("downloadpaymentshistory").addEventListener("click", function () {
    const projectId = document.getElementById("updateProjectId").value;

    if (!projectId) {
        alert("Project ID missing!");
        return;
    }

    const btn = this;
    const spinner = document.getElementById("downloadSpinner");
    const text = document.getElementById("downloadText");

    // Start spinner & disable button
    spinner.classList.remove("d-none");
    text.textContent = "Preparing File...";
    btn.disabled = true;

    // Trigger file download
    window.location.href = `/download_payments_history/${projectId}`;

    // Best available solution:
    // Detect when user comes back to page after download dialog closes
    const stopSpinner = () => {
        spinner.classList.add("d-none");
        text.textContent = "Download Payments History";
        btn.disabled = false;
        window.removeEventListener("focus", stopSpinner);
    };

    // When user returns focus  assume download triggered
    window.addEventListener("focus", stopSpinner);

    // Extra safety timeout (in case browser does not blur)
    setTimeout(stopSpinner, 4000);
});
</script>

<script>

function downloadenquiries() {
    const btn = document.getElementById("exportenquiriesBtn");
    const statusFilter = document.getElementById("statusFilter")?.value || 'all';
    
    // Show spinner
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `
        <span class="spinner-border spinner-border-sm me-2"></span>
        Downloading...
    `;
    
    // Create hidden link for download with status filter
    const link = document.createElement("a");
    link.href = `/export-enquiries?status=${statusFilter}`;
    link.download = "";
    link.style.display = "none";
    document.body.appendChild(link);
    
    // Click the link to start download
    link.click();
    
    // Remove link
    document.body.removeChild(link);
    
    // Reset button after short delay
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }, 2500);
}


function downloadPortfolio() {
    const btn = document.getElementById("exportprojectportBtn");

    // Show spinner
    btn.disabled = true;
    btn.innerHTML = `
        <span class="spinner-border spinner-border-sm me-2"></span>
        Downloading...
    `;

    // Create hidden link for download
    const link = document.createElement("a");
    link.href = "/export-projects-portfolio";
    link.download = "";
    link.style.display = "none";
    document.body.appendChild(link);

    // Click the link to start download
    link.click();

    // Remove link
    document.body.removeChild(link);

    // Reset button after short delay
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = `<i class="bi bi-journal-text"></i> Download Master File`;
    }, 2500); // 2.5 seconds works well
}

</script>


<script>
document.getElementById("createUserForm").addEventListener("submit", async function (e) {
    e.preventDefault(); // Stop normal form submit

    const passcode = document.getElementById("permissionPasscode").value.trim();

    // Validate passcode
    if (passcode !== "conlink01admin01") {
        alert("Invalid Admin Permission Passcode.");
        return;
    }

    // Collect form data
    const data = {
        fullname: this.userfullname.value,
        email: this.useremail.value,
        password: this.userpassword.value,
        whatsapp: this.userwhatsapp.value
    };

    // Send to Flask route
    try {
        const response = await fetch("/create-system-user", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === "success") {
            alert("User created successfully!");
            this.reset();
            const modal = bootstrap.Modal.getInstance(document.getElementById("createUserModal"));
            modal.hide();
        } else {
            alert("Error: " + result.message);
        }

    } catch (error) {
        console.error("Request failed", error);
        alert("Failed to save user.");
    }
});
</script>

<script>

    // Add this to your existing JavaScript
$(document).ready(function() {
    // Handle Delete button click in the update modal
    $(document).on('click', '.delete-project-btn', function() {
        // Get project details from the update modal fields
        const projectId = $('#updateProjectId').val();
        const clientName = $('#updateClientName').val();
        const projectName = $('#updateProjectName').val();
        
        // Debug log to ensure we're getting the values
        console.log('Delete clicked:', { projectId, clientName, projectName });
        
        // Populate the delete modal fields
        $('#deleteProjectId').val(projectId);
        $('#updateProjectIdDelete').text(projectId); // For the display span
        $('#deleteClientNameDisplay').text(clientName);
        $('#deleteProjectNameDisplay').text(projectName);
        
        // Also populate hidden fields for form submission
        $('#deleteClientName').val(clientName);
        $('#deleteProjectName').val(projectName);
    });
    
    // Handle form submission for delete project
    $('#deleteProjectForm').submit(async function(e) {
        e.preventDefault();
        
        const btn = $('#confirmDeleteBtn');
        const btnText = $('#deleteBtnText');
        const spinner = $('#deleteSpinner');
        
        // Show loading state
        btn.prop('disabled', true);
        spinner.removeClass('d-none');
        btnText.text('Deleting...');
        
        try {
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Add admin passcode validation
            if (data.admin_passcode !== "conlink01admin01") {
                alert("Invalid admin passcode!");
                return;
            }
            
            const response = await fetch('/delete_project', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                alert(' Project deleted successfully!');
                
                // Close both modals
                $('#deleteprojectModal').modal('hide');
                $('#updateModal').modal('hide');
                
                // Refresh the page to update the table
                setTimeout(() => {
                    location.reload();
                }, 500);
                
            } else {
                alert(' Error: ' + result.message);
            }
            
        } catch (error) {
            console.error('Delete error:', error);
            alert(' Failed to delete project');
        } finally {
            // Reset button state
            btn.prop('disabled', false);
            spinner.addClass('d-none');
            btnText.text('Delete Project Permanently');
        }
    });
    
    // Clear form when delete modal is closed
    $('#deleteprojectModal').on('hidden.bs.modal', function() {
        $('#deleteProjectForm')[0].reset();
        $('#deleteClientNameDisplay').text('');
        $('#deleteProjectNameDisplay').text('');
        $('#updateProjectIdDelete').text('');
    });








    // Function to load notes for a project
    function loadNotes(projectId, projectName, clientName, clientWaNumber, clientNextOfKinNumber) {
        // Set project ID in hidden field
        $('#notesProjectId').val(projectId);        
        $('#modalProjectName').text(projectName);
        $('#modalClientName').text(clientName);
        $('#modalclientWaNumber').text(clientWaNumber);
        $('#modalclientNextOfKinNumber').text(clientNextOfKinNumber);

        // Clear the textarea
        $('#newNoteText').val('');
        
        // Show loading in notes container
        $('#notesList').html(`
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading notes...</p>
            </div>
        `);
        
        // Fetch notes from server
        $.ajax({
            url: '/get_notes/' + projectId,
            method: 'GET',
            success: function(response) {
                displayNotes(response.notes || []);
            },
            error: function() {
                $('#notesList').html(`
                    <div class="alert alert-danger">
                        Failed to load notes. Please try again.
                    </div>
                `);
            }
        });
    }

    
    // Function to display notes in the container
    function displayNotes(notes) {
        const notesList = $('#notesList');
        
        if (notes.length === 0) {
            notesList.html(`
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-journal-text display-6"></i>
                    <p class="mt-2">No notes yet. Add your first note below.</p>
                </div>
            `);
            return;
        }
        
        let notesHtml = '';
        notes.forEach((note, index) => {
            const date = new Date(note.timestamp).toLocaleString();
            notesHtml += `
                <div class="card mb-1 ${index !== 0 ? 'mt-1' : ''}" style="border-radius: 0.25rem;">
                    <div class="card-body p-1">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <span class="badge bg-light text-dark py-0 px-1" style="font-size: 0.7rem;">Note #${index + 1}</span>
                            <small class="text-muted" style="font-size: 0.65rem;">${date}</small>
                        </div>
                        <p class="card-text mb-0" style="font-size: 0.75rem; line-height: 1rem;">${escapeHtml(note.note_text)}</p>
                    </div>
                </div>
            `;
        });
        
        notesList.html(notesHtml);
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
$('#addNoteBtn').click(function() {
    const projectId = $('#notesProjectId').val();
    const noteText = $('#newNoteText').val().trim();
    const clientName = $('#modalClientName').text(); // Get client name from modal
    const projectName = $('#modalProjectName').text(); // Get project name from modal
    const clientWaNumber = $('#notesModal').data('clientWaNumber') || '';
    const clientNextOfKinNumber = $('#notesModal').data('clientNextOfKinNumber') || '';

    if (!projectId) {
        alert('No project selected');
        return;
    }
    
    if (!noteText) {
        alert('Please enter a note');
        $('#newNoteText').focus();
        return;
    }
    
    // Disable button and show loading
    const btn = $(this);
    const originalText = btn.html();
    btn.html('<span class="spinner-border spinner-border-sm me-2"></span>Adding...');
    btn.prop('disabled', true);
    
    // Send note to server
    $.ajax({
        url: '/add_note',
        method: 'POST',
        data: {
            project_id: projectId,
            note_text: noteText,
            client_name: clientName,
            project_name: projectName,
            client_wa_number: clientWaNumber,
            client_next_of_kin_number: clientNextOfKinNumber
        },
        success: function(response) {
            console.log('Response:', response);
            
            // Check if response is valid JSON and has success
            if (response && response.success === true) {
                // Clear textarea
                $('#newNoteText').val('');
                
                // Reload notes
                loadNotes(projectId, projectName, clientName, clientWaNumber, clientNextOfKinNumber);
                
                // Show success message
                alert('Note added successfully!');

            } else {
                const errorMsg = response?.message || response?.error || 'Failed to add note';
                alert('Error: ' + errorMsg);
            }
        },
        error: function(xhr, status, error) {
            console.error('AJAX Error:', status, error, xhr.responseText);
            alert('Failed to add note. Please try again.');
        }
    }).always(function() {
        // This runs whether success or error - ALWAYS RESETS THE BUTTON
        console.log('AJAX complete - resetting button');
        btn.html(originalText);
        btn.prop('disabled', false);
    });
});

    // Optional: Add keyboard shortcut (Ctrl+Enter to add note)
    $('#newNoteText').keydown(function(e) {
        if (e.ctrlKey && e.keyCode === 13) { // Ctrl + Enter
            $('#addNoteBtn').click();
        }
    });
    
    // Clear textarea when modal is hidden
    $('#notesModal').on('hidden.bs.modal', function() {
        $('#newNoteText').val('');
        $('#notesProjectId').val('');
    });
    
    // Update the notes button click handler if you removed onclick attribute
    $(document).on('click', '.notes-btn', function() {
        const $row = $(this).closest('tr');
        const rowData = window.dataTable.row($row).data();
        
        // Get data from DataTables row data (includes hidden columns)
        const projectId = rowData[46]; // Assuming 'id' is column 0
        const projectName = rowData[10]; // Assuming 'projectname' is column 10
        const clientName = rowData[1]; // Assuming 'clientname' is column 1
        const clientWaNumber = rowData[4]; // Assuming 'clientwanumber' is column 4
        const clientNextOfKinNumber = rowData[8]; // Assuming 'clientnextofkinphone' is column 8

        
        console.log('Button data:', {
            projectId, projectName, clientName, 
            clientWaNumber, clientNextOfKinNumber
        });
        
        // Store data in modal
        $('#notesModal').data('clientWaNumber', clientWaNumber);
        $('#notesModal').data('clientNextOfKinNumber', clientNextOfKinNumber);
        
        loadNotes(projectId, projectName, clientName, clientWaNumber, clientNextOfKinNumber);
    });

});
</script>

<script>
$(document).ready(function() {



    // Handle Update button click
    $(document).on('click', '.update-project-btn', function () {



        // Get the table row that contains this button
        const $row = $(this).closest('tr');
        const table = window.dataTable;
        const rowData = table.row($row).data(); // This gets ALL data including hidden

        // Get data from table cells - adjust indices based on your table structure
        // You'll need to check what column index each data is in
        const momid = rowData[0]; // First column (ID)
        const clientName = rowData[1]; // Second column (Client Name)
        const projectName = rowData[10]; // Tenth column (Project Name)
        const projectStartDateref = rowData[14]; // Tenth column (Project Name)
        const projectScope = rowData[12]; // Project Scope
        const totalcontractamount = rowData[17]; // Total Contract Amount
        const adminName = rowData[13]; // Admin Name
        const monthstopay = rowData[19]; // Months to Pay
        const completionStatus = rowData[44]; // Status
        const depositorbullet = rowData[23]; // Deposit amount
        const datedepositorbullet = rowData[24]; // Deposit date
        const installment1Amount = rowData[26]; // Installment 1 amount
        const installment1DueDate = rowData[27]; // Installment 1 due date
        const installment1Date = rowData[28]; // Installment 1 paid date
        const installment2Amount = rowData[29]; // Installment 2 amount
        const installment2DueDate = rowData[30]; // Installment 2 due date
        const installment2Date = rowData[31]; // Installment 2 paid date
        const installment3Amount = rowData[32]; // Installment 3 amount
        const installment3DueDate = rowData[33]; // Installment 3 due date
        const installment3Date = rowData[34]; // Installment 3 paid date
        const installment4Amount = rowData[35]; // Installment 4 amount
        const installment4DueDate = rowData[36]; // Installment 4 due date
        const installment4Date = rowData[37]; // Installment 4 paid date
        const installment5Amount = rowData[38]; // Installment 5 amount
        const installment5DueDate = rowData[39]; // Installment 5 due date
        const installment5Date = rowData[40]; // Installment 5 paid date
        const installment6Amount = rowData[41]; // Installment 6 amount
        const installment6DueDate = rowData[42]; // Installment 6 due date
        const installment6Date = rowData[43]; // Installment 6 paid date
        const id = rowData[46]; // First column (ID)

        // Strip HTML tags
        const plainText = projectScope.replace(/<[^>]*>/g, '');

        $('#updateCompletionStatus option[value="ph"]').text(completionStatus);

        // Debug: Check what values you're getting
        console.log('Row data:', {
            id, clientName, projectName, adminName, projectStartDateref,
            completionStatus, installment1Amount, 
            installment1DueDate
        });
        
        // Set values in the modal
        $('#updateProjectId').val(id);
        $('#updateClientName').val(clientName);
        $('#updateProjectName').val(projectName);
        $('#updateAdminName').val(adminName);
        $('#updateTotalContractAmount').val(totalcontractamount);
        $('#updateMonthsToPay').val(monthstopay);
        $('#updateProjectScope').val(plainText);
        $('#updateCompletionStatus').val(completionStatus);
        $('#updateDepositPaid').val(depositorbullet);
        $('#updateDatePaid').val(formatForDateInput(datedepositorbullet));
        
        // Installment 1 dates
        $('#updateInstallment1Amount').val(installment1Amount);
        $('#updateInstallment1DueDate').val(formatForDateInput(installment1DueDate));
        $('#updateInstallment1Date').val(formatForDateInput(installment1Date));
        
        // Installment 2 dates
        $('#updateInstallment2Amount').val(installment2Amount);
        $('#updateInstallment2DueDate').val(formatForDateInput(installment2DueDate));
        $('#updateInstallment2Date').val(formatForDateInput(installment2Date));
        
        // Installment 3 dates
        $('#updateInstallment3Amount').val(installment3Amount);
        $('#updateInstallment3DueDate').val(formatForDateInput(installment3DueDate));
        $('#updateInstallment3Date').val(formatForDateInput(installment3Date));
        
        // Installment 4 dates
        $('#updateInstallment4Amount').val(installment4Amount);
        $('#updateInstallment4DueDate').val(formatForDateInput(installment4DueDate));
        $('#updateInstallment4Date').val(formatForDateInput(installment4Date));
        
        // Installment 5 dates
        $('#updateInstallment5Amount').val(installment5Amount);
        $('#updateInstallment5DueDate').val(formatForDateInput(installment5DueDate));
        $('#updateInstallment5Date').val(formatForDateInput(installment5Date));
        
        // Installment 6 dates
        $('#updateInstallment6Amount').val(installment6Amount);
        $('#updateInstallment6DueDate').val(formatForDateInput(installment6DueDate));
        $('#updateInstallment6Date').val(formatForDateInput(installment6Date));
                        
        function formatForDateInput(dateText) {
            if (!dateText || dateText === 'None' || dateText === 'null') return '';
            
            // Handle "20 January 2026" format
            const monthMap = {
                'january': '01', 'february': '02', 'march': '03',
                'april': '04', 'may': '05', 'june': '06',
                'july': '07', 'august': '08', 'september': '09',
                'october': '10', 'november': '11', 'december': '12'
            };
            
            // Parse "20 January 2026"
            const parts = dateText.toLowerCase().split(' ');
            
            if (parts.length === 3) {
                const day = parts[0].padStart(2, '0');
                const month = monthMap[parts[1]] || '01';
                const year = parts[2];
                
                // Format as YYYY-MM-DD for date input
                return `${year}-${month}-${day}`;
            }
            
            // If it's already in some other format, try to parse
            return dateText;
        }

        $('#updateProjectStartDate').val(formatForDateInput(projectStartDateref));
        // Show the modal
        $('#updateModal').modal('show');
    });
    
    // Rest of your save handler...
});
</script>

<script>

function handleDownloadClick(button) {
    const originalText = button.textContent;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Downloading...';
    button.disabled = true;

    // Trigger download
    const downloadUrl = button.dataset.url; // e.g., /download_contract/123
    window.location.href = downloadUrl;

    // Fallback: remove spinner after 3 seconds (UI only)
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 3000);
}


</script>

<script>
document.getElementById("saveAdminBtn").addEventListener("click", function () {

    const name = document.getElementById("adminName").value.trim();
    const phone = document.getElementById("adminPhone").value.trim();

    if (!name || !phone) {
        alert("Please fill in all fields");
        return;
    }

    // Show loader + disable button
    document.getElementById("saveText").classList.add("d-none");
    document.getElementById("saveLoader").classList.remove("d-none");
    document.getElementById("saveAdminBtn").disabled = true;

    fetch("/addadmin", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            adminName: name,
            adminPhone: phone
        })
    })
    .then(response => response.json())
    .then(data => {

        // Hide loader, restore button
        document.getElementById("saveText").classList.remove("d-none");
        document.getElementById("saveLoader").classList.add("d-none");
        document.getElementById("saveAdminBtn").disabled = false;

        if (data.status === "success") {

            alert("Administrator added!");

            const modal = bootstrap.Modal.getInstance(document.getElementById("addAdminplusModal"));
            modal.hide();

            location.reload();

        } else {
            alert("Error: " + data.message);
        }

    })
    .catch(error => {

        // Hide loader, restore button if an error occurs
        document.getElementById("saveText").classList.remove("d-none");
        document.getElementById("saveLoader").classList.add("d-none");
        document.getElementById("saveAdminBtn").disabled = false;

        alert("Request failed: " + error);
    });
});
</script>


<script>
document.getElementById("saveProjectBtn").addEventListener("click", function () {

    // ----------------------------------------------------
    // 1. Perform your custom checks before submitting
    // ----------------------------------------------------

    const clientName = document.getElementById("client_name").value.trim();
    const clientID = document.getElementById("client_national_id").value.trim();
    const clientWHATSAPP = document.getElementById("client_whatsapp_number").value.trim();
    const projectName = document.getElementById("project_name").value.trim();
    const paymentMethod = document.getElementById("paymentMethod").value;
    const projectadmin = document.getElementById("projectadministrator").value.trim();
    const lateinterest = document.getElementById("late_payment_interest").value.trim();
    
    // Additional required fields validation
    const clientAddress = document.getElementById("client_address").value.trim();
    const clientEmail = document.getElementById("client_email").value.trim();
    const nextOfKinName = document.getElementById("next_of_kin_name").value.trim();
    const nextOfKinAddress = document.getElementById("next_of_kin_address").value.trim();
    const nextOfKinContact = document.getElementById("next_of_kin_contact_number").value.trim();
    const relationship = document.getElementById("relationship").value.trim();
    const projectLocation = document.getElementById("project_location").value.trim();
    const projectStartDate = document.getElementById("project_start_date").value;
    const projectDuration = document.getElementById("months_to_completion").value.trim();
    const agreementDate = document.getElementById("agreement_date").value;
    const totalContractPrice = document.getElementById("total_contract_price").value.trim();

    const quillContent = quillProjectScope.root.innerHTML.trim();
    const isEmptyQuillContent = quillContent === '<p><br></p>' || quillContent === '<p></p>' || quillContent === '';

    // When submitting form, store Quill HTML into hidden input
// Insert Quill content into hidden input BEFORE building formData

if (clientName === "" || clientID === "" || clientWHATSAPP === "" || clientAddress === "") {
        alert("All client details (Name, ID, WhatsApp, Address, Email) are required.");
        return; // STOP submission
    }

    // Project details validation
    if (projectName === "" || projectLocation === "" || projectStartDate === "" || projectDuration === "" || projectadmin === "") {
        alert("All project details (Name, Location, Start Date, Duration, Administrator) are required.");
        return; // STOP submission
    }

    // Project scope validation
    if (isEmptyQuillContent) {
        alert("Project Scope/Description is required.");
        return; // STOP submission
    }

    // Agreement date validation
    if (agreementDate === "") {
        alert("Contract Agreement Date is required.");
        return; // STOP submission
    }

    if (totalContractPrice === "" || parseFloat(totalContractPrice) <= 0) {
        alert("Valid Total Contract Price is required.");
        return; // STOP submission
    }
    // Payment method validation
    if (paymentMethod === "") {
        alert("Select a payment method.");
        return; 
    }



    // Total contract price validation


    // Payment method specific validations
    if (paymentMethod === "Installments") {
        let months = document.getElementById("monthstopay").value;
        if (months === "" || months <= 0) {
            alert("Months To Pay must be greater than 0.");
            return;
        }
        
        // Check for late interest for installments
        if (lateinterest === "" || parseFloat(lateinterest) < 0) {
            alert("Late Payment Interest is required for Installments.");
            return;
        }
        
        // Check deposit fields
        const depositRequired = document.getElementById("deposit_required").value.trim();
        const depositPaymentDate = document.getElementById("deposit_payment_date").value;
        const firstInstallmentDueDate = document.getElementById("first_installment_due_date").value;
        
        if (depositRequired === "" || parseFloat(depositRequired) < 0) {
            alert("Deposit Paid amount is required.");
            return;
        }
        
        if (depositPaymentDate === "") {
            alert("Date Deposit Paid is required.");
            return;
        }
        
        if (firstInstallmentDueDate === "") {
            alert("Due Date For First Installment is required.");
            return;
        }

    }

    
    document.getElementById("project_description").value = quillProjectScope.root.innerHTML;

    // ----------------------------------------------------
    // 2. Build FormData object and send to Flask route
    // ----------------------------------------------------
    let form = document.getElementById("addProjectForm");
    let formData = new FormData(form);
    document.getElementById("edsLoader").style.display = "flex";

    fetch("/contract_log", {
        method: "POST",
        body: formData
    })
    .then(async response => {

        // If server returned JSON error 
        if (!response.ok) {
            let errorText = await response.text();
            console.error("Server error:", errorText);
            alert(" Failed to save: " + errorText);
            document.getElementById("edsLoader").style.display = "none";
            throw new Error("Server returned an error");
        }

        // If Flask redirected normally = success
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }

        return response.text();
    })
    .then(data => {
        console.log("Server response:", data);
        alert(" Project saved successfully!");
        document.getElementById("edsLoader").style.display = "none";
    })
    .catch(error => {
        console.error("Error:", error);
        alert(" There was an error saving the project.");
        document.getElementById("edsLoader").style.display = "none";
    });


});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('view-project-btn')) {

            const projectId = e.target.getAttribute('data-id');

            // Fetch project details from backend
            fetch(`/get_project/${projectId}`)
            .then(response => response.json())
            .then(data => {

                // Define the exact order you want
                const fieldOrder = [
                    "id",
                    "datecaptured",
                    "capturer",
                    "capturerid",
                    "clientname",
                    "clientidnumber",
                    "clientaddress",
                    "clientwanumber",
                    "clientemail",
                    "clientnextofkinname",
                    "clientnextofkinaddress",
                    "clientnextofkinphone",
                    "nextofkinrelationship",
                    "projectname",
                    "projectlocation",
                    "projectdescription",
                    "projectadministratorname",
                    "projectstartdate",
                    "projectduration",
                    "contractagreementdate",
                    "totalcontractamount",
                    "latepaymentinterest",
                    "paymentmethod",
                    "monthstopay",
                    "depositorbullet",
                    "datedepositorbullet",
                    "monthlyinstallment",
                    "installment1amount",
                    "installment1duedate",
                    "installment1date",
                    "installment2amount",
                    "installment2duedate",
                    "installment2date",
                    "installment3amount",
                    "installment3duedate",
                    "installment3date",
                    "installment4amount",
                    "installment4duedate",
                    "installment4date",
                    "installment5amount",
                    "installment5duedate",
                    "installment5date",
                    "installment6amount",
                    "installment6duedate",
                    "installment6date",
                    "projectcompletionstatus"
                ];

                // Get the table body
                const tbody = document.getElementById('projectDetailsBody');
                tbody.innerHTML = ''; // Clear old data

                // Build rows in the exact order defined above
                fieldOrder.forEach(key => {
                    if (data[key] !== undefined) {

                        const row = document.createElement('tr');

                        row.innerHTML = `
                            <th style="width: 30%; text-transform: capitalize;">
                                ${key.replace(/_/g, ' ')}
                            </th>
                            <td>${data[key] === null ? "" : data[key]}</td>
                        `;

                        tbody.appendChild(row);
                    }
                });

            })
            .catch(err => {
                alert('Failed to fetch project details: ' + err);
            });

        }
    });


        // Delegate click events for dynamically generated buttons
    document.querySelector('#alladminsTable').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-admin-btn')) {
            const adminId = e.target.getAttribute('data-ID');

            if (!confirm("Are you sure you want to remove this administrator?")) {
                return;
            }

            fetch('/removeadmin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: adminId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Administrator removed!');
                    // Optionally remove the row from table
                    e.target.closest('tr').remove();
                    location.reload();

                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Request failed: ' + error);
            });
        }
    });

 
});





</script>

<script>
    const paymentMethod = document.getElementById('paymentMethod');
    const paymentSchedule = document.getElementById('paymentschedule');
    const bulletpaymentdate = document.getElementById('bullet_payment_date');
    const depositRequired = document.getElementById('deposit_required');
    const totalContractPrice = document.getElementById('total_contract_price');

    paymentMethod.addEventListener('change', function() {
        if (this.value === 'Installments') {
            paymentSchedule.style.display = 'block';
            bulletpaymentdate.style.display = 'none';

            const total = parseFloat(totalContractPrice.value);
            if (!isNaN(total)) {
                depositRequired.value = (total * 0.3).toFixed(2);
            } else {
                depositRequired.value = '';
            }

        } else {
            paymentSchedule.style.display = 'none';
            bulletpaymentdate.style.display = 'block';
        }
    });


</script>

<script>

$(document).ready(function () {

    $('#saveaccumulators').click(function () {
        let updates = [];
        const companyname = $('#company_name').val().trim();  // Get the company name from the hidden input

        // Check if company name is empty
        if (!companyname) {
            alert("Company name is required.");
            return;  // Prevent further execution if company name is missing
        }

        // Gather data from the table
        $('#employeesaccumulatorsTable .editable-field').each(function () {
            let $field = $(this);
            let id = $field.data('id'); // Employee ID
            let newValue = parseFloat($field.val()); // New value entered

            // Check if the ID and value are valid before adding to updates
            if (id && !isNaN(newValue)) {
                updates.push({ id: id, accumulated_days: newValue });
            } else {
                console.error("Invalid data-id or value for field:", $field);
            }
        });

        // Check if updates array is empty (no valid data to send)
        if (updates.length === 0) {
            alert("No valid data to update.");
            return;  // Prevent sending the request if no valid data
        }
        $('#edsLoader').show();  // Show loading overlay immediately

        // Send updates to the server
        $.ajax({
            url: '/update_accumulators',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ updates: updates, companyname: companyname }),
            success: function (response) {

                $('#editLeaveDaysAccumulatorModal').modal('hide');  // Hide the modal after success
                $('#edsLoader').hide();  // Show loading overlay immediately
                setTimeout(function() {
                    alert(response.message);  // Show alert after the overlay
                }, 100);  // 100ms delay to ensure UI update before alert
                location.reload();  // Reload the table to reflect changes
            },
            error: function () {
                alert('Error updating Accumulators.');
            }
        });
    });
});



$('#btn-dashboard').click(function() {
        $('#dashboard-tab').tab('show');
    });

$('#btn-leave-apps-portal').click(function() {
    $('#projects-tab').tab('show');
});

$('#closepriv').on('click', function() {
    $('#editModalpriv').modal('hide'); 
});

$('#closeapprover').on('click', function() {
    $('#editModalapprover').modal('hide'); 
});

$('#closeaccumulators').on('click', function() {
    $('#editLeaveDaysAccumulatorModal').modal('hide'); 
});

$('#cancel_add_emplyee_manual').on('click', function() {
    $('#manualaddemployeeModal').modal('hide'); 
});



$('#savedepartmentconfirm').on('click', function() {
    var newdepartment = $('#department-emp').val();  // Get the selected role
    var companyname = $('#company_name').val();  // Get the company name from the hidden input

    if (!newdepartment || !companyname) {
        alert("Please fill in all required fields.");
        return;  // Prevent further execution if fields are empty
    }

    $('#edsLoader').show();

    
    if (newdepartment) {
        // Send the data to the Flask endpoint
        $.ajax({
            url: '/update_department',  // Change to your desired endpoint
            method: 'POST',
            data: {
                department: newdepartment,
                currentId: currentIdeditdepartment,  // Include the currentId in the request
                companyname: companyname  // Include the company_name in the request
            },
            success: function(response) {
                // Handle the response from Flask (e.g., show success message or refresh data)
                $('#editModaldepartment').modal('hide');  // Hide the modal after success
                $('#edsLoader').hide();

                setTimeout(function() {
                    alert('Department updated successfully.');
                }, 100);  // 100ms delay to ensure UI update before alert
                location.reload();  
            },
            error: function(xhr, status, error) {
                // Handle any errors (e.g., alert user)
                alert('Error: ' + error);
            }
        });
    } else {
        // If no role is selected
        alert("Please select a department before saving.");
    }
});


async function downloadLeaveApp(appId) {
    const btn = document.querySelector(`button[data-id="${appId}"]`);
    const originalText = btn.innerHTML;
    // Find the <tr> where the button is located
    const row = btn.closest('tr');

    // Find the full name from the "Employee Name" column
    // You can improve this by assigning a class to that <td> (e.g., <td class="employee-name">)
    const nameCell = Array.from(row.cells).find(cell =>
        cell.textContent.trim() && !cell.querySelector('button') && isNaN(cell.textContent.trim())
    );

    const fullName = nameCell ? nameCell.textContent.trim() : 'Unknown_Name';
    
    try {
        // 1. Show loading state
        btn.disabled = true;
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Generating...';

        // 2. Fetch PDF
        const response = await fetch(`/download_leave_app/${appId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        // 3. Check content type (ensure it's PDF)
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/pdf')) {
            throw new Error('Invalid content type - expected PDF');
        }

        // 4. Create download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `leave_application_${fullName}_${appId}.pdf`;
        document.body.appendChild(a);
        a.click();

        // 5. Cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

    } catch (error) {
        console.error('Download failed:', error);
        btn.innerHTML = '<i class="fa fa-exclamation-circle"></i> Failed - Retry';
        // Optional: Show user-friendly alert
        alert(`Download failed: ${error.message}`);
    } finally {
        // 6. Reset button (even if success or error)
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}





document.addEventListener('DOMContentLoaded', () => {
    const modals = document.querySelectorAll('.modal');
    const mainContent = document.querySelector('body > *:not(.modal)'); // Select all content outside modals

    modals.forEach(modal => {
        modal.addEventListener('show.bs.modal', () => {
            // Add inert to main content when modal is open
            mainContent.setAttribute('inert', '');
        });

        modal.addEventListener('hidden.bs.modal', () => {
            // Remove inert from main content when modal is closed
            mainContent.removeAttribute('inert');
        });
    });



    document.getElementById('formatexcellmsbookexport').addEventListener('click', () => {
            window.location.href = '/export_lms_book_excel';
        });

    document.getElementById('formatpdflmsbookexport').addEventListener('click', () => {
        window.location.href = '/export_lms_book_pdf';
    });

  });




  </script>
<script>
    $(document).ready(function () {

        $('#alladminsTable').DataTable({
            paging: true,    // Enable pagination
            searching: true, // Enable search
            ordering: true,  // Enable sorting
            info: true,      // Show table information
            pageLength: 8,       // Force max 5 entries per page
            lengthChange: false, // Disable entries per page dropdown
        });

        $('#allpaymentscdTable').DataTable({
            paging: false,    // Enable pagination
            searching: true, // Enable search
            ordering: true,  // Enable sorting
            info: true,      // Show table information
        });



        $('#allenquiriesTable').DataTable({
            paging: false,    // Enable pagination
            searching: true, // Enable search
            ordering: true,  // Enable sorting
            info: true,      // Show table information
            pageLength: 8,       // Force max 5 entries per page
            lengthChange: false, // Disable entries per page dropdown
        });

    });








</script>



</body>
</html>
