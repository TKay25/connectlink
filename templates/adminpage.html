<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ConnectLink Admin System</title>
        <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/reqlogo.jpg') }}">
        <meta name="mobile-web-app-capable" content="yes">
        <!-- <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/eds blue.png') }}"> -->
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
        <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
        <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
        <style>
        /* Main Styling */
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(to right, #f0f2f5, #e9f1fb);
            margin: 0;
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }

        /* Sidebar Styling */
        .sidebar {
            width: 250px;
            background-color: #1E2A56;
            color: #fff;
            padding-top: 40px;
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.2);
            transition: width 0.3s;
        }

        #editinfocompModal {
            z-index: 1061 !important;
        }

        .modal-backdrop.show:nth-of-type(2) {
            z-index: 1060 !important;
        }

        .sidebar:hover {
            width: 270px;
        }

        .sidebar h5 {
            font-weight: bold;
            margin-bottom: 30px;
            font-size: 1.2rem;
        }

        .sidebar img {
            max-width: 150px;
            margin-bottom: 20px;
        }

        .sidebar .btn {
            color: #1E2A56;
            background-color: #fff;
            width: 150px;
            margin: 5px 0;
            padding: 8x;
            border: 3px solid #1E2A56;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: background 0.3s;
            text-align: center;
            font-weight: 600;
        }

        .sidebar .btn:hover {
            background-color: #1E2A56;
            color: #fff;
            border: 3px solid white;
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-danger-2{
            color: white;
            background-color: red;
            width: max-content;
            margin: 2px 2px;
            padding: 2px;
            border-radius: 8px;
            border: 3px solid red;
            font-size: 0.7rem;
            transition: background 0.3s;
            text-align: center;
            font-weight: 500;

        }
        .btn-danger-2:hover{
            background-color: white;
            color: red;
            border: 3px solid red;
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
        }



        .btn-primary{
            color: white;
            background-color: #1E2A56;
            width: 15%;
            margin: 8px 0;
            padding: 5px;
            border-radius: 8px;
            border: 3px solid #1E2A56;
            font-size: 0.9rem;
            transition: background 0.3s;
            text-align: center;
            font-weight: 500;

        }
        .btn-primary:hover{
            background-color: white;
            color: #1E2A56;
            border: 3px solid #1E2A56;
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-primary10{
            color: #1E2A56;
            background-color: white;
            width: 15%;
            margin: 8px 0;
            padding: 5px;
            border-radius: 8px;
            border: 3px solid #1E2A56;
            font-size: 0.9rem;
            transition: background 0.3s;
            text-align: center;
            font-weight: 600;

        }
        .btn-primary10:hover{
            background-color: #e9f1fb;
            color: #1E2A56;
            border: 3px solid #1E2A56;
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-primary2{
            color: white;
            background-color: #1E2A56;
            width: 37%;
            margin: 8px 0;
            padding: 6px;
            border-radius: 8px;
            border: 3px solid #1E2A56;
            font-size: 0.9rem;
            transition: background 0.3s;
            text-align: center;
            font-weight: 500;

        }
        .btn-primary2:hover{
            background-color: white;
            color: #1E2A56;
            border: 3px solid #1E2A56;
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-primary9{
            color: white;
            background-color: #1E2A56;
            margin: 8px 0;
            padding: 5px;
            border-radius: 8px;
            border: 3px solid #1E2A56;
            transition: background 0.3s;
            text-align: center;
            font-weight: 500;

        }
        .btn-primary9:hover{
            background-color: white;
            color: #1E2A56;
            border: 3px solid #1E2A56;
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-primary3{
            color: white;
            background-color: #1E2A56;
            width: 100%;
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 1px;
            padding-bottom: 1px;
            border-radius: 8px;
            border: 3px solid #1E2A56;
            font-size: 14px;
            transition: background 0.3s;
            text-align: center;
            font-weight: 500;

        }
        .form-control-blue {
            background-color: #1E2A5611; /* Example */
            border: 1px solid #ccc;
            appearance: auto; /* Ensure native dropdown appearance */
            padding: 8px 12px;
        }


        .btn-primary3:hover{
            background-color: white;
            color: #1E2A56;
            border: 3px solid #1E2A56;
        }

        /* Main Content Styling */
        .main-content {
            margin-left: 270px;
            padding: 30px;
            width: calc(100% - 270px);
            background-color: #ffffff;
            min-height: 100vh;
        }


        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px;
            background-color: #e9f1fb;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 10px;
        }

        .current-date {
            color: #1E2A56;
            font-weight: bold;
            font-size: smaller;
            font-size: 14px;
        }

        .employeetag {
            color: #1E2A56;;
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;

        }

        /* Tab Styling */
        .nav-tabs .nav-link {
            color: #1E2A56;
            font-weight: 600;
            padding: 10px 20px;
            font-size: 15px;
            border-radius: 8px 8px 0 0;
            background: #e9f1fb;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            color: #ffffff;
            background-color: #1E2A56;
            font-weight: 800;
        }

        /* Card Styling */
        .card {
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
            background-color: #ffffff;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-content {
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            }
        .modal-header{
            background-color: #1E2A56;
            color: white;
            font-weight: bolder;
        }
        .form-group {
            margin-bottom: 20px; /* Increase vertical spacing between fields */
            }

        .btn-center {
            display: flex;
            justify-content: center;
            justify-content: space-between; 
            gap: 10px;
            }

        .form-control-blue::after {
            content: '\25BC'; /* Unicode for downwards triangle */
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white; /* Arrow color */
            font-size: 18px;
        }

        /* Style for disabled option (making it grey) */
        .form-control-blue option:disabled {
            background-color: #A9A9A9; /* Grey background */
            color: #D3D3D3; /* Grey text color */
        }

        .table-theme {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto; /* Allow columns to adjust based on content */
        }

        .table-theme th {
            background-color: #1E2A56;
            color: white;
            text-align: center !important;
            vertical-align: middle !important;
            padding: 2px;
            font-weight: bold;
            white-space: nowrap; /* Prevent text wrapping */
        }

        #employeesTable th,
        #employeespayrollTable th, 
        #employeespersonalTable th,
        #employeesaccumulatorsTable th, 
        #employeesbulk1Table th, 
        #employeesbulkbalancesTable th, 
        #removeemployeesTable th {
            position: sticky;
            top: 0;
            z-index: 1;
        }


        .table-theme td {
            font-weight: 500;
            padding: 0px;
            color: #1E2A56;
            text-align: center;
            white-space: nowrap; /* Prevent text wrapping */
            border-bottom: 1px solid #ddd;
        }


        .container2 {
            font-size: 13px;
            margin-top: -2rem;
        }
        /* Custom scrollbar styling */
        .container2::-webkit-scrollbar {
            width: 12px; /* Width of the scrollbar */
        }

        .container2::-webkit-scrollbar-thumb {
            background-color: #1E2A56; /* Scrollbar thumb color */
            border-radius: 5px; /* Rounded corners for thumb */
        }

        .container2::-webkit-scrollbar-thumb:hover {
            background-color: #e9f1fb;
            box-shadow: inset 0 0 0 3px #1E2A56; /* Simulates a border */
        }

        .container2::-webkit-scrollbar-track {
            background-color: #f0f0f0; /* Scrollbar track color */
            border-radius: 5px; /* Rounded corners for track */
        }
        .form-group label{
            font-weight: bold;
        }
        /* For WebKit-based browsers (Chrome, Edge, Safari) */
        #employeeList::-webkit-scrollbar {
            width: 15px; /* Width of the scrollbar */
        }

        #employeeList::-webkit-scrollbar-thumb {
            background-color: #1E2A56; /* Blue color for the scrollbar handle */
            border-radius: 5px; /* Rounded scrollbar handle */
        }

        #employeeList::-webkit-scrollbar-track {
            background-color: #f1f1f1; /* Background color of the scrollbar track */
        }

        /* For Firefox */
        #employeeList {
            scrollbar-color: #1E2A56 #f1f1f1; /* Handle color followed by track color */
        }
        select.form-control-blue option:hover {
            background-color: #e6f0ff; /* Light blue on hover */
            color: #1E2A56; /* Dark blue text */
        }
        /* Style the close button */
        .modal-header .btn-close {
            width: 1rem;      /* default is ~1.5rem */
            height: 1rem;     /* default is ~1.5rem */
            padding: 0.25rem; /* reduce padding to shrink clickable area */
            font-size: 0.75rem; 
            font-weight: bolder;
            background-color: white; /* Makes the background white */
            color: #1E2A56; /* Change the icon color to black */
            opacity: 1; /* Ensure the button is fully opaque */
        }

        /* Optional: Hover effect */
        .modal-header .btn-close:hover {

            background-color: #f8f9fa; /* Light grey background on hover */
            color: #000; /* Ensure the icon stays black on hover */
            opacity: 1; /* Ensure full opacity on hover */
        }
        .modal-footer{
            gap: 10px;
        }

        /* Default background color for editable fields */
        .editable-field {
            border-radius: 8px;
            background-color: #e6f0ff; /* Light blue when not being edited */
            border: rgba(0, 0, 0, 0.2) solid #4655AC; /* Light border */
            transition: background-color 0.3s ease;
        }

        /* Background color when the field is focused (being edited) */
        .editable-field:focus {
            background-color: #1E2A56; /* Change to light yellow when being edited */
            color: white; /* Dark blue border when focused */
            outline: none; /* Remove the default outline */
        }

        /* Style the checkboxes */
        .custom-checkbox {
            width: 25px; /* Make the checkbox bigger */
            height: 25px; /* Make the checkbox bigger */
            background-color: #e6f0ff; /* Dark blue background */
            border-radius: 8px; /* Optional: round the corners */
            border: 3px solid #1E2A56; /* Dark blue border */
            appearance: none; /* Remove default checkbox style */
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .custom-checkbox:checked {
            background-color: #1E2A56; /* Dark blue when checked */
            border-color: #1E2A56; /* Dark blue border when checked */
        }

        .custom-checkbox:checked::after {
            content: '\2713'; /* Checkmark symbol */
            position: absolute;
            top: 0;
            left: 4px; /* Adjust position of the checkmark */
            color: white; /* White color for the checkmark */
            font-size: 15px; /* Make the checkmark larger */
        }

        #removeemployeesTable input[type="checkbox"] {
            margin-right: 10px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Semi-transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            font-size: 18px;
            z-index: 9999;
        }

        .loading-spinner {
            border: 8px solid #f3f3f3; /* Light grey background color */
            border-top: 8px solid #1E2A56; /* Blue spinner color */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        .uppercase-text {
        text-transform: uppercase;
        }

        .form-select {
            padding: 5px 10px;
            font-size: 0.9rem;
            border-radius: 10px;
            border: 3px solid  #1E2A56;
            font-weight: 800;
            outline: none;
            color:#1E2A56;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);

        }
        /* Black overlay */
        .dropdown-overlay {
            position: fixed;  /* Covers the entire screen */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7); /* Black with 70% opacity */
            z-index: 10; /* Ensure it appears above everything */
            display: none; /* Initially hidden */
        }

        .dropdown-overlayxx {
            position: fixed;  /* Covers the entire screen */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7); /* Black with 70% opacity */
        }


        .dropdown-menu .dropdown-item {
        color: #1E2A56;
        font-weight: 500;
        }
        .dropdown-menu .dropdown-item:hover {
            background-color: #1E2A56; /* Dark blue background on hover */
            color: white; /* White text color on hover */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition */
            cursor: pointer;
        }
        .otherleave{
            display: none;
        }



        .modal-body{
            color: #1E2A56;
        }
        #chartContainer {
            margin-top: 20px;
            width: 230px;  /* Reduce chart size */
        }
        .dropdownfilter {
            position: relative;
            display: inline-block;
        }
        .dropdownfilter-toggle {
            background-color: #1E2A56;
            color: white;
            padding: 2px 12px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-weight: 500;
        }
        .dropdownfilter-content {
            display: none;
            position: absolute;
            background-color: white;
            box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
            z-index: 1;
            padding: 3px;
            border-radius: 5px;
        }
        .dropdownfilter-content label {
            display: block;
            margin-bottom: 5px;
            cursor: pointer;
            color: #1E2A56;
        }
        .dropdownfilter:hover .dropdownfilter-content {
            display: block;
        }

        /* Main loader layout */
        .eds-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);

            display: flex;
            flex-direction: column;
            justify-content: center;   /* vertical center */
            align-items: center;       /* horizontal center */
            gap: 25px;                 /* clean spacing */

            z-index: 9999;
            font-family: 'Century Gothic', sans-serif;
            text-align: center;
            padding: 20px;
        }

        /* Logo section */
        .eds-logo {
            color: white;
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #1E2A56;
        }

        /* Tagline text */
        .eds-tagline {
            color: #fff;
            font-size: 0.8rem;   /* increased for readability */
            opacity: 0.8;
            margin: 0;
        }

        /* Loader bar */
        .loader-bar {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
            margin-top: 5px;
        }

        .loader-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, white, #1E2A56);
            animation: load 3s ease-in-out infinite;
            border-radius: 2px;
        }

        @keyframes load {
            0%   { width: 0%; left: 0; }
            50%  { width: 100%; left: 0; }
            100% { width: 0%; left: 100%; }
        }

        /* Pulsing grid */
        .eds-grid {
            display: grid;
            grid-template-columns: repeat(4, 20px);
            gap: 10px;
            margin-top: 10px;
        }

        .grid-item {
            width: 20px;
            height: 20px;
            background: rgba(0, 255, 252, 0.25);
            animation: pulse 1.5s ease-in-out infinite;
            border-radius: 3px; /* optional visual improvement */
        }

        .grid-item:nth-child(1) { animation-delay: 0s; }
        .grid-item:nth-child(2) { animation-delay: 0.2s; }
        .grid-item:nth-child(3) { animation-delay: 0.4s; }
        .grid-item:nth-child(4) { animation-delay: 0.6s; }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.2;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
                background: #336699;
            }
        }




        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 4 columns */
            gap: 20px;
            margin-top: 20px;
        }

        .summary-card {
            flex: 1 1 calc(33.33% - 10px);
            background-color: #f0f4f8;
            padding: 4px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            font-size: 10px;
        }

        .summary-card .icon {
            font-size: 15px;
            margin-right: 10px;
        }

        .summary-card .details h5 {
            margin: 0;
            font-size: 13px;
            color: #1E2A56;
        }

        .summary-card .details p {
            margin: 0;
            font-size: 14px;
            font-weight: bold;
        }

        .dashboard-graphs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .graph-card {
            background-color: #ffffff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-size: 12px;
        }

        .graph-card h6 {
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: bold;
            color: #1E2A56;
        }

        .sidebar .accordion-button {
            background-color: #f8f9fa;
            border-radius: 0 !important;
            box-shadow: none;
            cursor: pointer;
        }

        .sidebar .accordion-button:hover {
            background-color: #e9ecef;
        }

        .sidebar .accordion-item {
            border-radius: 0 !important;
        }

        .sidebar .list-group-item {
            border-radius: 0 !important;
            border-left: none;
            border-right: none;
            font-size: 0.95rem;
        }

        /* Remove default Bootstrap accordion arrow for this item */
        .accordion-item:has(.bi-people-fill) .accordion-button::after, .accordion-item:has(.bi-wallet-fill) .accordion-button::after {
            display: none;
        }

        /* Add this to your existing CSS section */

        #addnewProjectModal .modal-body {
            font-size: 0.8rem; /* Reduced from default 1rem */
        }

        #addnewProjectModal .form-group label {
            font-size: 0.8rem; /* Smaller label text */
            font-weight: 600; /* Keep it bold but smaller */
        }

        #addnewProjectModal .form-control,
        #addnewProjectModal .form-control-blue,
        #addnewProjectModal select.form-control-blue {
            font-size: 0.8rem; /* Smaller input text */
            padding: 0.4rem 0.7rem; /* Adjust padding proportionally */
        }

        #addnewProjectModal .card h6 {
            font-size: 0.9rem; /* Smaller card header text */
            padding: 0.5rem; /* Adjust padding */
        }

        #addnewProjectModal textarea.form-control {
            font-size: 0.8rem; /* Smaller textarea text */
        }

        #addnewProjectModal .form-group.row {
            margin-bottom: 0.7rem; /* Reduce spacing between rows */
        }

        #addnewProjectModal .col-auto.col-form-label {
            padding-right: 0.2rem; /* Reduce label padding */
        }

        #addnewProjectModal .modal-title {
            font-size: 1rem; /* Smaller modal title */
        }

        /* Make the modal slightly more compact overall */
        #addnewProjectModal .card {
            padding: 8px; /* Reduce card padding */
        }

        #addnewProjectModal .modal-dialog {
            max-width: 85%; /* Optionally adjust modal width */
        }

        /* Add this to your existing CSS */
        #addnewProjectModal .modal-content {
            height: 90vh; /* Set a maximum height for the modal */
            display: flex;
            flex-direction: column;
        }

        #addnewProjectModal .modal-header,
        #addnewProjectModal .modal-footer {
            flex-shrink: 0; /* Prevent header and footer from shrinking */
        }

        #addnewProjectModal .modal-body {
            overflow-y: auto; /* Make the body scrollable */
            max-height: calc(90vh - 120px); /* Adjust based on header/footer height */
            padding: 15px;
        }

        #addnewProjectModal .modal-dialog {
            max-width: 80%;
            margin: 1.7rem auto;
        }

    </style>
</head>

<body>
    <div class="eds-loader" id="edsLoader" style="display: none;">
        <div class="eds-logo"><img src="{{ url_for('static', filename='images/web-logo-white.png') }}"  alt="Logo" class="logo" style="width: 200px;"></div> 

        <br><br>
        <p style="font-weight: 700;color: white;font-size: 1.2rem;">The Project is being saved {{user_name}}, Please Wait...</p>

        <div class="loader-bar">
            <div class="loader-progress"></div>
        </div>
        
        <div class="eds-grid">
            <div class="grid-item"></div>
            <div class="grid-item"></div>
            <div class="grid-item"></div>
            <div class="grid-item"></div>
        </div>
    </div>

    <div class="eds-loader" id="edsLoader2" style="display: none;">
        <div class="eds-logo"><img src="{{ url_for('static', filename='images/web-logo-white.png') }}"  alt="Logo" class="logo" style="width: 200px;"></div> 

        <br><br>
        <p style="font-weight: 700;color: white;font-size: 1.2rem;">Your changes are being saved {{user_name}}, Please Wait...</p>

        <div class="loader-bar">
            <div class="loader-progress"></div>
        </div>
        
        <div class="eds-grid">
            <div class="grid-item"></div>
            <div class="grid-item"></div>
            <div class="grid-item"></div>
            <div class="grid-item"></div>
        </div>
    </div>
    
    <div class="sidebar p-2">
        <br><br>
        <div class="eds-logo"><img style="width: 350px;" src="{{ url_for('static', filename='images/web-logo-white.png') }}"  alt="Logo" class="logo" style="width: 200px;"></div> 

        <br>
        <h6 class="mb-3 text-center">ADMINISTRATION SYSTEM</h6>

        <button class="btn w-100 d-flex justify-content-between align-items-center border rounded-2 mb-2 p-2"
                id="addnewprojectBtn" data-bs-toggle="modal" data-bs-target="#addnewProjectModal">
            <span><i class="bi bi-briefcase-fill me-2"></i> Add New Project</span>
        </button>

        <button class="btn w-100 d-flex justify-content-between align-items-center border rounded-2 mb-2 p-2"
                id="addnewprojectBtn">
            <span><i class="bi bi-credit-card-2-front-fill"></i> Push Payment Reminders</span>
        </button>

        <button class="btn w-100 d-flex justify-content-between align-items-center border rounded-2 mb-2 p-2"
                id="createuserBtn" data-bs-toggle="modal" data-bs-target="#systemUserModal">
            <span><i class="bi bi-person-fill-add"></i> Manage System Users</span>
        </button>

        <button class="btn w-100 d-flex justify-content-between align-items-center border rounded-2 mb-2 p-2"
                data-bs-toggle="modal"
                data-bs-target="#addcompAdminModal">
            <span><i class="bi bi-people-fill"></i> Manage Administrators</span>
        </button>

    </div>

    <div class="modal fade" id="systemUserModal" tabindex="-1" aria-labelledby="systemUserModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="max-width:60%;">
            <div class="modal-content">
            
            <div class="modal-header">
                <h6 class="modal-title" id="systemUserModalLabel"><i class="bi bi-person-fill-add"></i> SYSTEM USERS</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" style="font-size: 14px;">
                <div class="container mt-5">
                    <div class="container2" style="max-height: 450px; overflow-y: auto;">
                        {{ usersdatamain_html|safe }}
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">Create User</button>
                <button class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
            </div>

            </div>
        </div>
    </div>



    <div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            
            <div class="modal-header">
                <h6 class="modal-title" id="createUserModalLabel"><i class="bi bi-person-fill-add"></i> CREATE SYSTEM USER</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" style="font-size: 14px;">
                <form id="createUserForm">
                    <div class="mb-3">
                        <label class="form-label" style="font-weight: bold;">Full Name</label>
                        <input type="text" class="form-control editable-field" name="userfullname" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" style="font-weight: bold;">WhatsApp Number</label>
                        <input type="number" class="form-control editable-field" name="userwhatsapp" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" style="font-weight: bold;">Email</label>
                        <input type="email" class="form-control editable-field" name="useremail" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" style="font-weight: bold;">Password</label>
                        <input type="password" class="form-control editable-field" name="userpassword" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" style="font-weight: bold;">Admin Permission Passcode</label>
                        <input type="text" class="form-control editable-field" name="permission_passcode" id="permissionPasscode" required>
                    </div>


                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" type="submit" form="createUserForm">Create</button>
                <button class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
            </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="addcompAdminModal" tabindex="-1" aria-labelledby="addcompAdminModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h6 class="modal-title" id="addcompAdminModalLabel"><i class="bi bi-people-fill"></i>ADMINISTRATORS</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">

                    <div class="container mt-5">
                        <div class="container2" style="max-height: 450px; overflow-y: auto;">
                            {{ table_datamain_admins_html|safe }}
                        </div>
                    </div>

            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button class="btn btn-primary" id="addAdminplusBtn" style="width: max-content;"
                        data-bs-toggle="modal" data-bs-target="#addAdminplusModal">
                    <i class="bi bi-person-plus"></i> Add Administrator
                </button>

                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>

            </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="viewprojectModal" tabindex="-1" aria-labelledby="viewprojectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">

            <div class="modal-header">
                <h6 class="modal-title" id="viewprojectModalLabel"> <i class="bi bi-card-list"></i> PROJECT DETAILS</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <table class="table table-striped table-borderless">
                    <tbody id="projectDetailsBody">
                        <!-- Filled dynamically with JS -->
                    </tbody>
                </table>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>

            </div>
        </div>
        </div>


    <div class="modal fade" id="addAdminplusModal" tabindex="-1" aria-labelledby="addAdminplusModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md modal-dialog-centered">
            <div class="modal-content">

            <div class="modal-header">
                <h6 class="modal-title" id="addAdminplusModalLabel"><i class="bi bi-person-plus-fill"></i>ADD ADMINISTRATOR</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">

                <form id="adminForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Full Name</label>
                        <input type="text" class="form-control" id="adminName" name="adminName" placeholder="Enter Admin full name">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Contact Phone</label>
                        <input type="text" class="form-control" id="adminPhone" name="adminPhone" placeholder="e.g. +263 77 123 4567">
                    </div>
                </form>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-success d-flex align-items-center" id="saveAdminBtn" style="gap:6px;">
                    <span id="saveText"><i class="bi bi-check-circle"></i> Save</span>
                    <div id="saveLoader" class="spinner-border spinner-border-sm text-light d-none" role="status"></div>
                </button>

                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>

            </div>
        </div>
    </div>



    <div class="modal fade" id="addnewProjectModal" tabindex="-1" aria-labelledby="addnewProjectModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="max-width: 85%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title" id="addnewProjectModalLabel"><i class="bi bi-briefcase-fill"></i> NEW PROJECT</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <form id="addProjectForm">

                        <!-- Row for side-by-side cards -->
                        <div class="row g-3">

                            <!-- CLIENT DETAILS CARD -->
                            <div class="col-md-4">
                                <div class="card" style="padding:15px;">

                                    <h6 style="background-color:#1E2A56; font-weight:800;color: white;text-align: center;padding: 1%;">CLIENT DETAILS</h6>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="person_name" class="col-auto col-form-label" style="padding-right: 0.5rem;">Full Name:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="client_name" name="client_name" required>
                                        </div>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="national_id" class="col-auto col-form-label" style="padding-right: 0.5rem;">National ID Number:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="client_national_id" name="client_national_id" required>
                                        </div>
                                    </div>



                                    <div class="form-group row align-items-start" style="margin-bottom: 0.5rem;">
                                        <label for="address" class="col-auto col-form-label" style="padding-right: 0.5rem;">Address:</label>
                                        <div class="col">
                                            <textarea class="form-control editable-field" id="client_address" rows="3" name="client_address" required></textarea>
                                        </div>
                                    </div>


                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="whatsapp_number" class="col-auto col-form-label" style="padding-right: 0.5rem;">Whatsapp Number:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="client_whatsapp_number" name="client_whatsapp_number" required>
                                        </div>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="email_address" class="col-auto col-form-label" style="padding-right: 0.5rem;">Email:</label>
                                        <div class="col">
                                            <input type="email" class="form-control editable-field" id="client_email" name="client_email" required>
                                        </div>
                                    </div>


                                </div>
                            </div>

                            <!-- NEXT OF KIN DETAILS CARD -->
                            <div class="col-md-4">
                                <div class="card" style="padding:15px;">

                                    <h6 style="background-color:#1E2A56; font-weight:800;color: white;text-align: center;padding: 1%;">NEXT OF KIN DETAILS</h6>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="person_name" class="col-auto col-form-label" style="padding-right: 0.5rem;">Full Name:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="next_of_kin_name" name="next_of_kin_name" required>
                                        </div>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="person_address" class="col-auto col-form-label" style="padding-right: 0.5rem;">Address:</label>
                                        <div class="col">
                                            <textarea class="form-control editable-field" id="next_of_kin_address" rows="3" name="next_of_kin_address" required></textarea>
                                        </div>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="contact_number" class="col-auto col-form-label" style="padding-right: 0.5rem;">Contact Number:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="next_of_kin_contact_number" name="next_of_kin_contact_number" required>
                                        </div>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="relationship" class="col-auto col-form-label" style="padding-right: 0.5rem;">Relationship:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="relationship" name="relationship" required>
                                        </div>
                                    </div>


                                </div>

                            </div>



                            <div class="col-md-4">
                                <div class="card" style="padding:15px;">
                                    <!-- CONTRACTOR DETAILS -->
                                    <h6 style="background-color:#1E2A56; font-weight:800;color: white;text-align: center;padding: 1%;">CONTRACTOR DETAILS</h6>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="contractor_name" class="col-auto col-form-label" style="padding-right: 0.5rem;">Name:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="contractor_name" value="ConnectLink Properties" readonly>
                                        </div>
                                    </div>


                                    <div class="form-group">
                                        <label>Address:</label>
                                        <input type="text" class="form-control editable-field" value="38A Coronation Avenue Greendale Harare" readonly>
                                    </div>

                                    <div class="form-group">
                                        <label>Contact Number</label>
                                        <input type="text" class="form-control editable-field" value="+263 773 368 558 ; +263 716 788 838" readonly>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="contractor_email" class="col-auto col-form-label" style="padding-right: 0.5rem;">Email:</label>
                                        <div class="col">
                                            <input type="email" class="form-control editable-field" id="contractor_email" value="info@connectlinkproperties.co.zw" readonly>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label>Administrator:</label>
                                        <select class="form-control-blue editable-field" id="projectadministrator" name="projectadministrator" required>
                                            <option value="" disabled selected>Select Administrator</option>
                                            {% for option in admin_options %}
                                                <option value="{{ option }}">{{ option }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card" style="padding:15px;">
                                    <!-- PROJECT DETAILS -->
                                    <h6 style="background-color:#1E2A56; font-weight:800;color: white;text-align: center;padding: 1%;">PROJECT DETAILS</h6>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="project_name" class="col-auto col-form-label" style="padding-right: 0.5rem;">Project Name:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="project_name" name="project_name" required>
                                        </div>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="project_location" class="col-auto col-form-label" style="padding-right: 0.5rem;">Project Location:</label>
                                        <div class="col">
                                            <input type="text" class="form-control editable-field" id="project_location" name="project_location" required>
                                        </div>
                                    </div>

                                    <div class="form-group mb-3">
                                        <label class="form-label fw-bold">Project Scope: </label>

                                        <!-- Quill toolbar -->
                                        <div id="projectScopeToolbar">
                                            <span class="ql-formats">
                                                <button class="ql-bold"></button>
                                                <button class="ql-italic"></button>
                                                <button class="ql-underline"></button>
                                            </span>
                                            <span class="ql-formats">
                                                <button class="ql-list" value="bullet"></button>
                                                <button class="ql-list" value="ordered"></button>
                                            </span>
                                        </div>

                                        <!-- Quill editable area -->
                                        <div id="projectScopeEditor" class="editable-field" style="height: 130px; background: #fff;"></div>

                                        <!-- Hidden input that will store final HTML for submitting -->
                                        <input type="hidden" id="project_description" name="project_description" required>
                                    </div>


                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="project_start_date" class="col-auto col-form-label" style="padding-right: 0.5rem;">Project Start Date:</label>
                                        <div class="col">
                                            <input type="date" class="form-control editable-field" id="project_start_date" name="project_start_date" required>
                                        </div>
                                    </div>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="months_to_completion" class="col-auto col-form-label" style="padding-right: 0.5rem;">Project Duration (Days):</label>
                                        <div class="col">
                                            <input type="number" class="form-control editable-field" id="months_to_completion" name="months_to_completion" required>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card" style="padding:15px;">

                        
                                    <!-- PAYMENT TERMS -->
                                    <h6 style="background-color:#1E2A56; font-weight:800;color: white;text-align: center;padding: 1%;">PAYMENT TERMS</h6>

                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label for="agreement_date" class="col-auto col-form-label" style="padding-right: 0.5rem;">Contract Agreement Date:</label>
                                        <div class="col">
                                            <input type="date" class="form-control editable-field" id="agreement_date" name="agreement_date" required>
                                        </div>
                                    </div>


                                    <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                        <label class="col-auto col-form-label" style="padding-right: 0.5rem;">Total Contract Price (USD):</label>
                                        <div class="col">
                                            <input type="number" class="form-control editable-field" id="total_contract_price" name="total_contract_price" required>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label>Payment Method:</label>
                                        <select class="form-control-blue editable-field" id="paymentMethod" name="payment_method" required>
                                            <option value="" disabled selected>Select Payment Method</option>
                                            <option value="Installments">Installments</option>
                                            <option value="Bullet">Bullet</option>
                                        </select>
                                    </div>

                                    <div class="form-group row align-items-start" id="bullet_payment_date" style="display: none; margin-bottom: 0.5rem;">
                                        <label for="bullet_payment_date" class="col-auto col-form-label" style="padding-right: 0.5rem;">Date Full Payment Made:</label>
                                        <div class="col">
                                            <input type="date" class="form-control editable-field" id="bullet_payment_date" name="bullet_payment_date" required>
                                        </div>
                                    </div>



                                    <div id="paymentschedule" style="display: none;">


                                        <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                            <label for="monthstopay" class="col-auto col-form-label" style="padding-right: 0.5rem;">Months To Pay:</label>
                                            <div class="col">
                                                <input type="number" class="form-control editable-field" id="monthstopay" name="months_to_pay" style="width: 40%;" required>
                                            </div>
                                        </div>

                                        <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                            <label class="col-auto col-form-label" style="padding-right: 0.5rem;">Late Payment Interest (% p.a):</label>
                                            <div class="col">
                                                <input type="number" class="form-control editable-field" id="late_payment_interest" name="late_payment_interest" required>
                                            </div>
                                        </div>

                                        <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                            <label class="col-auto col-form-label" style="padding-right: 0.5rem;">Deposit Paid (USD):</label>
                                            <div class="col">
                                                <input type="number" class="form-control editable-field" id="deposit_required" name="deposit_required">
                                            </div>
                                        </div>

                                        <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                            <label for="deposit_payment_date" class="col-auto col-form-label" style="padding-right: 0.5rem;">Date Deposit Paid:</label>
                                            <div class="col">
                                                <input type="date" class="form-control editable-field" id="deposit_payment_date" name="deposit_payment_date" required>
                                            </div>
                                        </div>

                                        <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                            <label for="first_installment_due_date" class="col-auto col-form-label" style="padding-right: 0.5rem;">Due Date For First Installment:</label>
                                            <div class="col">
                                                <input type="date" class="form-control editable-field" id="first_installment_due_date" name="first_installment_due_date" required>
                                            </div>
                                        </div>

                                        <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                                            <label class="col-auto col-form-label" style="padding-right: 0.5rem;">
                                                Installment Due Date Generator:
                                            </label>
                                            <div class="col-auto">
                                                <select class="form-control-blue editable-field" id="due_date_type" name="due_date_type">
                                                    <option value="auto">Automatic</option>
                                                    <option value="manual">Manual</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div id="manualInstallments"
                                            class="form-group row align-items-center"
                                            style="display:none; margin-top: 1rem; margin-bottom: 0.5rem;">
                                        </div>

                                    </div>

                                </div>

                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProjectBtn" style="width: max-content;">Save Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Project Modal -->
    <div class="modal fade" id="deleteprojectModal" tabindex="-1" aria-labelledby="deleteprojectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h6 class="modal-title" id="deleteprojectModalLabel">
                        <i class="bi bi-exclamation-triangle"></i> PROJECT REMOVAL CONFIRMATION
                    </h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="deleteProjectForm">
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>WARNING:</strong> This action cannot be undone! All project data including payments history will be permanently deleted.
                        </div>
                        
                        <p>Are you sure you want to permanently delete the following project?</p>
                        
                        <div class="mb-3">
                            <strong>Project ID:</strong> 
                            <span id="updateProjectIdDelete" class="text-danger fw-bold"></span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Client Name:</strong> 
                            <span id="deleteClientNameDisplay"></span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Project Name:</strong> 
                            <span id="deleteProjectNameDisplay"></span>
                        </div>
                        
                        <div class="form-group mt-4">
                            <label for="adminPasscode" class="form-label fw-bold">
                                <i class="bi bi-key"></i> Enter Admin Passcode to Confirm
                            </label>
                            
                            <div style="position: relative; margin-bottom: 10px;">
                                <input type="password" 
                                    class="form-control editable-field" 
                                    id="adminPasscode" 
                                    name="admin_passcode" 
                                    required 
                                    placeholder="Enter admin passcode"
                                    style="width: 100%; padding-right: 40px; padding: 10px 15px; border-radius: 8px; border: 2px solid #1E2A56; background-color: #e6f0ff; color: #1E2A56; transition: all 0.3s ease;">
                                
                                <i id="toggleAdminPassword" 
                                class="bi bi-eye" 
                                style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #1E2A56; font-size: 1.1rem;"></i>
                            </div>
                        </div>
                        
                        <input type="hidden" id="deleteProjectId" name="project_id">
                        <input type="hidden" id="deleteClientName" name="client_name">
                        <input type="hidden" id="deleteProjectName" name="project_name">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger" id="confirmDeleteBtn">
                            <span id="deleteBtnText">Delete Project Permanently</span>
                            <span id="deleteSpinner" class="spinner-border spinner-border-sm d-none"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Update Project Modal -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" style="max-width: 80%;">
            <div class="modal-content" style="font-size: 13px;">
                <form id="updateProjectForm" method="POST" action="/update_project">

                    <div class="modal-header" style="background-color: #1E2A56; color: white;">
                        <h6 class="modal-title" id="updateModalLabel"><i class="bi bi-card-checklist"></i> PROJECT PROGRESS UPDATE</h6>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">

                        <input type="hidden" id="updateProjectId" name="project_id">
                        
                        <div class="row mb-3 g-3">
                            <!-- Client Name - Wider -->
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <label for="updateClientName" class="form-label fw-bold">Client Name</label>
                                <input type="text" class="form-control" id="updateClientName" readonly>
                            </div>

                            <!-- Project Name - Wider -->
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <label for="updateProjectName" class="form-label fw-bold">Project Name</label>
                                <input type="text" class="form-control editable-field" name="ProjectName" id="updateProjectName">
                            </div>

                            <!-- Total Bill - Medium -->
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <label for="updateTotalContractAmount" class="form-label fw-bold">Total Bill (USD)</label>
                                <input type="number" class="form-control editable-field" name="TotalContractAmount" id="updateTotalContractAmount">
                            </div>

                            <!-- Months to Pay - Narrower -->
                            <div class="col-lg-1 col-md-3 col-sm-4">
                                <label for="updateMonthsToPay" class="form-label fw-bold">Months To Pay</label>
                                <input type="number" class="form-control editable-field" name="MonthsToPay" id="updateMonthsToPay">
                            </div>

                            <!-- Admin Name - Medium -->
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <label for="updateAdminName" class="form-label fw-bold">Admin Name</label>
                                <input type="text" class="form-control editable-field" id="updateAdminName">
                            </div>

                            <!-- Completion Status - Wider -->
                            <div class="col-lg-3 col-md-5 col-sm-8">
                                <label for="updateCompletionStatus" class="form-label fw-bold">Completion Status</label>
                                <select class="form-select" id="updateCompletionStatus" name="completion_status">
                                    <option value="ph" disabled selected hidden>Select Status</option>
                                    <option value="Not Started">Not Started</option>
                                    <option value="Ongoing">Ongoing</option>
                                    <option value="On Hold">On Hold</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">

                            <!-- Deposit & Date Paid + Buttons (with border) -->
                            <div class="col-md-5">
                                <div style="
                                    border: 2px solid #1E2A56;
                                    border-radius: 8px;
                                    padding: 12px;
                                    height: 100%;
                                ">

                                    <!-- Deposit + Date Paid side by side -->
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <label for="updateDepositPaid" class="form-label fw-bold">Deposit Paid (USD)</label>
                                            <input type="text" class="form-control editable-field" name="depositpaid"  id="updateDepositPaid">
                                        </div>

                                        <div class="col-6">
                                            <label for="updateDatePaid" class="form-label fw-bold">Date Paid</label>
                                            <input type="date" class="form-control editable-field" id="updateDatePaid" name="deposit_date_paid">
                                        </div>
                                    </div>

                                    <!-- Buttons side by side -->
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary w-100" id="getdepositReceiptBtn">
                                            <span id="depositText">Get Receipt</span>
                                            <span id="depositSpinner" class="spinner-border spinner-border-sm d-none"></span>
                                        </button>
                                        <button class="btn btn-primary w-100" id="sendReceiptBtn">Send Receipt to Client</button>
                                    </div>

                                </div>
                            </div>

                            <div class="col-md-7">
                                <label for="updateProjectScope" class="form-label fw-bold">Project Scope</label>
                                <textarea class="form-control editable-field" id="updateProjectScope" rows="5" name="projscope"></textarea>
                            </div>

                        </div>


                                                
                        <!-- Scrollable Container -->
                        <div style="max-height: 350px; overflow-y: auto; padding-right: 10px;">

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Installment 1 Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 align-items-center">
                                        <!-- Amount -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment1Amount" class="form-label fw-bold mb-1">Amount (USD)</label>
                                                <input type="text" class="form-control" id="updateInstallment1Amount" readonly>
                                            </div>
                                        </div>

                                        <!-- Due Date -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment1DueDate" class="form-label fw-bold mb-1">Due Date</label>
                                                <input type="date" class="form-control editable-field" name="Installment1DueDate" id="updateInstallment1DueDate">
                                            </div>
                                        </div>

                                        <!-- Date Paid -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment1PaidDate" class="form-label fw-bold mb-1">Date Paid</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment1Date" name="installment1_paid_date">
                                            </div>
                                        </div>

                                        <!-- Button 1: Get Receipt -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Get Receipt
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Button 2: Send Receipt to Client -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Send Receipt to Client
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>



                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Installment 2 Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 align-items-center">
                                        <!-- Amount -->
                                        <div class="col-sm-6 col-md-4 col-lg">
                                            <label for="updateInstallment2Amount" class="form-label fw-bold mb-1 small">Amount (USD)</label>
                                            <input type="text" class="form-control form-control-sm" id="updateInstallment2Amount" readonly>
                                        </div>

                                        <!-- Due Date -->
                                        <div class="col-sm-6 col-md-4 col-lg">
                                            <label for="updateInstallment2DueDate" class="form-label fw-bold mb-1 small">Due Date</label>
                                            <input type="date" class="form-control form-control-sm editable-field" id="updateInstallment2DueDate" name="Installment2DueDate">
                                        </div>

                                        <!-- Date Paid -->
                                        <div class="col-sm-6 col-md-4 col-lg">
                                            <label for="updateInstallment2Date" class="form-label fw-bold mb-1 small">Date Paid</label>
                                            <input type="date" class="form-control form-control-sm editable-field" id="updateInstallment2Date" name="installment2_paid_date">
                                        </div>

                                        <!-- Button 1 -->
                                        <div class="col-sm-6 col-md-6 col-lg">
                                            <button type="button" class="btn btn-primary btn-sm w-100">
                                                Get Receipt
                                            </button>
                                        </div>

                                        <!-- Button 2 -->
                                        <div class="col-sm-6 col-md-6 col-lg">
                                            <button type="button" class="btn btn-primary btn-sm w-100">
                                                Send Receipt
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Installment 3 Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 align-items-center">
                                        <!-- Amount -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment3Amount" class="form-label fw-bold mb-1">Amount (USD)</label>
                                                <input type="text" class="form-control" id="updateInstallment3Amount" readonly>
                                            </div>
                                        </div>

                                        <!-- Due Date -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment3DueDate" class="form-label fw-bold mb-1">Due Date</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment3DueDate" name="Installment3DueDate">
                                            </div>
                                        </div>

                                        <!-- Date Paid -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment3Date" class="form-label fw-bold mb-1">Date Paid</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment3Date" name="installment3_paid_date">
                                            </div>
                                        </div>

                                        <!-- Button 1: Get Receipt -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Get Receipt
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Button 2: Send Receipt to Client -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Send Receipt to Client
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Installment 4 Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 align-items-center">
                                        <!-- Amount -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment4Amount" class="form-label fw-bold mb-1">Amount (USD)</label>
                                                <input type="text" class="form-control" id="updateInstallment4Amount" readonly>
                                            </div>
                                        </div>

                                        <!-- Due Date -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment4DueDate" class="form-label fw-bold mb-1">Due Date</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment4DueDate" name="Installment4DueDate">
                                            </div>
                                        </div>

                                        <!-- Date Paid -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment4Date" class="form-label fw-bold mb-1">Date Paid</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment4Date" name="installment4_paid_date">
                                            </div>
                                        </div>

                                        <!-- Button 1: Get Receipt -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Get Receipt
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Button 2: Send Receipt to Client -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Send Receipt to Client
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Installment 5 Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 align-items-center">
                                        <!-- Amount -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment5Amount" class="form-label fw-bold mb-1">Amount (USD)</label>
                                                <input type="text" class="form-control" id="updateInstallment5Amount" readonly>
                                            </div>
                                        </div>

                                        <!-- Due Date -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment5DueDate" class="form-label fw-bold mb-1">Due Date</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment5DueDate" name="Installment5DueDate">
                                            </div>
                                        </div>

                                        <!-- Date Paid -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment5Date" class="form-label fw-bold mb-1">Date Paid</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment5Date" name="installment5_paid_date">
                                            </div>
                                        </div>

                                        <!-- Button 1: Get Receipt -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Get Receipt
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Button 2: Send Receipt to Client -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Send Receipt to Client
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Installment 6 Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3 align-items-center">
                                        <!-- Amount -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment6Amount" class="form-label fw-bold mb-1">Amount (USD)</label>
                                                <input type="text" class="form-control" id="updateInstallment6Amount" readonly>
                                            </div>
                                        </div>

                                        <!-- Due Date -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment6DueDate" class="form-label fw-bold mb-1">Due Date</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment6DueDate" name="Installment6DueDate">
                                            </div>
                                        </div>

                                        <!-- Date Paid -->
                                        <div class="col-xl col-lg-3 col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label for="updateInstallment6Date" class="form-label fw-bold mb-1">Date Paid</label>
                                                <input type="date" class="form-control editable-field" id="updateInstallment6Date" name="installment6_paid_date">
                                            </div>
                                        </div>

                                        <!-- Button 1: Get Receipt -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Get Receipt
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Button 2: Send Receipt to Client -->
                                        <div class="col-xl col-lg-3 col-md-6 col-sm-6">
                                            <div class="d-grid h-100">
                                                <button type="button" class="btn btn-primary w-100 py-2">
                                                    Send Receipt to Client
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <!-- End Scrollable Container -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="downloadpaymentshistory" style="width: max-content;">
                            <span id="downloadText">Download Payments History</span>
                            <span id="downloadSpinner" class="spinner-border spinner-border-sm d-none"></span>
                        </button>
                        <button type="submit" class="btn btn-primary" style="width: max-content;">Save Changes</button>
                        <!-- In your update modal footer -->
                        <button type="button" 
                                class="btn btn-danger delete-project-btn" 
                                data-bs-toggle="modal" 
                                data-bs-target="#deleteprojectModal"
                                data-project-id=""
                                data-client-name=""
                                data-project-name=""
                                style="width: max-content;">
                            Delete Project
                        </button>
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

        <!-- CHANGE INSTALLMENT DATE MODAL -->
    <div class="modal fade" id="changeInstallmentDateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header" style="background:#1E2A56;color:white;">
                    <h6 class="modal-title">FIRST INSTALLMENT DUE DATE CHANGE</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <input type="hidden" id="modalProjectId">

                    <label class="fw-bold">New Due Date</label>
                    <input type="date" class="form-control editable-field" id="modalNewDueDate">

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

                    <button type="button" class="btn btn-primary" id="saveNewInstallmentDateBtn" style="width: max-content;">
                        <span id="saveDateText">Save Changes</span>
                        <span id="saveDateSpinner" class="spinner-border spinner-border-sm d-none"></span>
                    </button>
                </div>

            </div>
        </div>
    </div>
<!-- View Interim Enquiries Modal -->
<div class="modal fade" id="viewEnquiriesModal" tabindex="-1" aria-labelledby="viewEnquiriesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-fullscreen" style="max-width: 1400px;">
        <div class="modal-content" style="height: 95vh;">
            <!-- Modal Header -->
            <div class="modal-header bg-primary text-white py-3 px-4">
                <div class="d-flex align-items-center w-100">
                    <div class="me-3">
                        <i class="bi bi-search fs-3"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="modal-title mb-0 fw-bold">INTERIM ENQUIRIES MANAGEMENT</h5>
                        <small class="opacity-85">View and manage temporary enquiries</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-white text-primary px-3 py-2" id="recordCount">0 records</span>
                        <button type="button" class="btn btn-light btn-sm px-3" onclick="loadEnquiriesData()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body p-0 d-flex flex-column">
                <!-- Statistics Bar -->
                <div class="border-bottom bg-light py-3 px-4">
                    <div class="row g-3">
                        <div class="col-auto">
                            <div class="d-flex align-items-center bg-white rounded px-3 py-2 shadow-sm">
                                <i class="bi bi-inbox text-primary me-2 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark fs-4" id="totalEnquiries">0</div>
                                    <small class="text-muted">Total</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="d-flex align-items-center bg-white rounded px-3 py-2 shadow-sm">
                                <i class="bi bi-cup-straw text-success me-2 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark fs-4" id="kitchenCount">0</div>
                                    <small class="text-muted">Kitchen</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="d-flex align-items-center bg-white rounded px-3 py-2 shadow-sm">
                                <i class="bi bi-building text-warning me-2 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark fs-4" id="buildingCount">0</div>
                                    <small class="text-muted">Building</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="d-flex align-items-center bg-white rounded px-3 py-2 shadow-sm">
                                <i class="bi bi-house-up text-info me-2 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark fs-4" id="renovationCount">0</div>
                                    <small class="text-muted">Renovation</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="d-flex align-items-center bg-white rounded px-3 py-2 shadow-sm">
                                <i class="bi bi-three-dots text-secondary me-2 fs-5"></i>
                                <div>
                                    <div class="fw-bold text-dark fs-4" id="otherCount">0</div>
                                    <small class="text-muted">Other</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="flex-grow-1 d-flex" style="min-height: 0;">
                    <!-- Left Sidebar - Filters -->
                    <div class="border-end bg-white" style="width: 300px; flex-shrink: 0;">
                        <div class="p-3" style="height: 100%; overflow-y: auto;">
                            <!-- Quick Filters -->
                            <div class="mb-4">
                                <h6 class="text-dark mb-3 fw-bold">
                                    <i class="bi bi-lightning text-primary me-2"></i>
                                    Quick Filters
                                </h6>
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-sm btn-outline-primary active" onclick="filterByType('all')" id="filterAll">
                                        All
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="filterByType('kitchen_cabinets')" id="filterKitchen">
                                        Kitchen
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="filterByType('building')" id="filterBuilding">
                                        Building
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="filterByType('renovation')" id="filterRenovation">
                                        Renovation
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="filterByType('otherenq')" id="filterOther">
                                        Other
                                    </button>
                                </div>
                            </div>

                            <!-- Search Filters -->
                            <div class="mb-4">
                                <h6 class="text-dark mb-3 fw-bold">
                                    <i class="bi bi-search text-primary me-2"></i>
                                    Search Filters
                                </h6>
                                <div class="mb-3">
                                    <label class="form-label small text-muted mb-1">Enquiry Type</label>
                                    <select class="form-select form-select-sm" id="enquiryTypeFilter" onchange="applyFilters()">
                                        <option value="all">All Types</option>
                                        <option value="kitchen_cabinets">Kitchen & Cabinets</option>
                                        <option value="building">Building</option>
                                        <option value="renovation">Renovation</option>
                                        <option value="otherenq">Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small text-muted mb-1">WhatsApp Number</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">
                                            <i class="bi bi-whatsapp text-success"></i>
                                        </span>
                                        <input type="text" class="form-control" id="whatsappFilter" 
                                               placeholder="Search number..." onkeyup="applyFilters()">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small text-muted mb-1">Enquiry ID</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">
                                            <i class="bi bi-hash"></i>
                                        </span>
                                        <input type="text" class="form-control" id="idFilter" 
                                               placeholder="Search ID..." onkeyup="applyFilters()">
                                    </div>
                                </div>
                            </div>

                            <!-- Bulk Actions -->
                            <div class="mb-4">
                                <h6 class="text-dark mb-3 fw-bold">
                                    <i class="bi bi-check2-square text-primary me-2"></i>
                                    Bulk Actions
                                </h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-success" onclick="copySelectedNumbers()">
                                        <i class="bi bi-copy me-1"></i> Copy Numbers
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSelectedEnquiries()">
                                        <i class="bi bi-trash me-1"></i> Delete Selected
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                                        <i class="bi bi-x me-1"></i> Clear Selection
                                    </button>
                                </div>
                                <div class="mt-2 text-center small text-muted" id="selectedInfo">
                                    0 selected
                                </div>
                            </div>

                            <!-- Export Section -->
                            <div class="mb-4">
                                <h6 class="text-dark mb-3 fw-bold">
                                    <i class="bi bi-download text-primary me-2"></i>
                                    Export Data
                                </h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-success" onclick="exportToExcel()">
                                        <i class="bi bi-file-earmark-excel me-1"></i> Export Excel
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="exportToCSV()">
                                        <i class="bi bi-filetype-csv me-1"></i> Export CSV
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="printReport()">
                                        <i class="bi bi-printer me-1"></i> Print Report
                                    </button>
                                </div>
                            </div>

                            <!-- Refresh Section -->
                            <div>
                                <button class="btn btn-sm btn-outline-primary w-100" onclick="loadEnquiriesData()">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh Data
                                </button>
                                <div class="mt-2 text-center small text-muted">
                                    <i class="bi bi-clock me-1"></i>
                                    Updated: <span id="lastUpdated">Just now</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Table Area -->
                    <div class="flex-grow-1" style="min-width: 0;">
                        <!-- Table Header -->
                        <div class="border-bottom bg-white py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="checkbox" id="selectAll" 
                                               onchange="toggleSelectAll()">
                                    </div>
                                    <h6 class="mb-0 text-dark fw-bold">
                                        <i class="bi bi-table text-primary me-2"></i>
                                        Enquiries List
                                    </h6>
                                    <span class="badge bg-light text-dark ms-3" id="filteredCount">0</span>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="input-group input-group-sm" style="width: 250px;">
                                        <input type="text" class="form-control" id="globalSearch" 
                                               placeholder="Search all columns..." onkeyup="applyGlobalSearch()">
                                        <button class="btn btn-outline-secondary" type="button">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="scrollToTop()">
                                        <i class="bi bi-arrow-up"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Table Container -->
                        <div class="position-relative flex-grow-1" style="overflow: auto;">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light sticky-top" style="top: 0;">
                                    <tr>
                                        <th class="px-4 py-3" style="width: 80px;">
                                            <span class="small text-muted">#</span>
                                        </th>
                                        <th class="px-4 py-3" style="width: 150px;">
                                            <span class="small text-muted">ENQUIRY ID</span>
                                        </th>
                                        <th class="px-4 py-3" style="min-width: 350px;">
                                            <i class="bi bi-whatsapp text-success me-1"></i>
                                            <span class="small text-muted">WHATSAPP NUMBER</span>
                                        </th>
                                        <th class="px-4 py-3" style="width: 200px;">
                                            <i class="bi bi-tag me-1"></i>
                                            <span class="small text-muted">ENQUIRY TYPE</span>
                                        </th>
                                        <th class="px-4 py-3 text-center" style="width: 150px;">
                                            <i class="bi bi-gear me-1"></i>
                                            <span class="small text-muted">ACTIONS</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="enquiriesTableBody">
                                    <!-- Loading State -->
                                    <tr id="loadingRow">
                                        <td colspan="5" class="text-center py-5">
                                            <div class="d-flex flex-column align-items-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-3 text-muted">Loading enquiries data...</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- No Data Message -->
                            <div class="text-center py-5 d-none" id="noDataMessage">
                                <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 300px;">
                                    <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
                                    <h5 class="text-muted mb-2">No Enquiries Found</h5>
                                    <p class="text-muted small mb-4">No records match your search criteria</p>
                                    <button class="btn btn-sm btn-outline-primary" onclick="resetFilters()">
                                        <i class="bi bi-arrow-clockwise me-1"></i> Reset Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer border-top py-2 px-3">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div class="text-muted small">
                        <i class="bi bi-info-circle me-1"></i>
                        Total: <span class="fw-bold" id="totalRecords">0</span> records | 
                        Showing: <span class="fw-bold" id="showingRecords">0</span> records
                    </div>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg me-1"></i> Close
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" onclick="loadEnquiriesData()">
                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <main class="main-content" id="main-content">
        <header>
            <div class="employeetag">{{user_name}}, CONNECTLINK PROPERTIES <span style="color: white;background-color: #1E2A56;border-radius: 10px;padding: 6px;font-size: 13px;">ID: {{userid}}</span></div>
            <div><span class="current-date" id="currdate">DATE: {{ today_date }}</span></div>
            <span id="name-down" value="{{firstname}}" style="display: none;"></span>
            <span id="name-down2" value="{{surname}}" style="display: none;"></span>

            <button onclick="window.location.href='/logout'" class="btn btn-primary" style="width: max-content;font-size: 14px;">  Logout<i class="bi bi-door-closed-fill" style="margin-left: 7px;"></i>  </button>

        </header>

        <div class="card" id="admin-content" style="display: block;">
            <ul class="nav nav-tabs">

                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#projects-tab"><i class="bi bi-list-columns-reverse"></i>    PROJECTS PORTFOLIO PORTAL</button>
                </li>

                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#payments-tab"><i class="bi bi-cash-coin"></i>    PAYMENTS PORTAL</button>
                </li>

                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#enquiries-tab"><i class="bi bi-person-badge-fill"></i>    ENQUIRIES PORTAL</button>
                </li>

                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#dashboard-tab"><i class="bi bi-person-badge-fill"></i>    SUMMARY</button>
                </li>

                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#contractor-details-tab"><i class="bi bi-list-columns-reverse"></i>    CONTRACTOR DETAILS</button>
                </li>

            </ul>
            <div class="tab-content mt-4">


                <div class="tab-pane fade" id="payments-tab">

                    <button class="btn btn-primary mt-1"
                            id="installmentscheduleBtn"
                            style="width: max-content;"
                            onclick="downloadInstallmentSchedule()">
                        <i class="bi bi-download"></i> Download Installments Schedule
                    </button>

                    <input type="hidden" id="completed-projects" value="{{ count_completed|default(0)|int }}">
                    <input type="hidden" id="ongoing-projects" value="{{ count_ongoing|default(0)|int }}">

                    <div class="dashboard-summary">
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-calendar-day fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Today</h5>
                                <div class="payment-amounts">
                                    <div class="paid-amount">
                                        <span class="badge bg-success">PAID</span>
                                        <span class="amount text-success">${{ "{:,.2f}".format(payment_stats['today_paid']) }}</span>
                                    </div>
                                    <div class="overdue-amount">
                                        <span class="badge bg-danger">OVERDUE</span>
                                        <span class="amount text-danger">${{ "{:,.2f}".format(payment_stats['today_overdue']) }}</span>
                                    </div>
                                </div>
                                <small class="text-muted">Payments today</small>
                            </div>
                        </div>
                        
                        <!-- Week to Date -->
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-calendar-week fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Week To Date</h5>
                                <div class="payment-amounts">
                                    <div class="paid-amount">
                                        <span class="badge bg-success">PAID</span>
                                        <span class="amount text-success">${{ "{:,.2f}".format(payment_stats['week_paid']) }}</span>
                                    </div>
                                    <div class="overdue-amount">
                                        <span class="badge bg-danger">OVERDUE</span>
                                        <span class="amount text-danger">${{ "{:,.2f}".format(payment_stats['week_overdue']) }}</span>
                                    </div>
                                </div>
                                <small class="text-muted">Since {{ start_of_week.strftime('%b %d') }}</small>
                            </div>
                        </div>
                        
                        <!-- Month to Date -->
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-calendar-month fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Month to Date</h5>
                                <div class="payment-amounts">
                                    <div class="paid-amount">
                                        <span class="badge bg-success">PAID</span>
                                        <span class="amount text-success">${{ "{:,.2f}".format(payment_stats['month_paid']) }}</span>
                                    </div>
                                    <div class="overdue-amount">
                                        <span class="badge bg-danger">OVERDUE</span>
                                        <span class="amount text-danger">${{ "{:,.2f}".format(payment_stats['month_overdue']) }}</span>
                                    </div>
                                </div>
                                <small class="text-muted">Since {{ start_of_month.strftime('%b %d') }}</small>
                            </div>
                        </div>
                        
                        <!-- Year to Date -->
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-calendar-year fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Year to Date</h5>
                                <div class="payment-amounts">
                                    <div class="paid-amount">
                                        <span class="badge bg-success">PAID</span>
                                        <span class="amount text-success">${{ "{:,.2f}".format(payment_stats['year_paid']) }}</span>
                                    </div>
                                    <div class="overdue-amount">
                                        <span class="badge bg-danger">OVERDUE</span>
                                        <span class="amount text-danger">${{ "{:,.2f}".format(payment_stats['year_overdue']) }}</span>
                                    </div>
                                </div>
                                <small class="text-muted">Since {{ start_of_year.strftime('%Y') }}</small>
                            </div>
                        </div>
                        
                        <!-- Total Overdue (Cumulative) -->
                        <div class="summary-card overdue-card">
                            <div class="icon"><i class="bi bi-exclamation-triangle-fill fs-3" style="color: #dc3545;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder; color: #dc3545;">Total Overdue</h5>
                                <p class="count text-danger">${{ "{:,.2f}".format(payment_stats['total_overdue']) }}</p>
                                <small class="text-danger">
                                    <i class="bi bi-clock-history"></i> All unpaid past due amounts
                                </small>
                            </div>
                        </div>
            
                    </div>


                    </div>
                    <div class="container2 mainalldata" style="max-height: 380px; overflow-y: auto;">
                        {{ status_df_html |safe }}
                    </div>


                </div>



                <div class="tab-pane fade" id="dashboard-tab">

                    <input type="hidden" id="completed-projects" value="{{ count_completed|default(0)|int }}">
                    <input type="hidden" id="ongoing-projects" value="{{ count_ongoing|default(0)|int }}">

                    <div class="dashboard-summary">
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-people-fill fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Projects</h5>
                                <p>{{ num_projects }}</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-hourglass-split fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Ongoing Projects</h5>
                                <p>{{ count_ongoing }}</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-calendar2-check-fill fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Completed Projects</h5>
                                <p>{{ count_completed }}</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-stopwatch-fill fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Average Completion Time</h5>
                                <p>{{ average_duration }} days</p>
                            </div>
                        </div>

                        <div class="summary-card">
                            <div class="icon"><i class="bi bi-1-circle-fill fs-3" style="color: #1E2A56;"></i></div>
                            <div class="details">
                                <h5 style="font-weight: bolder;">Top Location</h5>
                                <p>{{ most_frequent_location }}</p>
                            </div>
                        </div>

                    </div>

                    <div class="dashboard-graphs">

                        <div class="graph-card">
                            <h6>Completed vs Ongoing</h6>
                            <canvas id="leaveByTypeChart" width="800" height="300"></canvas>
                        </div>

                        <div class="graph-card">
                            <h6>Projects By Location</h6>
                            <canvas id="projectsByLocationChart" width="800" height="300"></canvas>
                        </div>

                        <div class="graph-card">
                            <h6>Overdue Payments</h6>
                            <canvas id="employeesRemainingChart" width="800" height="300"></canvas>
                        </div>

                    </div>

                </div>


                <div class="tab-pane fade" id="enquiries-tab">
                    <button class="btn btn-primary mt-3"
                            id="exportenquiriesBtn"
                            style="width: max-content;"
                            onclick="downloadenquiries()">
                        <i class="bi bi-download"></i> Download Enquiries File
                    </button>

                    <button class="btn btn-primary mt-3"
                            id="exportenquiriesBtn"
                            style="width: max-content;"
                            data-bs-toggle="modal"
                            data-bs-target="#viewEnquiriesModal">
                        <i class="bi bi-search"></i> View Interim Enquiries
                    </button>

                    <div class="container mt-5">
                            <div class="container2" style="max-height: 500px; overflow-y: auto;">

                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <input type="text" id="enquirySearch" class="form-control form-control-sm" 
                                            placeholder="Search enquiries..." style="font-size: 12px;">
                                    </div>
                                    <div class="col-md-3">
                                        <select id="categoryFilter" class="form-select form-select-sm" style="font-size: 12px;">
                                            <option value="">All Categories</option>
                                            <option value="Kitchen & Cabinets">Kitchen & Cabinets</option>
                                            <option value="Building">Building</option>
                                            <option value="Renovation">Renovation</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select id="statusFilter" class="form-select form-select-sm" style="font-size: 12px;">
                                            <option value="">All Status</option>
                                            <option value="pending">Pending</option>
                                            <option value="in_progress">In Progress</option>
                                            <option value="completed">Completed</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button id="clearFilters" class="btn btn-sm btn-outline-secondary w-100" style="font-size: 12px;">
                                            Clear
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Results Count -->
                                <div class="mb-2">
                                    <small id="resultsCount" class="text-muted"></small>
                                </div>

                                <table class="table-theme">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Date</th>
                                            <th>Client</th>
                                            <th>Username</th>
                                            <th>Category</th>
                                            <th>Message</th>
                                            <th>Status</th>
                                            <th>Document</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for enquiry in enquiries_data %}
                                        <tr class="enquiry-row"  id="enquiry-row-{{ enquiry.id }}"
                                            data-id="{{ enquiry.id }}"
                                            data-category="{{ enquiry.category }}"
                                            data-status="{{ enquiry.status }}"
                                            data-client="{{ enquiry.clientwhatsapp }}"
                                            data-username="{{ enquiry.username }}"
                                            data-message="{{ enquiry.message }}">
                                            <td>#{{ enquiry.id }}</td>
                                            <td>{{ enquiry.timestamp }}</td>
                                            <td>
                                                <a href="https://wa.me/263{{ enquiry.clientwhatsapp }}" target="_blank">
                                                    +263{{ enquiry.clientwhatsapp }}
                                                </a>
                                            </td>
                                            <td>{{ enquiry.username }}</td>
                                            <td><span class="badge bg-secondary" style="font-size: 11px;">{{ enquiry.category }}</span></td>
                                            <td>
                                                <div class="message-container">
                                                    <span class="message-preview">
                                                        {{ enquiry['message'][:10] if enquiry['message'] and enquiry['message']|length > 10 else enquiry['message'] or 'No message' }}
                                                        {% if enquiry['message'] and enquiry['message']|length > 10 %}
                                                        ... <a href="javascript:void(0)" class="expand-message" data-id="{{ enquiry['id'] }}">[Show More]</a>
                                                        {% endif %}
                                                    </span>
                                                    <div class="message-full" id="message-full-{{ enquiry['id'] }}" style="display: none;">
                                                        {{ enquiry['message'] or 'No message' }}
                                                        <br>
                                                        <a href="javascript:void(0)" class="collapse-message" data-id="{{ enquiry['id'] }}">[Show Less]</a>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <select class="form-select status-select" style="font-size: 11px;" data-id="{{ enquiry.id }}">
                                                    <option value="pending" {% if enquiry.status == 'pending' %}selected{% endif %}>Pending</option>
                                                    <option value="in_progress" {% if enquiry.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                                    <option value="completed" {% if enquiry.status == 'completed' %}selected{% endif %}>Completed</option>
                                                </select>
                                            </td>
                                            <td>
                                                {% if enquiry.has_plan %}
                                                <a href="/api/enquiries/{{ enquiry.id }}/plan" target="_blank" class="btn btn-sm btn-success" style="font-size: 11px;">
                                                    PDF
                                                </a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>


                </div>


                <div class="tab-pane fade show active" id="projects-tab">
                    <button class="btn btn-primary mt-1"
                            id="exportprojectportBtn"
                            style="width: max-content;"
                            onclick="downloadPortfolio()">
                        <i class="bi bi-download"></i> Download Master File
                    </button>

                    <div class="container mt-6 card">
                        <div class="row mb-5 align-items-center">
                            <div class="col-md-3">

                                <div class="input-group">

                                    <span class="input-group-text" style="background-color: #1E2A56; color: white; border: 2px solid #1E2A56;">
                                        <i class="bi bi-calendar-month"></i>
                                    </span>
                                    <select class="form-select" id="monthFilter" style="border: 2px solid #1E2A56; color: #1E2A56; font-weight: 500;">
                                        {% for month in month_options %}
                                            <option value="{{ month.value }}" 
                                                    {% if loop.first %}selected{% endif %}>
                                                {{ month.display }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-2">
                                <button class="btn btn-primary" id="applyFilterBtn" style="width: max-content;">
                                    <i class="bi bi-funnel"></i> Apply Filter
                                </button>
                            </div>
                            
                        </div>

                        <div class="container2 mainalldata" style="max-height: 380px; overflow-y: auto;">
                            {{ table_datamain_html |safe }}
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="contractor-details-tab">
                    <div class="container mt-3" style="color: #1E2A56; font-size: 0.82rem;">

                        <div class="card shadow-sm border-0 rounded-4">
                            <div class="card-body p-3">

                                <h6 class="mb-2 fw-bold" style="font-size: 0.9rem;"> <i class="bi bi-building-fill-gear"></i> CONTRACTOR DETAILS</h6>

                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <p class="text-muted mb-0" style="font-size: 0.75rem;">COMPANY</p>
                                        <p class="fw-semibold mb-1">{{ companyname }}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p class="text-muted mb-0" style="font-size: 0.75rem;">PHONES</p>
                                        <p class="fw-semibold mb-0">{{ contact1 }}</p>
                                        <p class="fw-semibold mb-1">{{ contact2 }}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p class="text-muted mb-0" style="font-size: 0.75rem;">EMAIL</p>
                                        <p class="fw-semibold mb-1">{{ compemail }}</p>
                                    </div>
                                </div>

                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <p class="text-muted mb-0" style="font-size: 0.75rem;">ADDRESS</p>
                                        <p class="fw-semibold mb-1">{{ address }}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <p class="text-muted mb-0" style="font-size: 0.75rem;">TIN NUMBER</p>
                                        <p class="fw-semibold mb-1">{{ tinnumber }}</p>
                                    </div>
                                </div>

                                <button class="btn btn-primary px-3 py-1" style="font-size: 0.75rem;"
                                        data-bs-toggle="modal" data-bs-target="#editContractorModal">
                                    Edit Details
                                </button>

                            </div>
                        </div>

                    </div>
                </div>

                <div class="tab-pane fade" id="settings">
                    <h4>Payments</h4>
                    <p>Manage Payments</p>
                </div>
            </div>
        </div>
    </main>

            <!-- Remove User Modal -->
    <div class="modal fade" id="removeUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">USER REMOVAL CONFIRMATION</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <form id="removeUserForm">
                    <div class="modal-body">
                        <p>Are you sure you want to remove the following user?</p>
                        
                        <div class="alert alert-info">
                            <strong>Name:</strong> <span id="modalUserName">Loading...</span><br>
                            <strong>Email:</strong> <span id="modalUserEmail">Loading...</span>
                        </div>

                        <div class="form-group mt-3">
                            <label for="passcodeInput" class="form-label">Enter Admin Passcode to Confirm</label>
                            <input type="password" class="form-control" id="passcodeInput" name="passcode" required>
                        </div>

                        <input type="hidden" name="user_id" id="modalUserId">
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Remove User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editContractorModal" tabindex="-1" aria-labelledby="editContractorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow" style="font-size: 0.82rem;">

                <div class="modal-header py-2">
                    <h6 class="modal-title fw-bold" id="editContractorModalLabel" style="font-size: 0.9rem;">
                        <i class="bi bi-building-fill-gear me-1" style="font-size: 0.85rem;"></i>
                        CONTRACTOR DETAILS EDITOR
                    </h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="transform: scale(.8);"></button>
                </div>

                <div class="modal-body p-3">

                    <form id="contractorEditForm">

                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold mb-1" style="font-size: 0.75rem;">Company Name</label>
                                <input type="text" class="form-control form-control-sm editable-field" value="{{ companyname }}">
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold mb-1" style="font-size: 0.75rem;">Phone 1</label>
                                <input type="text" class="form-control form-control-sm editable-field" value="{{ contact1 }}">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-semibold mb-1" style="font-size: 0.75rem;">Phone 2</label>
                                <input type="text" class="form-control form-control-sm editable-field" value="{{ contact2 }}">
                            </div>

                            <div class="col-md-6 mt-2">
                                <label class="form-label fw-semibold mb-1" style="font-size: 0.75rem;">Email</label>
                                <input type="email" class="form-control form-control-sm editable-field" value="{{ compemail }}">
                            </div>

                            <div class="col-md-6 mt-2">
                                <label class="form-label fw-semibold mb-1" style="font-size: 0.75rem;">TIN Number</label>
                                <input type="text" class="form-control form-control-sm editable-field" value="{{ tinnumber }}">
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold mb-1" style="font-size: 0.75rem;">Address</label>
                                <input type="text" class="form-control form-control-sm editable-field" value="{{ address }}">
                            </div>
                        </div>

                    </form>

                </div>

                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-danger btn-sm px-3" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary btn-sm px-3">Save Changes</button>
                </div>

            </div>
        </div>
    </div>

        <!-- Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #1E2A56; color: white;">
                    <h6 class="modal-title" id="notesModalLabel">
                        <i class="bi bi-list-ol"></i><span id="modalClientName"></span> - <span id="modalProjectName"></span> NOTES
                    </h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="transform: scale(.8);"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="notesProjectId">

                    <!-- Display Container for Existing Notes -->
                    <div class="notes-display-container mb-4">
                        <h6 class="mb-3">Existing Notes:</h6>
                        <div id="notesList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                            <!-- Notes will be loaded here -->
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-journal-text display-6"></i>
                                <p class="mt-2">No notes yet. Add your first note below.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add New Note Section -->
                    <div class="add-note-section">
                        <h6 class="mb-3">Add New Note:</h6>
                        <div class="mb-3">
                            <textarea class="form-control" id="newNoteText" rows="3" placeholder="Enter your note here..." style="resize: vertical;"></textarea>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-primary" id="addNoteBtn">
                                <i class="bi bi-plus-circle me-2"></i>Add Note
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" id="locations-data" value='{{ locations|tojson }}'>
    <input type="hidden" id="frequencies-data" value='{{ frequencies|tojson }}'>

  <!-- Bootstrap and jQuery Scripts -->


<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    // Global variables
let allEnquiriesData = [];
let filteredEnquiriesData = [];
let selectedEnquiries = new Set();

// Enquiry type configuration
const enquiryTypeConfig = {
    'kitchen_cabinets': {
        label: 'Kitchen & Cabinets',
        color: '#28a745',
        icon: 'bi-cup-straw'
    },
    'building': {
        label: 'Building',
        color: '#ffc107',
        icon: 'bi-building'
    },
    'renovation': {
        label: 'Renovation',
        color: '#17a2b8',
        icon: 'bi-house-up'
    },
    'otherenq': {
        label: 'Other',
        color: '#6c757d',
        icon: 'bi-three-dots'
    }
};

// Load enquiries data
function loadEnquiriesData() {
    console.log('Loading enquiries data...');
    showLoading(true);
    selectedEnquiries.clear();
    updateSelectionInfo();
    
    fetch('/get_temp_enquiries')
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Data received:', data);
            
            if (!Array.isArray(data)) {
                throw new Error('Data is not an array');
            }
            
            // Process data - ensure WhatsApp numbers are strings
            allEnquiriesData = data.map(enquiry => ({
                id: enquiry.id,
                wanumber: enquiry.wanumber ? enquiry.wanumber.toString() : '',
                enqtype: enquiry.enqtype || 'otherenq'
            }));
            
            console.log('Processed data:', allEnquiriesData);
            
            updateStatistics(allEnquiriesData);
            applyFilters();
            updateLastUpdated();
            showLoading(false);
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showError('Failed to load data. Check console for details.');
            showLoading(false);
        });
}

// Show/hide loading
function showLoading(show) {
    const loadingRow = document.getElementById('loadingRow');
    const noDataMessage = document.getElementById('noDataMessage');
    
    if (show) {
        loadingRow.classList.remove('d-none');
        noDataMessage.classList.add('d-none');
    } else {
        loadingRow.classList.add('d-none');
    }
}

// Show error
function showError(message) {
    const tableBody = document.getElementById('enquiriesTableBody');
    tableBody.innerHTML = `
        <tr>
            <td colspan="5" class="text-center py-5">
                <div class="d-flex flex-column align-items-center">
                    <i class="bi bi-exclamation-triangle text-danger fs-1 mb-3"></i>
                    <h5 class="text-danger mb-2">Error</h5>
                    <p class="text-muted mb-3">${message}</p>
                    <button class="btn btn-sm btn-primary" onclick="loadEnquiriesData()">
                        <i class="bi bi-arrow-clockwise me-1"></i> Try Again
                    </button>
                </div>
            </td>
        </tr>
    `;
}

// Update statistics
function updateStatistics(data) {
    const counts = {
        total: data.length,
        kitchen_cabinets: 0,
        building: 0,
        renovation: 0,
        otherenq: 0
    };
    
    data.forEach(enquiry => {
        const type = enquiry.enqtype || 'otherenq';
        if (counts.hasOwnProperty(type)) {
            counts[type]++;
        }
    });
    
    document.getElementById('totalEnquiries').textContent = counts.total;
    document.getElementById('kitchenCount').textContent = counts.kitchen_cabinets;
    document.getElementById('buildingCount').textContent = counts.building;
    document.getElementById('renovationCount').textContent = counts.renovation;
    document.getElementById('otherCount').textContent = counts.otherenq;
    document.getElementById('recordCount').textContent = `${counts.total} records`;
    document.getElementById('totalRecords').textContent = counts.total;
}

// Apply filters
function applyFilters() {
    const typeFilter = document.getElementById('enquiryTypeFilter').value;
    const whatsappFilter = document.getElementById('whatsappFilter').value.toLowerCase();
    const idFilter = document.getElementById('idFilter').value.toLowerCase();
    
    filteredEnquiriesData = allEnquiriesData.filter(enquiry => {
        // Type filter
        if (typeFilter !== 'all' && enquiry.enqtype !== typeFilter) {
            return false;
        }
        
        // WhatsApp filter
        if (whatsappFilter && enquiry.wanumber && 
            !enquiry.wanumber.toLowerCase().includes(whatsappFilter)) {
            return false;
        }
        
        // ID filter
        if (idFilter && enquiry.id && 
            !enquiry.id.toString().toLowerCase().includes(idFilter)) {
            return false;
        }
        
        return true;
    });
    
    renderTable();
    updateFilteredCount();
}

// Filter by type
function filterByType(type) {
    // Update active button
    document.querySelectorAll('#filterAll, #filterKitchen, #filterBuilding, #filterRenovation, #filterOther').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById(`filter${type === 'all' ? 'All' : type.charAt(0).toUpperCase() + type.slice(1)}`)?.classList.add('active');
    
    document.getElementById('enquiryTypeFilter').value = type;
    applyFilters();
}

// Reset filters
function resetFilters() {
    document.getElementById('enquiryTypeFilter').value = 'all';
    document.getElementById('whatsappFilter').value = '';
    document.getElementById('idFilter').value = '';
    document.getElementById('globalSearch').value = '';
    
    // Reset quick filter buttons
    document.querySelectorAll('#filterAll, #filterKitchen, #filterBuilding, #filterRenovation, #filterOther').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById('filterAll').classList.add('active');
    
    applyFilters();
}

// Apply global search
function applyGlobalSearch() {
    const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
    
    if (!searchTerm) {
        applyFilters();
        return;
    }
    
    filteredEnquiriesData = allEnquiriesData.filter(enquiry => {
        return (
            (enquiry.id && enquiry.id.toString().toLowerCase().includes(searchTerm)) ||
            (enquiry.wanumber && enquiry.wanumber.toLowerCase().includes(searchTerm)) ||
            (enquiry.enqtype && enquiry.enqtype.toLowerCase().includes(searchTerm))
        );
    });
    
    renderTable();
    updateFilteredCount();
}

// Render table
function renderTable() {
    const tableBody = document.getElementById('enquiriesTableBody');
    const noDataMessage = document.getElementById('noDataMessage');
    
    if (filteredEnquiriesData.length === 0) {
        tableBody.innerHTML = '';
        noDataMessage.classList.remove('d-none');
        updateShowingRecords();
        return;
    }
    
    noDataMessage.classList.add('d-none');
    
    let html = '';
    filteredEnquiriesData.forEach((enquiry, index) => {
        const typeConfig = enquiryTypeConfig[enquiry.enqtype] || enquiryTypeConfig['otherenq'];
        const isSelected = selectedEnquiries.has(enquiry.id.toString());
        
        html += `
            <tr class="${isSelected ? 'table-primary' : ''}">
                <td class="px-4 py-3">
                    <div class="d-flex align-items-center">
                        <div class="form-check me-2">
                            <input class="form-check-input enquiry-checkbox" 
                                   type="checkbox" 
                                   value="${enquiry.id}"
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleEnquirySelection(this)">
                        </div>
                        <span class="text-muted small">${index + 1}</span>
                    </div>
                </td>
                <td class="px-4 py-3">
                    <span class="badge bg-dark rounded-pill px-3 py-1">
                        ${enquiry.id}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-whatsapp text-success me-3"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${formatWhatsAppNumber(enquiry.wanumber)}</div>
                            <small class="text-muted d-block">Click to copy or message</small>
                        </div>
                        ${enquiry.wanumber ? `
                            <div class="d-flex gap-1">
                                <button class="btn btn-sm btn-outline-success" 
                                        onclick="copyWhatsAppNumber('${enquiry.wanumber}')"
                                        title="Copy Number">
                                    <i class="bi bi-copy"></i>
                                </button>
                                <a href="https://wa.me/${enquiry.wanumber}" 
                                   target="_blank" 
                                   class="btn btn-sm btn-success"
                                   title="Message on WhatsApp">
                                    <i class="bi bi-whatsapp"></i>
                                </a>
                            </div>
                        ` : ''}
                    </div>
                </td>
                <td class="px-4 py-3">
                    <div class="d-flex align-items-center">
                        <i class="bi ${typeConfig.icon} me-3" style="color: ${typeConfig.color}"></i>
                        <span class="badge rounded-pill px-3 py-1" 
                              style="background-color: ${typeConfig.color}; color: white;">
                            ${typeConfig.label}
                        </span>
                    </div>
                </td>
                <td class="px-4 py-3 text-center">
                    <div class="d-flex justify-content-center gap-1">
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="viewEnquiryDetails(${enquiry.id})"
                                title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="deleteEnquiry(${enquiry.id})"
                                title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = html;
    updateShowingRecords();
}

// Format WhatsApp number
function formatWhatsAppNumber(number) {
    if (!number || number === '') return 'Not Provided';
    
    const numStr = number.toString();
    const cleaned = numStr.replace(/\D/g, '');
    
    if (cleaned.length === 10) {
        return `+91 ${cleaned.substring(0,5)} ${cleaned.substring(5)}`;
    }
    
    if (cleaned.length === 12 && cleaned.startsWith('91')) {
        return `+${cleaned.substring(0,2)} ${cleaned.substring(2,7)} ${cleaned.substring(7)}`;
    }
    
    return numStr;
}

// Toggle select all
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.enquiry-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
            selectedEnquiries.add(checkbox.value);
        } else {
            selectedEnquiries.delete(checkbox.value);
        }
    });
    
    updateSelectionInfo();
    renderTable();
}

// Toggle individual selection
function toggleEnquirySelection(checkbox) {
    if (checkbox.checked) {
        selectedEnquiries.add(checkbox.value);
    } else {
        selectedEnquiries.delete(checkbox.value);
        document.getElementById('selectAll').checked = false;
    }
    
    updateSelectionInfo();
}

// Update selection info
function updateSelectionInfo() {
    const selectedInfo = document.getElementById('selectedInfo');
    if (selectedInfo) {
        selectedInfo.textContent = `${selectedEnquiries.size} selected`;
    }
}

// Update filtered count
function updateFilteredCount() {
    const filteredCount = document.getElementById('filteredCount');
    if (filteredCount) {
        filteredCount.textContent = filteredEnquiriesData.length;
    }
}

// Update showing records
function updateShowingRecords() {
    const showingRecords = document.getElementById('showingRecords');
    if (showingRecords) {
        showingRecords.textContent = filteredEnquiriesData.length;
    }
}

// Update last updated time
function updateLastUpdated() {
    const lastUpdated = document.getElementById('lastUpdated');
    if (lastUpdated) {
        const now = new Date();
        lastUpdated.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
}

// Copy WhatsApp number
function copyWhatsAppNumber(number) {
    if (!number) {
        alert('No WhatsApp number available');
        return;
    }
    
    const numberStr = number.toString();
    
    navigator.clipboard.writeText(numberStr)
        .then(() => {
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check"></i>';
            button.classList.remove('btn-outline-success');
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-success');
            }, 1000);
        })
        .catch(err => {
            console.error('Failed to copy:', err);
            alert('Failed to copy number');
        });
}

// Copy selected numbers
function copySelectedNumbers() {
    if (selectedEnquiries.size === 0) {
        alert('Please select enquiries first');
        return;
    }
    
    const numbers = [];
    selectedEnquiries.forEach(id => {
        const enquiry = allEnquiriesData.find(e => e.id.toString() === id);
        if (enquiry && enquiry.wanumber) {
            numbers.push(enquiry.wanumber);
        }
    });
    
    if (numbers.length === 0) {
        alert('No WhatsApp numbers in selected enquiries');
        return;
    }
    
    const numbersText = numbers.join('\n');
    navigator.clipboard.writeText(numbersText)
        .then(() => {
            alert(`${numbers.length} numbers copied to clipboard`);
        })
        .catch(err => {
            console.error('Copy failed:', err);
            alert('Failed to copy numbers');
        });
}

// Delete selected enquiries
function deleteSelectedEnquiries() {
    if (selectedEnquiries.size === 0) {
        alert('Please select enquiries to delete');
        return;
    }
    
    if (!confirm(`Delete ${selectedEnquiries.size} selected enquiry(s)?`)) {
        return;
    }
    
    fetch('/batch_delete_enquiries', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enquiry_ids: Array.from(selectedEnquiries)})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${selectedEnquiries.size} enquiry(s) deleted`);
            selectedEnquiries.clear();
            loadEnquiriesData();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete enquiries');
    });
}

// Delete single enquiry
function deleteEnquiry(id) {
    if (!confirm('Delete this enquiry?')) return;
    
    fetch('/delete_temp_enquiry', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enquiry_id: id})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Enquiry deleted');
            loadEnquiriesData();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete enquiry');
    });
}

// Clear selection
function clearSelection() {
    selectedEnquiries.clear();
    document.getElementById('selectAll').checked = false;
    document.querySelectorAll('.enquiry-checkbox').forEach(cb => cb.checked = false);
    updateSelectionInfo();
    renderTable();
}

// Scroll to top
function scrollToTop() {
    const tableContainer = document.querySelector('.position-relative');
    if (tableContainer) {
        tableContainer.scrollTop = 0;
    }
}

// View enquiry details
function viewEnquiryDetails(id) {
    const enquiry = allEnquiriesData.find(e => e.id === id);
    if (!enquiry) return;
    
    const typeConfig = enquiryTypeConfig[enquiry.enqtype] || enquiryTypeConfig['otherenq'];
    
    const detailHTML = `
        <div class="modal fade" id="detailModal">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: ${typeConfig.color}; color: white;">
                        <h6 class="modal-title">
                            <i class="bi ${typeConfig.icon} me-2"></i>
                            Enquiry Details
                        </h6>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label small text-muted">Enquiry ID</label>
                            <div class="fw-bold">${enquiry.id}</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Enquiry Type</label>
                            <div>
                                <span class="badge" style="background-color: ${typeConfig.color}; color: white;">
                                    ${typeConfig.label}
                                </span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">WhatsApp Number</label>
                            <div class="fw-bold">${formatWhatsAppNumber(enquiry.wanumber)}</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary btn-sm" onclick="copyEnquiryDetails(${enquiry.id})">
                            <i class="bi bi-copy me-1"></i> Copy Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const container = document.createElement('div');
    container.innerHTML = detailHTML;
    document.body.appendChild(container.firstChild);
    
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    modal.show();
    
    modal._element.addEventListener('hidden.bs.modal', function () {
        document.body.removeChild(this.parentElement);
    });
}

// Copy enquiry details
function copyEnquiryDetails(id) {
    const enquiry = allEnquiriesData.find(e => e.id === id);
    if (!enquiry) return;
    
    const details = `ID: ${enquiry.id}\nType: ${enquiryTypeConfig[enquiry.enqtype]?.label || 'Other'}\nWhatsApp: ${enquiry.wanumber || 'N/A'}`;
    
    navigator.clipboard.writeText(details)
        .then(() => alert('Details copied to clipboard!'))
        .catch(err => console.error('Copy failed:', err));
}

// Export to Excel (requires SheetJS)
function exportToExcel() {
    if (filteredEnquiriesData.length === 0) {
        alert('No data to export');
        return;
    }
    
    if (typeof XLSX === 'undefined') {
        alert('Excel export requires SheetJS library. Exporting as CSV instead.');
        exportToCSV();
        return;
    }
    
    const wsData = [
        ['ID', 'WhatsApp Number', 'Enquiry Type'],
        ...filteredEnquiriesData.map(enquiry => [
            enquiry.id,
            enquiry.wanumber || '',
            enquiryTypeConfig[enquiry.enqtype]?.label || 'Other'
        ])
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Enquiries');
    XLSX.writeFile(wb, `enquiries_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// Export to CSV
function exportToCSV() {
    if (filteredEnquiriesData.length === 0) {
        alert('No data to export');
        return;
    }
    
    const headers = ['ID', 'WhatsApp Number', 'Enquiry Type'];
    const csvRows = [
        headers.join(','),
        ...filteredEnquiriesData.map(enquiry => [
            `"${enquiry.id}"`,
            `"${enquiry.wanumber || ''}"`,
            `"${enquiryTypeConfig[enquiry.enqtype]?.label || 'Other'}"`
        ].join(','))
    ];
    
    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `enquiries_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Print report
function printReport() {
    if (filteredEnquiriesData.length === 0) {
        alert('No data to print');
        return;
    }
    
    const printWindow = window.open('', '_blank');
    const date = new Date().toLocaleDateString();
    
    let html = `
        <html>
        <head>
            <title>Enquiries Report - ${date}</title>
            <style>
                body { font-family: Arial; margin: 20px; }
                h1 { border-bottom: 2px solid #007bff; padding-bottom: 10px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th { background: #f8f9fa; padding: 10px; text-align: left; }
                td { padding: 8px; border-bottom: 1px solid #ddd; }
            </style>
        </head>
        <body>
            <h1>Enquiries Report</h1>
            <p>Date: ${date}</p>
            <p>Total: ${filteredEnquiriesData.length} records</p>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>WhatsApp Number</th>
                        <th>Enquiry Type</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    filteredEnquiriesData.forEach(enquiry => {
        const typeConfig = enquiryTypeConfig[enquiry.enqtype] || enquiryTypeConfig['otherenq'];
        html += `
            <tr>
                <td>${enquiry.id}</td>
                <td>${enquiry.wanumber || 'N/A'}</td>
                <td>${typeConfig.label}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </body>
        </html>
    `;
    
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();
}

// Initialize modal
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('viewEnquiriesModal');
    if (modal) {
        modal.addEventListener('shown.bs.modal', function() {
            loadEnquiriesData();
        });
    }
});
</script>

<script>


document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('enquirySearch');
    const categoryFilter = document.getElementById('categoryFilter');
    const statusFilter = document.getElementById('statusFilter');
    const clearBtn = document.getElementById('clearFilters');
    const resultsCount = document.getElementById('resultsCount');
    const enquiryRows = document.querySelectorAll('.enquiry-row');
    
    console.log('Enquiry rows found:', enquiryRows.length);
    
    function filterEnquiries() {
        console.log('Filtering...');
        const searchTerm = searchInput.value.toLowerCase();
        const categoryValue = categoryFilter.value;
        const statusValue = statusFilter.value;
        
        let visibleCount = 0;
        
        enquiryRows.forEach(row => {
            const category = row.getAttribute('data-category');
            const status = row.getAttribute('data-status');
            const client = row.getAttribute('data-client') || '';
            const username = row.getAttribute('data-username') || '';
            const message = row.getAttribute('data-message') || '';
            
            console.log('Row data:', {category, status, client, username});
            
            // Check filters
            const categoryMatch = !categoryValue || category === categoryValue;
            const statusMatch = !statusValue || status === statusValue;
            
            // Check search
            const searchMatch = !searchTerm || 
                client.toString().includes(searchTerm) ||
                username.toLowerCase().includes(searchTerm) ||
                message.toLowerCase().includes(searchTerm);
            
            if (categoryMatch && statusMatch && searchMatch) {
                row.style.display = '';
                visibleCount++;
                console.log('Showing row');
            } else {
                row.style.display = 'none';
                console.log('Hiding row');
            }
        });
        
        resultsCount.textContent = `Showing ${visibleCount} of ${enquiryRows.length} enquiries`;
        console.log('Visible count:', visibleCount);
    }
    
    // Event listeners
    if (searchInput) {
        searchInput.addEventListener('input', filterEnquiries);
        console.log('Search input listener added');
    }
    
    if (categoryFilter) {
        categoryFilter.addEventListener('change', filterEnquiries);
        console.log('Category filter listener added');
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', filterEnquiries);
        console.log('Status filter listener added');
    }
    
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            searchInput.value = '';
            categoryFilter.value = '';
            statusFilter.value = '';
            filterEnquiries();
            console.log('Filters cleared');
        });
    }
    
    // Initial filter
    filterEnquiries();

// Message expand/collapse
document.addEventListener('click', function(e) {

    // Expand message
    if (e.target.classList.contains('expand-message')) {
        const enquiryId = e.target.getAttribute('data-id');
        document.querySelector(`#message-full-${enquiryId}`).style.display = 'block';
        e.target.parentElement.style.display = 'none';
    }
    
    // Collapse message
    if (e.target.classList.contains('collapse-message')) {
        const enquiryId = e.target.getAttribute('data-id');
        document.querySelector(`#message-full-${enquiryId}`).style.display = 'none';
        document.querySelector(`#enquiry-row-${enquiryId} .message-preview`).style.display = 'block';
    }
    
    // Status update
    if (e.target.classList.contains('status-select')) {
        // Store the select element
        const select = e.target;
        
        // Add a change event listener that triggers on click away
        select.addEventListener('change', function handleChange() {
            const enquiryId = select.getAttribute('data-id');
            const newStatus = select.value;
            
            fetch(`/api/enquiries/${enquiryId}/status`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({status: newStatus})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(' ' + data.message);
                } else {
                    alert(' ' + data.message);
                }
            })
            .catch(error => {
                alert('Network error: ' + error);
            });
            
            // Remove the listener to prevent multiple calls
            select.removeEventListener('change', handleChange);
        });
    }
});

function viewEnquiry(id) {
    window.open(`/api/enquiries/${id}`, '_blank');
}

// Optional: Add some CSS for better message display
const style = document.createElement('style');
style.textContent = `
    .message-container {
        max-width: 300px;
    }
    .message-preview, .message-full {
        word-wrap: break-word;
        white-space: pre-wrap;
    }
    .expand-message, .collapse-message {
        color: #3498db;
        cursor: pointer;
        font-size: 11px;
        text-decoration: none;
    }
    .expand-message:hover, .collapse-message:hover {
        text-decoration: underline;
    }
    .message-full {
        background: #f8f9fa;
        padding: 4px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        margin-top: 5px;
    }
`;
document.head.appendChild(style);

        });
</script>

<script>
    // Apply filter button (AJAX version)
document.addEventListener('DOMContentLoaded', function() {
    // FIRST, check the actual table structure
    const table = document.getElementById('allprojectsTable');
    if (table) {
        const headerRow = table.querySelector('thead tr');
        const columns = headerRow ? headerRow.querySelectorAll('th').length : 0;
        console.log('Actual number of columns in table:', columns);
        
        // List all column headers
        if (headerRow) {
            headerRow.querySelectorAll('th').forEach((th, index) => {
                console.log(`Column ${index}:`, th.textContent.trim());
            });
        }
    }
    
    // HARD-CODED VERSION - Use the exact column indices from your table
    // Based on your columnMapping, you want to show:
    // id(0), momid(46), clientname(1), projectname(10), projectadministratorname(13), projectstartdate(14), action(47)
    // Hide everything else: indices 2-9, 11-12, 15-45
    
    window.dataTable = $('#allprojectsTable').DataTable({
        order: [[0, 'desc']],
        paging: false,
        searching: true,
        ordering: true,
        info: true,
        pageLength: 7,
        lengthChange: false,
        columnDefs: [
            // Hide columns 2-45 (everything except the 7 we want)
            { targets: [2,3,4,5,6,7,8,9,11,12,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46], visible: false },
            // Show columns 0,1,10,13,14,46,47
            { targets: [0,1,10,13,14,47], visible: true }
        ]
    });
    
    console.log('DataTable initialized with column visibility settings');
    
    // Keep your filter code but FIX the reinitialization
    document.getElementById('applyFilterBtn').addEventListener('click', function() {
        const selectedMonth = document.getElementById('monthFilter').value;
        
        console.log('Applying filter for month:', selectedMonth);
        
        // Show loading
        const tableContainer = document.querySelector('.mainalldata');
        tableContainer.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading filtered projects...</p>
            </div>
        `;
        
        // Fetch filtered data
        fetch(`/get_filtered_projects/${selectedMonth}`)
            .then(response => response.json())
            .then(data => {
                console.log('Filter response received');
                
                if (data.status === 'success') {
                    tableContainer.innerHTML = data.html;
                    
                    // Check the new table structure
                    const newTable = document.getElementById('allprojectsTable');
                    if (newTable) {
                        const newHeaderRow = newTable.querySelector('thead tr');
                        const newColumns = newHeaderRow ? newHeaderRow.querySelectorAll('th').length : 0;
                        console.log('New table columns after filter:', newColumns);
                    }
                    
                    // Destroy old DataTable
                    if ($.fn.DataTable.isDataTable('#allprojectsTable')) {
                        window.dataTable.destroy();
                    }
                    
                    // Reinitialize with SAME column settings
                    window.dataTable = $('#allprojectsTable').DataTable({
                        order: [[0, 'desc']],
                        paging: false,
                        searching: true,
                        ordering: true,
                        info: true,
                        pageLength: 7,
                        lengthChange: false,
                        columnDefs: [
                            // SAME COLUMN SETTINGS
                            { targets: [2,3,4,5,6,7,8,9,11,12,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46], visible: false },
                            { targets: [0,1,10,13,14,47], visible: true }
                        ]
                    });
                    
                    console.log('DataTable reinitialized after filter');
                } else {
                    alert('Error loading data: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to load filtered projects');
            });
    });
});


</script>
<script>
    // Password toggle for admin passcode in delete modal
    document.addEventListener('DOMContentLoaded', function() {
        const toggleAdminPassword = document.getElementById('toggleAdminPassword');
        const adminPasscodeInput = document.getElementById('adminPasscode');
        
        if (toggleAdminPassword && adminPasscodeInput) {
            toggleAdminPassword.addEventListener('click', function() {
                // Toggle password visibility
                const type = adminPasscodeInput.getAttribute('type') === 'password' ? 'text' : 'password';
                adminPasscodeInput.setAttribute('type', type);
                
                // Toggle eye icon
                if (type === 'text') {
                    this.classList.remove('bi-eye');
                    this.classList.add('bi-eye-slash');
                } else {
                    this.classList.remove('bi-eye-slash');
                    this.classList.add('bi-eye');
                }
            });
        }
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {

    const dueDateType = document.getElementById('due_date_type');
    const monthsToPay = document.getElementById('monthstopay');
    const manualInstallments = document.getElementById('manualInstallments');

    function generateManualInstallments() {
        const months = parseInt(monthsToPay.value);
        manualInstallments.innerHTML = '';


        if (!months || months <= 0) {
            alert('You need to enter a valid number of Months To Pay before you can manually set installment due dates. Kindly fix.');
            manualInstallments.style.display = 'none';
            dueDateType.value = 'auto';
            return;
        }

        for (let i = 2; i <= months; i++) {
            const wrapper = document.createElement('div');
            wrapper.className = 'col-12';

            wrapper.innerHTML = `
                <div class="form-group row align-items-center" style="margin-bottom: 0.5rem;">
                    <label class="col-auto col-form-label" style="padding-right: 0.5rem;">
                        Installment ${i} Due Date:
                    </label>
                    <div class="col">
                        <input type="date"
                               class="form-control editable-field"
                               name="installment_due_dates[]"
                               required>
                    </div>
                </div>
            `;

            manualInstallments.appendChild(wrapper);
        }
    }

    dueDateType.addEventListener('change', function () {
        if (this.value === 'manual') {
            manualInstallments.style.display = 'block';
            generateManualInstallments();
        } else {
            manualInstallments.style.display = 'none';
            manualInstallments.innerHTML = '';
        }
    });

    monthsToPay.addEventListener('input', function () {
        if (dueDateType.value === 'manual') {
            generateManualInstallments();
        }
    });

});
</script>

<script>
// Function to decode HTML entities (needed because we use html.escape())
function decodeHtmlEntities(text) {
    const textarea = document.createElement('textarea');
    textarea.innerHTML = text;
    return textarea.value;
}

// Handle modal show event
document.getElementById('removeUserModal').addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    
    // Extract data from button attributes
    const userId = button.getAttribute('data-user-id');
    const userNameEncoded = button.getAttribute('data-user-name') || '';
    const userEmailEncoded = button.getAttribute('data-user-email') || '';
    
    // Decode the HTML entities
    const userName = decodeHtmlEntities(userNameEncoded);
    const userEmail = decodeHtmlEntities(userEmailEncoded);
    
    // Populate modal fields
    document.getElementById('modalUserId').value = userId;
    document.getElementById('modalUserName').textContent = userName;
    document.getElementById('modalUserEmail').textContent = userEmail;
});

// Handle form submission (using your pattern)
document.getElementById("removeUserForm").addEventListener("submit", async function(e) {
    e.preventDefault(); // Stop normal form submit

    const passcode = document.getElementById("passcodeInput").value.trim();
    const userId = document.getElementById("modalUserId").value;

    // Validate passcode (use the same as your create user)
    if (passcode !== "conlink01admin01") {
        alert("Invalid Admin Permission Passcode.");
        return;
    }

    // Collect form data
    const data = {
        user_id: userId,
        passcode: passcode
    };

    // Send to Flask route
    try {
        const response = await fetch("/remove-system-user", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === "success") {
            alert("User removed successfully!");
            
            // Reset form
            this.reset();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById("removeUserModal"));
            modal.hide();
            
            // Optional: Remove the row from table or refresh page
            // location.reload(); // Refresh page
            
        } else {
            alert("Error: " + result.message);
        }

    } catch (error) {
        console.error("Request failed", error);
        alert("Failed to remove user.");
    }
});

// Optional: Clear form when modal is hidden
document.getElementById('removeUserModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('removeUserForm').reset();
    document.getElementById('modalUserId').value = '';
    document.getElementById('modalUserName').textContent = 'Loading...';
    document.getElementById('modalUserEmail').textContent = 'Loading...';
});
</script>
<script>

document.getElementById("getdepositReceiptBtn").addEventListener("click", async function(e) {
    e.preventDefault();

    const projectId = document.getElementById("updateProjectId").value; // get project ID
    const btn = this;
    const spinner = document.getElementById("depositSpinner");
    const textSpan = document.getElementById("depositText");

    // Show spinner
    btn.disabled = true;
    spinner.classList.remove("d-none");
    textSpan.textContent = "Generating...";

    try {
        const response = await fetch(`/download_deposit_receipt/${projectId}`, {
            method: 'GET'
        });

        if (!response.ok) throw new Error("Failed to generate receipt");

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Deposit_Receipt_Project_${projectId}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

    } catch (err) {
        console.error(err);
        alert(" Failed to download deposit receipt");
    } finally {
        // Hide spinner
        btn.disabled = false;
        spinner.classList.add("d-none");
        textSpan.textContent = "Get Receipt";
    }
});



</script>
<script>
document.addEventListener("DOMContentLoaded", function() {

// When "Change First Installment Due Date" button is clicked, open modal and set project ID
document.getElementById("changeInstallmentDateBtn").addEventListener("click", function() {
    const projectId = document.getElementById("updateProjectId").value; // From main modal
    document.getElementById("modalProjectId").value = projectId;

    // Optionally prefill the current first installment date
    const currentDate = document.getElementById("updateInstallment1DueDate").value;
    document.getElementById("modalNewDueDate").value = currentDate;

    // Show the modal
    var modal = new bootstrap.Modal(document.getElementById("changeInstallmentDateModal"));
    modal.show();
});

// Handle Save Changes
document.getElementById("saveNewInstallmentDateBtn").addEventListener("click", function() {
    const projectId = document.getElementById("modalProjectId").value;
    const newDate = document.getElementById("modalNewDueDate").value;
    const saveText = document.getElementById("saveDateText");
    const spinner = document.getElementById("saveDateSpinner");

    if (!newDate) {
        alert("Please select a new due date.");
        return;
    }

    // Show spinner
    spinner.classList.remove("d-none");
    saveText.textContent = "Saving...";

    fetch("/update_first_installment_date", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            project_id: projectId,
            new_date: newDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(" First installment date and all other installment dates updated successfully!");

            // Update main modal field
            document.getElementById("updateInstallment1DueDate").value = newDate;

            // Close modal
            var modalInstance = bootstrap.Modal.getInstance(document.getElementById("changeInstallmentDateModal"));
            modalInstance.hide();
        } else {
            alert(" Failed to update: " + data.message);
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert(" Error updating first installment date.");
    })
    .finally(() => {
        // Reset button text and hide spinner
        spinner.classList.add("d-none");
        saveText.textContent = "Save Changes";
    });
});
})
</script>
<script>
    var quillProjectScope = new Quill('#projectScopeEditor', {
        theme: 'snow',
        modules: {
            toolbar: '#projectScopeToolbar'
        }
    });

    // When submitting form, store Quill HTML into hidden input
    document.getElementById("addProjectForm").addEventListener("submit", function() {
        document.getElementById("project_description").value = quillProjectScope.root.innerHTML;
    });
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {

    const loaderxyz = document.getElementById("edsLoader2");
    const formxyzg = document.getElementById("updateProjectForm");

    // Show loader when the form is submitted
    formxyzg.addEventListener("submit", function () {
        loaderxyz.style.display = "flex";   // show loader
    });


    const locations = JSON.parse(document.getElementById('locations-data').value);
    const frequencies = JSON.parse(document.getElementById('frequencies-data').value);

    const ctx = document.getElementById('projectsByLocationChart').getContext('2d');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: locations,
            datasets: [{
                label: 'Number of Projects',
                data: frequencies,
                backgroundColor: '#1E2A56', // dark blue bars
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const completed = parseInt(document.getElementById('completed-projects').value, 10) || 0;
    const ongoing = parseInt(document.getElementById('ongoing-projects').value, 10) || 0;

    const ctx = document.getElementById('leaveByTypeChart').getContext('2d');

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Completed Projects', 'Ongoing Projects'],
            datasets: [{
                data: [completed, ongoing],
                backgroundColor: ['#28a745', '#dc3545'], // green for completed, red for ongoing
                borderColor: ['#fff', '#fff'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
});
</script>

<script>

document.getElementById("downloadpaymentshistory").addEventListener("click", function () {
    const projectId = document.getElementById("updateProjectId").value;

    if (!projectId) {
        alert("Project ID missing!");
        return;
    }

    const btn = this;
    const spinner = document.getElementById("downloadSpinner");
    const text = document.getElementById("downloadText");

    // Start spinner & disable button
    spinner.classList.remove("d-none");
    text.textContent = "Preparing File...";
    btn.disabled = true;

    // Trigger file download
    window.location.href = `/download_payments_history/${projectId}`;

    // Best available solution:
    // Detect when user comes back to page after download dialog closes
    const stopSpinner = () => {
        spinner.classList.add("d-none");
        text.textContent = "Download Payments History";
        btn.disabled = false;
        window.removeEventListener("focus", stopSpinner);
    };

    // When user returns focus  assume download triggered
    window.addEventListener("focus", stopSpinner);

    // Extra safety timeout (in case browser does not blur)
    setTimeout(stopSpinner, 4000);
});
</script>

<script>

function downloadenquiries() {
    const btn = document.getElementById("exportenquiriesBtn");
    const statusFilter = document.getElementById("statusFilter")?.value || 'all';
    
    // Show spinner
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `
        <span class="spinner-border spinner-border-sm me-2"></span>
        Downloading...
    `;
    
    // Create hidden link for download with status filter
    const link = document.createElement("a");
    link.href = `/export-enquiries?status=${statusFilter}`;
    link.download = "";
    link.style.display = "none";
    document.body.appendChild(link);
    
    // Click the link to start download
    link.click();
    
    // Remove link
    document.body.removeChild(link);
    
    // Reset button after short delay
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }, 2500);
}


function downloadPortfolio() {
    const btn = document.getElementById("exportprojectportBtn");

    // Show spinner
    btn.disabled = true;
    btn.innerHTML = `
        <span class="spinner-border spinner-border-sm me-2"></span>
        Downloading...
    `;

    // Create hidden link for download
    const link = document.createElement("a");
    link.href = "/export-projects-portfolio";
    link.download = "";
    link.style.display = "none";
    document.body.appendChild(link);

    // Click the link to start download
    link.click();

    // Remove link
    document.body.removeChild(link);

    // Reset button after short delay
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = `<i class="bi bi-journal-text"></i> Download Master File`;
    }, 2500); // 2.5 seconds works well
}


async function downloadInstallmentSchedule() {
    const btn = document.getElementById("installmentscheduleBtn");
    const originalHTML = btn.innerHTML;
    
    try {
        // Show loading
        btn.disabled = true;
        btn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2"></span>
            Generating Report...
        `;
        
        // Use fetch instead of direct link click
        const response = await fetch('/export-installments-schedule-excel');
        
        if (!response.ok) {
            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }
        
        // Get the blob from response
        const blob = await response.blob();
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // Get filename from content-disposition header or use default
        const contentDisposition = response.headers.get('content-disposition');
        // Add to your function:
        const now = new Date();
        const timestamp = now.toISOString().slice(0, 19).replace(/[:T]/g, '-'); // "2024-01-04-14-30-45"
        const filename = `installments_${timestamp}.xlsx`;
        
        if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename="(.+)"/);
            if (filenameMatch) {
                filename = filenameMatch[1];
            }
        }
        
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
    } catch (error) {
        console.error('Download error:', error);
        alert(`Failed to download: ${error.message}`);
    } finally {
        // Reset button
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

</script>


<script>
document.getElementById("createUserForm").addEventListener("submit", async function (e) {
    e.preventDefault(); // Stop normal form submit

    const passcode = document.getElementById("permissionPasscode").value.trim();

    // Validate passcode
    if (passcode !== "conlink01admin01") {
        alert("Invalid Admin Permission Passcode.");
        return;
    }

    // Collect form data
    const data = {
        fullname: this.userfullname.value,
        email: this.useremail.value,
        password: this.userpassword.value,
        whatsapp: this.userwhatsapp.value
    };

    // Send to Flask route
    try {
        const response = await fetch("/create-system-user", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === "success") {
            alert("User created successfully!");
            this.reset();
            const modal = bootstrap.Modal.getInstance(document.getElementById("createUserModal"));
            modal.hide();
        } else {
            alert("Error: " + result.message);
        }

    } catch (error) {
        console.error("Request failed", error);
        alert("Failed to save user.");
    }
});
</script>

<script>

    // Add this to your existing JavaScript
$(document).ready(function() {
    // Handle Delete button click in the update modal
    $(document).on('click', '.delete-project-btn', function() {
        // Get project details from the update modal fields
        const projectId = $('#updateProjectId').val();
        const clientName = $('#updateClientName').val();
        const projectName = $('#updateProjectName').val();
        
        // Debug log to ensure we're getting the values
        console.log('Delete clicked:', { projectId, clientName, projectName });
        
        // Populate the delete modal fields
        $('#deleteProjectId').val(projectId);
        $('#updateProjectIdDelete').text(projectId); // For the display span
        $('#deleteClientNameDisplay').text(clientName);
        $('#deleteProjectNameDisplay').text(projectName);
        
        // Also populate hidden fields for form submission
        $('#deleteClientName').val(clientName);
        $('#deleteProjectName').val(projectName);
    });
    
    // Handle form submission for delete project
    $('#deleteProjectForm').submit(async function(e) {
        e.preventDefault();
        
        const btn = $('#confirmDeleteBtn');
        const btnText = $('#deleteBtnText');
        const spinner = $('#deleteSpinner');
        
        // Show loading state
        btn.prop('disabled', true);
        spinner.removeClass('d-none');
        btnText.text('Deleting...');
        
        try {
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Add admin passcode validation
            if (data.admin_passcode !== "conlink01admin01") {
                alert("Invalid admin passcode!");
                return;
            }
            
            const response = await fetch('/delete_project', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                alert(' Project deleted successfully!');
                
                // Close both modals
                $('#deleteprojectModal').modal('hide');
                $('#updateModal').modal('hide');
                
                // Refresh the page to update the table
                setTimeout(() => {
                    location.reload();
                }, 500);
                
            } else {
                alert(' Error: ' + result.message);
            }
            
        } catch (error) {
            console.error('Delete error:', error);
            alert(' Failed to delete project');
        } finally {
            // Reset button state
            btn.prop('disabled', false);
            spinner.addClass('d-none');
            btnText.text('Delete Project Permanently');
        }
    });
    
    // Clear form when delete modal is closed
    $('#deleteprojectModal').on('hidden.bs.modal', function() {
        $('#deleteProjectForm')[0].reset();
        $('#deleteClientNameDisplay').text('');
        $('#deleteProjectNameDisplay').text('');
        $('#updateProjectIdDelete').text('');
    });








    // Function to load notes for a project
    function loadNotes(projectId, projectName, clientName, clientWaNumber, clientNextOfKinNumber) {
        // Set project ID in hidden field
        $('#notesProjectId').val(projectId);        
        $('#modalProjectName').text(projectName);
        $('#modalClientName').text(clientName);
        $('#modalclientWaNumber').text(clientWaNumber);
        $('#modalclientNextOfKinNumber').text(clientNextOfKinNumber);

        // Clear the textarea
        $('#newNoteText').val('');
        
        // Show loading in notes container
        $('#notesList').html(`
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading notes...</p>
            </div>
        `);
        
        // Fetch notes from server
        $.ajax({
            url: '/get_notes/' + projectId,
            method: 'GET',
            success: function(response) {
                displayNotes(response.notes || []);
            },
            error: function() {
                $('#notesList').html(`
                    <div class="alert alert-danger">
                        Failed to load notes. Please try again.
                    </div>
                `);
            }
        });
    }

    
    // Function to display notes in the container
    function displayNotes(notes) {
        const notesList = $('#notesList');
        
        if (notes.length === 0) {
            notesList.html(`
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-journal-text display-6"></i>
                    <p class="mt-2">No notes yet. Add your first note below.</p>
                </div>
            `);
            return;
        }
        
        let notesHtml = '';
        notes.forEach((note, index) => {
            const date = new Date(note.timestamp).toLocaleString();
            notesHtml += `
                <div class="card mb-1 ${index !== 0 ? 'mt-1' : ''}" style="border-radius: 0.25rem;">
                    <div class="card-body p-1">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <span class="badge bg-light text-dark py-0 px-1" style="font-size: 0.7rem;">Note #${index + 1}</span>
                            <small class="text-muted" style="font-size: 0.65rem;">${date}</small>
                        </div>
                        <p class="card-text mb-0" style="font-size: 0.75rem; line-height: 1rem;">${escapeHtml(note.note_text)}</p>
                    </div>
                </div>
            `;
        });
        
        notesList.html(notesHtml);
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
$('#addNoteBtn').click(function() {
    const projectId = $('#notesProjectId').val();
    const noteText = $('#newNoteText').val().trim();
    const clientName = $('#modalClientName').text(); // Get client name from modal
    const projectName = $('#modalProjectName').text(); // Get project name from modal
    const clientWaNumber = $('#notesModal').data('clientWaNumber') || '';
    const clientNextOfKinNumber = $('#notesModal').data('clientNextOfKinNumber') || '';

    if (!projectId) {
        alert('No project selected');
        return;
    }
    
    if (!noteText) {
        alert('Please enter a note');
        $('#newNoteText').focus();
        return;
    }
    
    // Disable button and show loading
    const btn = $(this);
    const originalText = btn.html();
    btn.html('<span class="spinner-border spinner-border-sm me-2"></span>Adding...');
    btn.prop('disabled', true);
    
    // Send note to server
    $.ajax({
        url: '/add_note',
        method: 'POST',
        data: {
            project_id: projectId,
            note_text: noteText,
            client_name: clientName,
            project_name: projectName,
            client_wa_number: clientWaNumber,
            client_next_of_kin_number: clientNextOfKinNumber
        },
        success: function(response) {
            console.log('Response:', response);
            
            // Check if response is valid JSON and has success
            if (response && response.success === true) {
                // Clear textarea
                $('#newNoteText').val('');
                
                // Reload notes
                loadNotes(projectId, projectName, clientName, clientWaNumber, clientNextOfKinNumber);
                
                // Show success message
                alert('Note added successfully!');

            } else {
                const errorMsg = response?.message || response?.error || 'Failed to add note';
                alert('Error: ' + errorMsg);
            }
        },
        error: function(xhr, status, error) {
            console.error('AJAX Error:', status, error, xhr.responseText);
            alert('Failed to add note. Please try again.');
        }
    }).always(function() {
        // This runs whether success or error - ALWAYS RESETS THE BUTTON
        console.log('AJAX complete - resetting button');
        btn.html(originalText);
        btn.prop('disabled', false);
    });
});

    // Optional: Add keyboard shortcut (Ctrl+Enter to add note)
    $('#newNoteText').keydown(function(e) {
        if (e.ctrlKey && e.keyCode === 13) { // Ctrl + Enter
            $('#addNoteBtn').click();
        }
    });
    
    // Clear textarea when modal is hidden
    $('#notesModal').on('hidden.bs.modal', function() {
        $('#newNoteText').val('');
        $('#notesProjectId').val('');
    });
    
    // Update the notes button click handler if you removed onclick attribute
    $(document).on('click', '.notes-btn', function() {
        const $row = $(this).closest('tr');
        const rowData = window.dataTable.row($row).data();
        
        // Get data from DataTables row data (includes hidden columns)
        const projectId = rowData[46]; // Assuming 'id' is column 0
        const projectName = rowData[10]; // Assuming 'projectname' is column 10
        const clientName = rowData[1]; // Assuming 'clientname' is column 1
        const clientWaNumber = rowData[4]; // Assuming 'clientwanumber' is column 4
        const clientNextOfKinNumber = rowData[8]; // Assuming 'clientnextofkinphone' is column 8

        
        console.log('Button data:', {
            projectId, projectName, clientName, 
            clientWaNumber, clientNextOfKinNumber
        });
        
        // Store data in modal
        $('#notesModal').data('clientWaNumber', clientWaNumber);
        $('#notesModal').data('clientNextOfKinNumber', clientNextOfKinNumber);
        
        loadNotes(projectId, projectName, clientName, clientWaNumber, clientNextOfKinNumber);
    });

});
</script>

<script>
$(document).ready(function() {

    // Handle Update button click
    $(document).on('click', '.update-project-btn', function () {
        // Get the table row that contains this button
        const $row = $(this).closest('tr');
        const table = window.dataTable;
        const rowData = table.row($row).data(); // This gets ALL data including hidden

        // Get data from table cells - adjust indices based on your table structure
        // You'll need to check what column index each data is in
        const momid = rowData[0]; // First column (ID)
        const clientName = rowData[1]; // Second column (Client Name)
        const projectName = rowData[10]; // Tenth column (Project Name)
        const projectScope = rowData[12]; // Project Scope
        const totalcontractamount = rowData[17]; // Total Contract Amount
        const adminName = rowData[13]; // Admin Name
        const monthstopay = rowData[19]; // Months to Pay
        const completionStatus = rowData[44]; // Status
        const depositorbullet = rowData[23]; // Deposit amount
        const datedepositorbullet = rowData[24]; // Deposit date
        const installment1Amount = rowData[26]; // Installment 1 amount
        const installment1DueDate = rowData[27]; // Installment 1 due date
        const installment1Date = rowData[28]; // Installment 1 paid date
        const installment2Amount = rowData[29]; // Installment 2 amount
        const installment2DueDate = rowData[30]; // Installment 2 due date
        const installment2Date = rowData[31]; // Installment 2 paid date
        const installment3Amount = rowData[32]; // Installment 3 amount
        const installment3DueDate = rowData[33]; // Installment 3 due date
        const installment3Date = rowData[34]; // Installment 3 paid date
        const installment4Amount = rowData[35]; // Installment 4 amount
        const installment4DueDate = rowData[36]; // Installment 4 due date
        const installment4Date = rowData[37]; // Installment 4 paid date
        const installment5Amount = rowData[38]; // Installment 5 amount
        const installment5DueDate = rowData[39]; // Installment 5 due date
        const installment5Date = rowData[40]; // Installment 5 paid date
        const installment6Amount = rowData[41]; // Installment 6 amount
        const installment6DueDate = rowData[42]; // Installment 6 due date
        const installment6Date = rowData[43]; // Installment 6 paid date
        const id = rowData[46]; // First column (ID)

        // Strip HTML tags
        const plainText = projectScope.replace(/<[^>]*>/g, '');

        $('#updateCompletionStatus option[value="ph"]').text(completionStatus);

        // Debug: Check what values you're getting
        console.log('Row data:', {
            id, clientName, projectName, adminName, 
            completionStatus, installment1Amount, 
            installment1DueDate
        });
        
        // Set values in the modal
        $('#updateProjectId').val(id);
        $('#updateClientName').val(clientName);
        $('#updateProjectName').val(projectName);
        $('#updateAdminName').val(adminName);
        $('#updateTotalContractAmount').val(totalcontractamount);
        $('#updateMonthsToPay').val(monthstopay);
        $('#updateProjectScope').val(plainText);
        $('#updateCompletionStatus').val(completionStatus);
        $('#updateDepositPaid').val(depositorbullet);
        $('#updateDatePaid').val(datedepositorbullet);
        $('#updateInstallment1Amount').val(installment1Amount);
        $('#updateInstallment1DueDate').val(installment1DueDate);
        $('#updateInstallment1Date').val(installment1Date);
        $('#updateInstallment2Amount').val(installment2Amount);
        $('#updateInstallment2DueDate').val(installment2DueDate);
        $('#updateInstallment2Date').val(installment2Date);
        $('#updateInstallment3Amount').val(installment3Amount);
        $('#updateInstallment3DueDate').val(installment3DueDate);
        $('#updateInstallment3Date').val(installment3Date);
        $('#updateInstallment4Amount').val(installment4Amount);
        $('#updateInstallment4DueDate').val(installment4DueDate);
        $('#updateInstallment4Date').val(installment4Date);        
        $('#updateInstallment5Amount').val(installment5Amount);
        $('#updateInstallment5DueDate').val(installment5DueDate);
        $('#updateInstallment5Date').val(installment5Date);        
        $('#updateInstallment6Amount').val(installment6Amount);
        $('#updateInstallment6DueDate').val(installment6DueDate);
        $('#updateInstallment6Date').val(installment6Date);
        
        // Show the modal
        $('#updateModal').modal('show');
    });
    
    // Rest of your save handler...
});
</script>

<script>

function handleDownloadClick(button) {
    const originalText = button.textContent;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Downloading...';
    button.disabled = true;

    // Trigger download
    const downloadUrl = button.dataset.url; // e.g., /download_contract/123
    window.location.href = downloadUrl;

    // Fallback: remove spinner after 3 seconds (UI only)
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 3000);
}


</script>

<script>
document.getElementById("saveAdminBtn").addEventListener("click", function () {

    const name = document.getElementById("adminName").value.trim();
    const phone = document.getElementById("adminPhone").value.trim();

    if (!name || !phone) {
        alert("Please fill in all fields");
        return;
    }

    // Show loader + disable button
    document.getElementById("saveText").classList.add("d-none");
    document.getElementById("saveLoader").classList.remove("d-none");
    document.getElementById("saveAdminBtn").disabled = true;

    fetch("/addadmin", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            adminName: name,
            adminPhone: phone
        })
    })
    .then(response => response.json())
    .then(data => {

        // Hide loader, restore button
        document.getElementById("saveText").classList.remove("d-none");
        document.getElementById("saveLoader").classList.add("d-none");
        document.getElementById("saveAdminBtn").disabled = false;

        if (data.status === "success") {

            alert("Administrator added!");

            const modal = bootstrap.Modal.getInstance(document.getElementById("addAdminplusModal"));
            modal.hide();

            location.reload();

        } else {
            alert("Error: " + data.message);
        }

    })
    .catch(error => {

        // Hide loader, restore button if an error occurs
        document.getElementById("saveText").classList.remove("d-none");
        document.getElementById("saveLoader").classList.add("d-none");
        document.getElementById("saveAdminBtn").disabled = false;

        alert("Request failed: " + error);
    });
});
</script>


<script>
document.getElementById("saveProjectBtn").addEventListener("click", function () {

    // ----------------------------------------------------
    // 1. Perform your custom checks before submitting
    // ----------------------------------------------------

    const clientName = document.getElementById("client_name").value.trim();
    const clientID = document.getElementById("client_national_id").value.trim();
    const clientWHATSAPP = document.getElementById("client_whatsapp_number").value.trim();
    const projectName = document.getElementById("project_name").value.trim();
    const paymentMethod = document.getElementById("paymentMethod").value;
    const projectadmin = document.getElementById("projectadministrator").value.trim();
    // When submitting form, store Quill HTML into hidden input
// Insert Quill content into hidden input BEFORE building formData


    if (clientName === "" || clientID === "" || clientWHATSAPP === "") {
        alert("All client details are required, kindly provide them to save the project.");
        return; // STOP submission
    }

    if (clientName === "" || clientID === "" || clientWHATSAPP === "") {
        alert("All project details are required, kindly provide them to save the project.");
        return; // STOP submission
    }

    if (paymentMethod === "") {
        alert("Select a payment method.");
        return; // STOP submission
    }

    // Example additional logic:
    if (paymentMethod === "Installments") {
        let months = document.getElementById("monthstopay").value;
        if (months === "" || months <= 0) {
            alert("Months To Pay must be greater than 0.");
            return;
        }
    }
    
    document.getElementById("project_description").value = quillProjectScope.root.innerHTML;

    // ----------------------------------------------------
    // 2. Build FormData object and send to Flask route
    // ----------------------------------------------------
    let form = document.getElementById("addProjectForm");
    let formData = new FormData(form);
    document.getElementById("edsLoader").style.display = "flex";

    fetch("/contract_log", {
        method: "POST",
        body: formData
    })
    .then(async response => {

        // If server returned JSON error 
        if (!response.ok) {
            let errorText = await response.text();
            console.error("Server error:", errorText);
            alert(" Failed to save: " + errorText);
            document.getElementById("edsLoader").style.display = "none";
            throw new Error("Server returned an error");
        }

        // If Flask redirected normally = success
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }

        return response.text();
    })
    .then(data => {
        console.log("Server response:", data);
        alert(" Project saved successfully!");
        document.getElementById("edsLoader").style.display = "none";
    })
    .catch(error => {
        console.error("Error:", error);
        alert(" There was an error saving the project.");
        document.getElementById("edsLoader").style.display = "none";
    });


});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('view-project-btn')) {

            const projectId = e.target.getAttribute('data-id');

            // Fetch project details from backend
            fetch(`/get_project/${projectId}`)
            .then(response => response.json())
            .then(data => {

                // Define the exact order you want
                const fieldOrder = [
                    "id",
                    "datecaptured",
                    "capturer",
                    "capturerid",
                    "clientname",
                    "clientidnumber",
                    "clientaddress",
                    "clientwanumber",
                    "clientemail",
                    "clientnextofkinname",
                    "clientnextofkinaddress",
                    "clientnextofkinphone",
                    "nextofkinrelationship",
                    "projectname",
                    "projectlocation",
                    "projectdescription",
                    "projectadministratorname",
                    "projectstartdate",
                    "projectduration",
                    "contractagreementdate",
                    "totalcontractamount",
                    "latepaymentinterest",
                    "paymentmethod",
                    "monthstopay",
                    "depositorbullet",
                    "datedepositorbullet",
                    "monthlyinstallment",
                    "installment1amount",
                    "installment1duedate",
                    "installment1date",
                    "installment2amount",
                    "installment2duedate",
                    "installment2date",
                    "installment3amount",
                    "installment3duedate",
                    "installment3date",
                    "installment4amount",
                    "installment4duedate",
                    "installment4date",
                    "installment5amount",
                    "installment5duedate",
                    "installment5date",
                    "installment6amount",
                    "installment6duedate",
                    "installment6date",
                    "projectcompletionstatus"
                ];

                // Get the table body
                const tbody = document.getElementById('projectDetailsBody');
                tbody.innerHTML = ''; // Clear old data

                // Build rows in the exact order defined above
                fieldOrder.forEach(key => {
                    if (data[key] !== undefined) {

                        const row = document.createElement('tr');

                        row.innerHTML = `
                            <th style="width: 30%; text-transform: capitalize;">
                                ${key.replace(/_/g, ' ')}
                            </th>
                            <td>${data[key] === null ? "" : data[key]}</td>
                        `;

                        tbody.appendChild(row);
                    }
                });

            })
            .catch(err => {
                alert('Failed to fetch project details: ' + err);
            });

        }
    });


        // Delegate click events for dynamically generated buttons
    document.querySelector('#alladminsTable').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-admin-btn')) {
            const adminId = e.target.getAttribute('data-ID');

            if (!confirm("Are you sure you want to remove this administrator?")) {
                return;
            }

            fetch('/removeadmin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: adminId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Administrator removed!');
                    // Optionally remove the row from table
                    e.target.closest('tr').remove();
                    location.reload();

                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Request failed: ' + error);
            });
        }
    });

 
});





</script>

<script>
    const paymentMethod = document.getElementById('paymentMethod');
    const paymentSchedule = document.getElementById('paymentschedule');
    const bulletpaymentdate = document.getElementById('bullet_payment_date');
    const depositRequired = document.getElementById('deposit_required');
    const totalContractPrice = document.getElementById('total_contract_price');

    paymentMethod.addEventListener('change', function() {
        if (this.value === 'Installments') {
            paymentSchedule.style.display = 'block';
            bulletpaymentdate.style.display = 'none';

            const total = parseFloat(totalContractPrice.value);
            if (!isNaN(total)) {
                depositRequired.value = (total * 0.3).toFixed(2);
            } else {
                depositRequired.value = '';
            }

        } else {
            paymentSchedule.style.display = 'none';
            bulletpaymentdate.style.display = 'block';
        }
    });


</script>

<script>

$(document).ready(function () {

    $('#saveaccumulators').click(function () {
        let updates = [];
        const companyname = $('#company_name').val().trim();  // Get the company name from the hidden input

        // Check if company name is empty
        if (!companyname) {
            alert("Company name is required.");
            return;  // Prevent further execution if company name is missing
        }

        // Gather data from the table
        $('#employeesaccumulatorsTable .editable-field').each(function () {
            let $field = $(this);
            let id = $field.data('id'); // Employee ID
            let newValue = parseFloat($field.val()); // New value entered

            // Check if the ID and value are valid before adding to updates
            if (id && !isNaN(newValue)) {
                updates.push({ id: id, accumulated_days: newValue });
            } else {
                console.error("Invalid data-id or value for field:", $field);
            }
        });

        // Check if updates array is empty (no valid data to send)
        if (updates.length === 0) {
            alert("No valid data to update.");
            return;  // Prevent sending the request if no valid data
        }
        $('#edsLoader').show();  // Show loading overlay immediately

        // Send updates to the server
        $.ajax({
            url: '/update_accumulators',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ updates: updates, companyname: companyname }),
            success: function (response) {

                $('#editLeaveDaysAccumulatorModal').modal('hide');  // Hide the modal after success
                $('#edsLoader').hide();  // Show loading overlay immediately
                setTimeout(function() {
                    alert(response.message);  // Show alert after the overlay
                }, 100);  // 100ms delay to ensure UI update before alert
                location.reload();  // Reload the table to reflect changes
            },
            error: function () {
                alert('Error updating Accumulators.');
            }
        });
    });
});



$('#btn-dashboard').click(function() {
        $('#dashboard-tab').tab('show');
    });

$('#btn-leave-apps-portal').click(function() {
    $('#projects-tab').tab('show');
});

$('#closepriv').on('click', function() {
    $('#editModalpriv').modal('hide'); 
});

$('#closeapprover').on('click', function() {
    $('#editModalapprover').modal('hide'); 
});

$('#closeaccumulators').on('click', function() {
    $('#editLeaveDaysAccumulatorModal').modal('hide'); 
});

$('#cancel_add_emplyee_manual').on('click', function() {
    $('#manualaddemployeeModal').modal('hide'); 
});



$('#savedepartmentconfirm').on('click', function() {
    var newdepartment = $('#department-emp').val();  // Get the selected role
    var companyname = $('#company_name').val();  // Get the company name from the hidden input

    if (!newdepartment || !companyname) {
        alert("Please fill in all required fields.");
        return;  // Prevent further execution if fields are empty
    }

    $('#edsLoader').show();

    
    if (newdepartment) {
        // Send the data to the Flask endpoint
        $.ajax({
            url: '/update_department',  // Change to your desired endpoint
            method: 'POST',
            data: {
                department: newdepartment,
                currentId: currentIdeditdepartment,  // Include the currentId in the request
                companyname: companyname  // Include the company_name in the request
            },
            success: function(response) {
                // Handle the response from Flask (e.g., show success message or refresh data)
                $('#editModaldepartment').modal('hide');  // Hide the modal after success
                $('#edsLoader').hide();

                setTimeout(function() {
                    alert('Department updated successfully.');
                }, 100);  // 100ms delay to ensure UI update before alert
                location.reload();  
            },
            error: function(xhr, status, error) {
                // Handle any errors (e.g., alert user)
                alert('Error: ' + error);
            }
        });
    } else {
        // If no role is selected
        alert("Please select a department before saving.");
    }
});


async function downloadLeaveApp(appId) {
    const btn = document.querySelector(`button[data-id="${appId}"]`);
    const originalText = btn.innerHTML;
    // Find the <tr> where the button is located
    const row = btn.closest('tr');

    // Find the full name from the "Employee Name" column
    // You can improve this by assigning a class to that <td> (e.g., <td class="employee-name">)
    const nameCell = Array.from(row.cells).find(cell =>
        cell.textContent.trim() && !cell.querySelector('button') && isNaN(cell.textContent.trim())
    );

    const fullName = nameCell ? nameCell.textContent.trim() : 'Unknown_Name';
    
    try {
        // 1. Show loading state
        btn.disabled = true;
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Generating...';

        // 2. Fetch PDF
        const response = await fetch(`/download_leave_app/${appId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        // 3. Check content type (ensure it's PDF)
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/pdf')) {
            throw new Error('Invalid content type - expected PDF');
        }

        // 4. Create download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `leave_application_${fullName}_${appId}.pdf`;
        document.body.appendChild(a);
        a.click();

        // 5. Cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

    } catch (error) {
        console.error('Download failed:', error);
        btn.innerHTML = '<i class="fa fa-exclamation-circle"></i> Failed - Retry';
        // Optional: Show user-friendly alert
        alert(`Download failed: ${error.message}`);
    } finally {
        // 6. Reset button (even if success or error)
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}





document.addEventListener('DOMContentLoaded', () => {
    const modals = document.querySelectorAll('.modal');
    const mainContent = document.querySelector('body > *:not(.modal)'); // Select all content outside modals

    modals.forEach(modal => {
        modal.addEventListener('show.bs.modal', () => {
            // Add inert to main content when modal is open
            mainContent.setAttribute('inert', '');
        });

        modal.addEventListener('hidden.bs.modal', () => {
            // Remove inert from main content when modal is closed
            mainContent.removeAttribute('inert');
        });
    });



    document.getElementById('formatexcellmsbookexport').addEventListener('click', () => {
            window.location.href = '/export_lms_book_excel';
        });

    document.getElementById('formatpdflmsbookexport').addEventListener('click', () => {
        window.location.href = '/export_lms_book_pdf';
    });

  });




  </script>
<script>
    $(document).ready(function () {

        $('#alladminsTable').DataTable({
            paging: true,    // Enable pagination
            searching: true, // Enable search
            ordering: true,  // Enable sorting
            info: true,      // Show table information
            pageLength: 8,       // Force max 5 entries per page
            lengthChange: false, // Disable entries per page dropdown
        });



        $('#allenquiriesTable').DataTable({
            paging: false,    // Enable pagination
            searching: true, // Enable search
            ordering: true,  // Enable sorting
            info: true,      // Show table information
            pageLength: 8,       // Force max 5 entries per page
            lengthChange: false, // Disable entries per page dropdown
        });

    });








</script>



</body>
</html>
